try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(e$$8){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(h,v,r,m,o){function q(a,b){if("object"!==typeof a)return g("enumerator validation failed, invalid type base object."),o;if(b===o)return o;if("number"===typeof b)return b;if("string"===typeof b){var l=parseInt(b,10);if(""!==b&&isFinite(l))return l;l=b.toUpperCase();l=a[l];if(l!==o)return l;g("enumerator validation failed, unknown enum value: "+b);var l="",e;for(e in a)a.hasOwnProperty(e)&&(""!==l&&(l+=", "),l+=e.toLowerCase());g("possible enum values are: "+l)}return o}var d="";try{for(var f=
v.querySelectorAll("script"),e=0,c=f.length;e<c;e++){var n=f[e].src.lastIndexOf("/CubicVR.js");-1<n&&(d=f[e].src.substr(0,n)+"/")}}catch(a){}var b=h.CubicVR={};b.contexts={};var g;try{g=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(l){g=m}var u={quality:{LOW:0,MEDIUM:1,HIGH:2}};h.cubicvr=u;var E={},x=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=function(a){function l(a,b,g){var e=function(){};e.prototype=a.prototype;b.prototype=new e;for(var c in g)b.prototype[c]=
g[c];return b}function e(){var a=v.createElement("menu");a.setAttribute("type","context");var b=v.createElement("menuitem");b.setAttribute("label","Enter full-screen");b.setAttribute("onclick","CubicVR.setFullScreen()");a.id="fullScreenMenu";a.appendChild(b);v.body.appendChild(a);y.canvas.setAttribute("contextmenu","fullScreenMenu")}function c(){}function n(a){(v.fullScreenEnabled||!1===a)&&v.cancelFullScreen();!1!==a&&(a===o&&(a=b.getCanvas()),a.onwebkitfullscreenchange=c,a.onmozfullscreenchange=
c,a.onfullscreenchange=c,a.webkitEnterFullScreen?a.webkitEnterFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.requestFullscreen())}var f=this,s;a&&(s=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return s}}));f.undef=o;f.nop=m;f.scriptLocation=d;f.GLCore=y;f.Textures=[];f.Textures_obj=[];f.Textures_ref=[];f.Images=[];f.ShaderPool=[];f.log=g;f.enums=b.enums;f.MAX_LIGHTS=6;f.extendClassGeneral=l;f.extendClass=function(a,b,g){return l(a,function(){a.apply(this);
b.apply(this,arguments)},g)};f.features={};f.quality=b.enums.HIGH;var C={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},D={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},F={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};f.features=F;var y={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,
shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1,init:function(a,l,g){var c,n=f.util,u=b.enums;if(l&&g){l=n.getScriptContents(l);g=n.getScriptContents(g)}else if(h.CubicVRShader.CubicVRCoreVS&&h.CubicVRShader.CubicVRCoreFS){l=h.CubicVRShader.CubicVRCoreVS;g=h.CubicVRShader.CubicVRCoreFS}else{l=n.getScriptContents(d+"CubicVR_Core.vs");g=n.getScriptContents(d+"CubicVR_Core.fs")}if(a===
o){a=v.createElement("canvas");a.style.background="black";if(!c)try{c=a.getContext("experimental-webgl",{antialias:f.features.antiAlias})}catch(s){return null}y.gl=c;if(y.fixed_size!==null){y.width=y.fixed_size[0];y.height=y.fixed_size[1];y.resizeElement(a,y.width,y.height)}else{y.addResizeable(a);if(y.canvasSizeFactor!==1&&a.getContext!==o){var n=r.round(h.innerWidth*y.canvasSizeFactor),x=r.round(h.innerHeight*y.canvasSizeFactor);y.resizeElement(a,n,x);a.style.top=h.innerHeight/2-x/2+"px";a.style.left=
h.innerWidth/2-n/2+"px";a.style.position="absolute"}else y.resizeElement(a,h.innerWidth,h.innerHeight)}v.body.appendChild(a)}if(a.getContext!==o&&a.width!==o&&a.height!==o){try{c||(c=a.getContext("experimental-webgl",{antialias:f.features.antiAlias}));c.viewport(0,0,a.width,a.height);y.canvas=a;y.width=a.width;y.height=a.height;c.clearColor(0,0,0,1);c.clearDepth(1);c.enable(c.DEPTH_TEST);c.depthFunc(c.LEQUAL)}catch(E){}if(!c)return null}else c=a;y.gl=c;y.CoreShader_vs=l;y.CoreShader_fs=g;y.viewportWidth=
y.width;y.viewportHeight=y.height;y.gl._viewport=y.gl.viewport;c.viewport=function(a){return function(b,l,g,c){a.viewportWidth=g;a.viewportHeight=c;a.gl._viewport(b,l,g,c)}}(y);c.enable(c.CULL_FACE);c.cullFace(c.BACK);c.frontFace(c.CCW);for(a=b.enums.light.type.NULL;a<u.light.type.MAX;a++)f.ShaderPool[a]=[];new f.Texture;a=y.emptyLight=new f.Light(u.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;for(a=u.light.type.NULL;a<u.light.type.MAX;a++)f.ShaderPool[a]=
[];if(y.resizeList.length){h.addEventListener("resize",function(){f.GLCore.onResize()},false);y.resize_active=true}e();return c},addResizeable:function(a){f.GLCore.resizeList.push(a)},onResize:function(){var a=h.innerWidth,b=h.innerHeight;if(y.fixed_size!==null){a=f.GLCore.fixed_size[0];b=f.GLCore.fixed_size[1]}for(var l=0,g=f.GLCore.resizeList.length;l<g;l++)y.resizeElement(f.GLCore.resizeList[l],a,b)},setFixedAspect:function(a){f.GLCore.fixed_aspect=a},setFixedSize:function(a,b){f.GLCore.fixed_size=
[a,b]},getCanvas:function(){return f.GLCore.canvas},resizeElement:function(a,b,l){var g=y.gl;if(y.fixed_aspect!==0){var c=b*(1/f.GLCore.fixed_aspect);if(c>l){c=l;b=l*f.GLCore.fixed_aspect}l=c}if(a.getContext!==o){a.width=b;a.height=l;if(!f.GLCore.fixed_size){a.style.left=(h.innerWidth/2-b/2|0)+"px";a.style.top=(h.innerHeight/2-l/2|0)+"px";a.style.position="absolute"}g.viewport(0,0,b,l)}else a.resize(b,l)},setDepthAlpha:function(a,b,l){y.depth_alpha=a;y.depth_alpha_near=b;y.depth_alpha_far=l},setDefaultFilter:function(a){y.default_filter=
q(f.enums.texture.filter,a)},setSoftShadows:function(a){y.soft_shadow=a},setFog:function(a){y.fog_enabled=a},setFogExp:function(a,b){y.fog_enabled=true;y.fogLinear=false;y.fogExp=true;y.fogColor=a;y.fogDensity=b},setNoise:function(a){y.fogNoise=a},setFogLinear:function(a,b,l){y.fog_enabled=true;y.fogExp=false;y.fogLinear=true;y.fogColor=a;y.fogNear=b;y.fogFar=l},setCanvasSizeFactor:function(a){y.canvasSizeFactor=a},setQuality:function(a){a=q(u.quality,a);if(a===u.quality.HIGH)f.features=F;else if(a===
u.quality.MEDIUM)f.features=D;else if(a===u.quality.LOW)f.features=C;f.quality=a;return f.features},getQuality:function(){return f.features}},I=function(a,b,l){for(var g,c=v.getElementsByTagName("script"),n=0;n<c.length;++n){var u=c[n];if(u.getAttribute("data-cubicvr")){var d=u.getAttribute("src");if(d){var s=new XMLHttpRequest;s.open("GET",d,false);s.send(null);if(s.status===200||s.status===0)u.text=s.responseText}}}if(typeof a==="object"){a.quality&&y.setQuality(a.quality);if(a.getContext)g=a;else{g=
a.canvas;b=a.vertexShader||b;l=a.fragmentShader||l}}else if(a){a[0]=="#"&&(a=a.substr(1));g=v.getElementById(a)}for(var x in E){var a=E[x](f),m;for(m in a)a.hasOwnProperty(m)&&(f[m]=a[m])}y.init(g,b,l);e();return y.gl};f.GLCore=y;f.setFullScreen=n;f.init=I;f.start=function(a,b,l,g,c){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=o);l=l||"Sorry, your browser does not appear to support WebGL :-(";if(a=I(a,g,c)){b&&typeof b==="function"&&b(a,f.getCanvas());return a}if(!a){l&&typeof l==="function"?
l():alert(l);return false}};f.addResizeable=y.addResizeable;f.setFixedAspect=y.setFixedAspect;f.setFixedSize=y.setFixedSize;f.setCanvasSizeFactor=y.setCanvasSizeFactor;f.getCanvas=y.getCanvas;f.enums=u;f.IdentityMatrix=x;f.Textures=f.Textures;f.Textures_obj=f.Textures_obj;f.Images=f.Images;f.globalAmbient=[0.1,0.1,0.1];f.setGlobalAmbient=function(a){f.globalAmbient=a};f.setGlobalDepthAlpha=y.setDepthAlpha;f.setDefaultFilter=y.setDefaultFilter;f.setSoftShadows=y.setSoftShadows;f.setQuality=y.setQuality;
f.getQuality=y.getQuality;f.RegisterModule=b.RegisterModule;f.getScriptLocation=b.getScriptLocation;f.setFogExp=y.setFogExp;f.setFogLinear=y.setFogLinear;f.setFogNoise=y.setFogNoise;f.parseEnum=q;f.setFullScreen=n};b.init=function(a,l,g){var c;a&&(a.context&&"string"===typeof a.context)&&(c=a.context);c=new s(c);if(c.context)return b.contexts[c.context]=c,c.init(a,l,g),c;h.CubicVR=b=c;c.init(a,l,g);return c.GLCore.gl};b.start=function(a,l,g,c,e){var n=new s;h.CubicVR=b=n;n.start(a,l,g,c,e);return n};
b.RegisterModule=function(a,b){E[a]=b};b.getScriptLocation=function(){return d};b.enums=u})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(h){function v(a){return this.clearStack(a)}function r(){1===arguments.length&&(this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3]);4===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3])}function m(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var o=h.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],d=Math.PI/2,f=h.enums;f.aabb=
{DISJOINT:0,A_INSIDE_B:1,B_INSIDE_A:2,INTERSECT:3};f.frustum_plane={LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5};var e={length:function(a,b){var g,l,c;b===o?(g=a[0],l=a[1],c=a[2]):(g=b[0]-a[0],l=b[1]-a[1],c=b[2]-a[2]);return Math.sqrt(g*g+l*l+c*c)},normalize:function(a){var b=a[0],g=a[1],l=a[2];return(b=Math.sqrt(b*b+g*g+l*l))?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*
a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,g){g===o&&(g=1.0E-7);return a===o&&b===o?!0:a===o||b===o?!1:Math.abs(a[0]-b[0])<g&&Math.abs(a[1]-b[1])<g&&Math.abs(a[2]-b[2])<g},moveViewRelative:function(a,
b,g,l,c){var e=Math.atan2(l,g),b=Math.atan2(b[2]-a[2],b[0]-a[0]),g=Math.sqrt(g*g+l*l),e=b+e+d;return"object"===typeof c?[c[0]+g*Math.cos(e),c[1],c[2]+g*Math.sin(e)]:[a[0]+g*Math.cos(e),a[1],a[2]+g*Math.sin(e)]},trackTarget:function(a,b,g,l){var b=e.subtract(b,a),c=e.length(b),n;n=e.normalize(b);n=e.multiply(n,g*(1/(1/(c-l))));c>l?a=e.add(a,n):c<l?(n=e.normalize(b),n=e.multiply(n,g*(1/(1/Math.abs(c-l)))),a=e.subtract(a,n)):a=[a[0],a[1]+n[2],a[2]];return a},getClosestTo:function(a,b,g){b=e.subtract(b,
a);g=e.subtract(g,a);return e.add(e.multiply(b,e.dot(b,g)/e.dot(b,b)),a)},linePlaneIntersect:function(a,b,g,l){var c=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(l[0]-g[0])+a[1]*(l[1]-g[1])+a[2]*(l[2]-g[2]);if(0.0010>Math.abs(b))return!1;a=-(c+a[0]*g[0]+a[1]*g[1]+a[2]*g[2])/b;return[g[0]+a*(l[0]-g[0]),g[1]+a*(l[1]-g[1]),g[2]+a*(l[2]-g[2])]}},c={lookat:function(a,b,g,l,c,n,d,f,m){var o=[],q=[],r=[],q=[];o[0]=l-a;o[1]=c-b;o[2]=n-g;r[0]=d;r[1]=f;r[2]=m;o=e.normalize(o);q=e.cross(o,r);q=e.normalize(q);r=e.cross(q,
o);q=[q[0],r[0],-o[0],0,q[1],r[1],-o[1],0,q[2],r[2],-o[2],0,0,0,0,1];l=new h.Transform(q);l.translate([-a,-b,-g]);return l.getResult()},multiply:function(a,b,g){g===o&&(g=[]);g[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];g[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];g[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];g[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];g[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];g[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];g[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];g[7]=
a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];g[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];g[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];g[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];g[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];g[12]=a[0]*b[12]+a[4]*b[13]+a[8]*b[14]+a[12]*b[15];g[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];g[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];g[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return g},vec4_multiply:function(a,b,g){g===o&&(g=[]);g[0]=
b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];g[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];g[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];g[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return g},vec3_multiply:function(a,b,g){g===o&&(g=[]);g[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12];g[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];g[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return g},perspective:function(a,b,g,l){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(l+g)/(l-g),-1,0,0,-(2*l*g)/(l-g),0]},ortho:function(a,
b,g,l,c,e){return[2/(b-a),0,0,0,0,2/(l-g),0,0,0,0,-2/(e-c),0,-(a+b)/(b-a),-(l+g)/(l-g),-(e+c)/(e-c),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],
a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],g=a[0],l=a[1],c=a[2],e=a[4],n=a[5],d=a[6],f=a[8],m=a[9],a=a[10],o=a*n-d*m,h=-a*e+d*f,q=m*e-n*f,w=g*o+l*h+c*q;if(!w)return null;w=1/w;b[0]=o*w;b[1]=(-a*l+c*m)*w;b[2]=(d*l-c*n)*w;b[3]=h*w;b[4]=(a*g-c*f)*w;b[5]=(-d*g+c*e)*w;b[6]=q*w;b[7]=(-m*g+l*f)*w;b[8]=(n*g-l*e)*w;return b},inverse:function(a,b){var g=a[0]*a[5]-a[1]*a[4],l=a[0]*a[6]-a[2]*a[4],c=a[0]*a[7]-a[3]*a[4],e=a[1]*a[6]-a[2]*a[5],n=a[1]*a[7]-a[3]*a[5],d=a[2]*
a[7]-a[3]*a[6],f=a[8]*a[13]-a[9]*a[12],m=a[8]*a[14]-a[10]*a[12],h=a[8]*a[15]-a[11]*a[12],q=a[9]*a[14]-a[10]*a[13],t=a[9]*a[15]-a[11]*a[13],w=a[10]*a[15]-a[11]*a[14],r=g*w-l*t+c*q+e*h-n*m+d*f;return 0!==r?(b===o&&(b=[]),b[0]=0+a[5]*w-a[6]*t+a[7]*q,b[4]=0-a[4]*w+a[6]*h-a[7]*m,b[8]=0+a[4]*t-a[5]*h+a[7]*f,b[12]=0-a[4]*q+a[5]*m-a[6]*f,b[1]=0-a[1]*w+a[2]*t-a[3]*q,b[5]=0+a[0]*w-a[2]*h+a[3]*m,b[9]=0-a[0]*t+a[1]*h-a[3]*f,b[13]=0+a[0]*q-a[1]*m+a[2]*f,b[2]=0+a[13]*d-a[14]*n+a[15]*e,b[6]=0-a[12]*d+a[14]*c-a[15]*
l,b[10]=0+a[12]*n-a[13]*c+a[15]*g,b[14]=0-a[12]*e+a[13]*l-a[14]*g,b[3]=0-a[9]*d+a[10]*n-a[11]*e,b[7]=0+a[8]*d-a[10]*c+a[11]*l,b[11]=0-a[8]*n+a[9]*c-a[11]*g,b[15]=0+a[8]*e-a[9]*l+a[10]*g,g=1/r,b[0]*=g,b[1]*=g,b[2]*=g,b[3]*=g,b[4]*=g,b[5]*=g,b[6]*=g,b[7]*=g,b[8]*=g,b[9]*=g,b[10]*=g,b[11]*=g,b[12]*=g,b[13]*=g,b[14]*=g,b[15]*=g,b):null},identity:function(a){if(a==o)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=
0;a[14]=0;a[15]=1},translate:function(a,b,g,l){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,g,1];if(l===o)return a;c.multiply(l.slice(0),a,l)},rotateAxis:function(a,b,g,l,e){var n=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=[a+b*b*(1-a),b*g*(1-a)-l*n,b*l*(1-a)+g*n,0,g*b*(1-a)+l*n,a+g*g*(1-a),g*l*(1-a)-b*n,0,l*b*(1-a)-g*n,l*g*(1-a)+b*n,a+l*l*(1-a),0,0,0,0,1];if(e===o)return b;c.multiply(e.slice(0),b,e)},rotate:function(a,b,g,l){var e;l===o&&(l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==g&&(e=Math.sin(g*
(Math.PI/180)),g=Math.cos(g*(Math.PI/180)),c.multiply(l.slice(0),[g,e,0,0,-e,g,0,0,0,0,1,0,0,0,0,1],l));0!==b&&(e=Math.sin(b*(Math.PI/180)),g=Math.cos(b*(Math.PI/180)),c.multiply(l.slice(0),[g,0,-e,0,0,1,0,0,e,0,g,0,0,0,0,1],l));0!==a&&(e=Math.sin(a*(Math.PI/180)),g=Math.cos(a*(Math.PI/180)),c.multiply(l.slice(0),[1,0,0,0,0,g,e,0,0,-e,g,0,0,0,0,1],l));return l},scale:function(a,b,g,l){if(l===o)return[a,0,0,0,0,b,0,0,0,0,g,0,0,0,0,1];c.multiply(l.slice(0),[a,0,0,0,0,b,0,0,0,0,g,0,0,0,0,1],l)},transform:function(a,
b,g){var l=c.identity();a&&c.translate(a[0],a[1],a[2],l);b&&(0===b[0]&&0===b[1]&&0===b[2]||c.rotate(b[0],b[1],b[2],l));g&&(1===g[0]&&1===g[1]&&1===g[2]||c.scale(g[0],g[1],g[2],l));return l}};v.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=
h.mat4;if(!this.c_stack)return this.m_stack[0];var b=q;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var g=this.valid;g<this.c_stack+1;g++)b=a.multiply(b,this.m_stack[g]),this.m_cache[g]=b;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:q;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=
0;this.result=null;a!==o?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,g){var l=h.mat4;if("object"===typeof a)return this.translate(a[0],a[1],a[2]);var c=this.getIdentity();c[12]=a;c[13]=b;c[14]=g;this.m_stack[this.c_stack]=l.multiply(this.m_stack[this.c_stack],c);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,g){var l=h.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var c=this.getIdentity();c[0]=a;c[5]=b;c[10]=g;this.m_stack[this.c_stack]=
l.multiply(this.m_stack[this.c_stack],c);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,g,l){var c=h.mat4;if("object"===typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var e,n;if(b||g||l)e=Math.sin(-a*(Math.PI/180)),n=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=n*b,a[9]=e*b,a[6]=-e*b,a[10]=n*b,this.m_stack[this.c_stack]=c.multiply(a,this.m_stack[this.c_stack]));g&&(b=this.getIdentity(),b[0]=n*g,b[8]=
-e*g,b[2]=e*g,b[10]=n*g,this.m_stack[this.c_stack]=c.multiply(b,this.m_stack[this.c_stack]));l&&(g=this.getIdentity(),g[0]=n*l,g[4]=e*l,g[1]=-e*l,g[5]=n*l,this.m_stack[this.c_stack]=c.multiply(g,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};r.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=
1+a[0]+a[5]+a[10],g,l,c;1.0E-8<b?(g=2*Math.sqrt(b),b=(a[9]-a[6])/g,l=(a[2]-a[8])/g,c=(a[4]-a[1])/g,a=0.25*g):a[0]>a[5]&&a[0]>a[10]?(g=2*Math.sqrt(1+a[0]-a[5]-a[10]),b=0.25*g,l=(a[4]+a[1])/g,c=(a[2]+a[8])/g,a=(a[9]-a[6])/g):a[5]>a[10]?(g=2*Math.sqrt(1+a[5]-a[0]-a[10]),b=(a[4]+a[1])/g,l=0.25*g,c=(a[9]+a[6])/g,a=(a[2]-a[8])/g):(g=2*Math.sqrt(1+a[10]-a[0]-a[5]),b=(a[2]+a[8])/g,l=(a[9]+a[6])/g,c=0.25*g,a=(a[4]-a[1])/g);this.x=b;this.y=l;this.z=c;this.w=a},fromEuler:function(a,b,g){var l=Math.cos(Math.PI/
180*b/2),b=Math.sin(Math.PI/180*b/2),c=Math.cos(Math.PI/180*g/2),g=Math.sin(Math.PI/180*g/2),e=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),n=l*c,d=b*g;this.w=n*e-d*a;this.x=n*a+d*e;this.y=b*c*e+l*g*a;this.z=l*g*e-b*c*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,g=this.y*this.y,l=this.z*this.z,c=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-g+l+a),e=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-
g-l+a);return[c,e,a]},multiply:function(a,b){b===o&&(b=a,a=this);return new r(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};var n={classifyPoint:function(a,b){var g=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];return 0>g?-1:0<g?1:0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}};m.prototype.extract=function(a,b,g){var l=h.mat4,c=h.vec3;if(!(b===o||g===o)){l=l.multiply(g,
b);b=this._planes;b[f.frustum_plane.LEFT][0]=l[3]+l[0];b[f.frustum_plane.LEFT][1]=l[7]+l[4];b[f.frustum_plane.LEFT][2]=l[11]+l[8];b[f.frustum_plane.LEFT][3]=l[15]+l[12];b[f.frustum_plane.RIGHT][0]=l[3]-l[0];b[f.frustum_plane.RIGHT][1]=l[7]-l[4];b[f.frustum_plane.RIGHT][2]=l[11]-l[8];b[f.frustum_plane.RIGHT][3]=l[15]-l[12];b[f.frustum_plane.TOP][0]=l[3]-l[1];b[f.frustum_plane.TOP][1]=l[7]-l[5];b[f.frustum_plane.TOP][2]=l[11]-l[9];b[f.frustum_plane.TOP][3]=l[15]-l[13];b[f.frustum_plane.BOTTOM][0]=l[3]+
l[1];b[f.frustum_plane.BOTTOM][1]=l[7]+l[5];b[f.frustum_plane.BOTTOM][2]=l[11]+l[9];b[f.frustum_plane.BOTTOM][3]=l[15]+l[13];b[f.frustum_plane.NEAR][0]=l[3]+l[2];b[f.frustum_plane.NEAR][1]=l[7]+l[6];b[f.frustum_plane.NEAR][2]=l[11]+l[10];b[f.frustum_plane.NEAR][3]=l[15]+l[14];b[f.frustum_plane.FAR][0]=l[3]-l[2];b[f.frustum_plane.FAR][1]=l[7]-l[6];b[f.frustum_plane.FAR][2]=l[11]-l[10];b[f.frustum_plane.FAR][3]=l[15]-l[14];for(var e=0;6>e;++e)n.normalize(b[e]);e=-b[f.frustum_plane.NEAR][3];b=b[f.frustum_plane.FAR][3]-
e;g=b*(1/g[5]);g=c.subtract([0,0,e+0.5*b],[g,g,e+b]);g=c.length(g);l=[l[3],l[9],l[10]];e=c.length(l);l=c.multiply(l,1/e);a=[a.position[0],a.position[1],a.position[2]];a=c.add(a,c.multiply(l,0.5*b));a=c.add(a,c.multiply(l,1));this.sphere=[a[0],a[1],a[2],g]}};m.prototype.contains_sphere=function(a){for(var b=h.vec3,g=this._planes,l=0;6>l;++l){var c=g[l],c=b.dot([c[0],c[1],c[2]],[a[0],a[1],a[2]])+c.d;this.last_in[l]=1;if(c<-a[3])return-1;if(Math.abs(c)<a[3])return 0}return 1};m.prototype.draw_on_map=
function(a,b){var g=a.width/2,l=a.height/2;b.save();for(var c=this._planes,e=[0,1,4,5],n=0,d=e.length;n<d;++n){var f=c[e[n]];b.strokeStyle="#FF00FF";n<this.last_in.length&&this.last_in[n]&&(b.strokeStyle="#FFFF00");var m=-g,o=g,h=(-f[3]-f[0]*o)/f[2];b.moveTo(g+m,l+(-f[3]-f[0]*m)/f[2]);b.lineTo(g+o,l+h);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(g+this.sphere[0],l+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);b.closePath();b.stroke();b.restore()};m.prototype.contains_box=function(a){var b=
0,g=[];g[0]=a[0];g[1]=[a[0][0],a[0][1],a[1][2]];g[2]=[a[0][0],a[1][1],a[0][2]];g[3]=[a[0][0],a[1][1],a[1][2]];g[4]=[a[1][0],a[0][1],a[0][2]];g[5]=[a[1][0],a[0][1],a[1][2]];g[6]=[a[1][0],a[1][1],a[0][2]];g[7]=a[1];for(var a=this._planes,l=0;6>l;++l){for(var c=8,e=1,n=0;8>n;++n)-1===Plane.classifyPoint(a[l],g[n])&&(e=0,--c);this.last_in[l]=e;if(0===c)return-1;b+=e}return 6===b?1:0};return{vec2:{equal:function(a,b,g){g===o&&(g=1.0E-8);return a===o&&b===o?!0:a===o||b===o?!1:Math.abs(a[0]-b[0])<g&&Math.abs(a[1]-
b[1])<g},onLine:function(a,b,g){var l=a[1]<b[1]?a[1]:b[1],c=a[0]>b[0]?a[0]:b[0],e=a[1]>b[1]?a[1]:b[1];return(a[0]<b[0]?a[0]:b[0])<=g[0]&&g[0]<=c&&l<=g[1]&&g[1]<=e?!0:!1},lineIntersect:function(a,b,g,l){var c=a[0],a=a[1],e=b[0],b=b[1],n=g[0],g=g[1],d=l[0],l=l[1],f=(c-e)*(g-l)-(a-b)*(n-d);return 0===f?!1:[((n-d)*(c*b-a*e)-(c-e)*(n*l-g*d))/f,((g-l)*(c*b-a*e)-(a-b)*(n*l-g*d))/f]},add:function(a,b){return[a[0]+b[0],a[1]+b[1]]},subtract:function(a,b){return[a[0]-b[0],a[1]-b[1]]},length:function(a,b){if(b===
o)return Math.sqrt(a[0]*a[0]+a[1]*a[1]);var g=[a[0]-b[0],a[1]-b[1]];return Math.sqrt(g[0]*g[0]+g[1]*g[1])}},vec3:e,mat3:{transpose_inline:function(a){var b=a[1],g=a[2],l=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=g;a[7]=l},vec3_multiply:function(a,b,g){g===o&&(g=[]);g[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];g[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];g[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return g}},mat4:c,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=
b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){void 0===b&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]},intersects:function(a,b){return a[0][0]>b[1][0]||a[1][0]<b[0][0]||a[0][1]>b[1][1]||a[1][1]<b[0][1]||a[0][2]>b[1][2]||
a[1][2]<b[0][2]?f.aabb.DISJOINT:a[0][0]>=b[0][0]&&a[1][0]<=b[1][0]&&a[0][1]>=b[0][1]&&a[1][1]<=b[1][1]&&a[0][2]>=b[0][2]&&a[1][2]<=b[1][2]?f.aabb.A_INSIDE_B:b[0][0]>=a[0][0]&&b[1][0]<=a[1][0]&&b[0][1]>=a[0][1]&&b[1][1]<=a[1][1]&&b[0][2]>=a[0][2]&&b[1][2]<=a[1][2]?f.aabb.B_INSIDE_A:f.aabb.INTERSECT}},plane:n,sphere:{intersects:function(a,b){var g=h.vec3.subtract([a[0],a[1],a[2]],[b[0],b[1],b[2]]),g=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),l=a[3]+b[3];return g*g<l*l?!0:!1}},triangle:{normal:function(a,
b,g,l){l===o&&(l=[]);var c=a[0]-b[0],e=a[1]-b[1],a=a[2]-b[2],n=b[0]-g[0],d=b[1]-g[1],b=b[2]-g[2];l[0]=e*b-a*d;l[1]=a*n-c*b;l[2]=c*d-e*n;return l}},Transform:v,Quaternion:r,Frustum:m}});
CubicVR.RegisterModule("Utility",function(h){var v=h.undef,r=h.log,m={},o={},q={multiSplit:function(d,f){for(var e=d.split(f[0]),c=1,n=f.length;c<n;c++)for(var a=f[c],b=0,g=e.length;b<g;b++){var l=e[b].trim().split(a),u=!0;if(1<l.length)for(var m=0;m<l.length;m++)""!==l[m].trim()&&(e.splice(b+m,0===m?1:0,l[m]),m&&g++,u=!1);else e[b]=e[b].trim().replace(a,""),""!==e[b]&&(u=!1);u&&(e.splice(b,1),g--,b--)}return e},getJSONScriptObj:function(d,f){if("string"===typeof d&&0<d.length&&"#"===d.charAt(0)){var e=
document.getElementById(d.substr(1));if(e)return e=JSON.parse(e.innerHTML||e.text),f&&f(e),e}return d},getScriptContents:function(d){var f=document.getElementById(d),e="",c="";if(f){if(""!==f.src||f.attributes.srcUrl!==v)c=""!==f.src?f.src:f.attributes.srcUrl.value}else c=d;if(0!==c.length){if(d=new XMLHttpRequest,d.overrideMimeType&&d.overrideMimeType("application/json"),d.open("GET",c,!1),d.send(null),200===d.status||0===d.status)e=d.responseText}else for(c=f.firstChild;c;)3===c.nodeType&&(e+=c.textContent),
c=c.nextSibling;return e},xmlNeedsBadgerFish:function(d){for(d=[d];d.length;){var f=d.pop();if(f.attributes&&f.attributes.length)return!0;for(var e=0,c=f.childNodes.length;e<c;e++)d.push(f.childNodes[e])}return!1},getFirstEntry:function(d){for(var f in d)if(d.hasOwnProperty(f))return d[f]},getURIFileType:function(d){function f(a){for(var b in n)if(n.hasOwnProperty(b)&&-1!==n[b].indexOf(a))return b;return v}var e=d.toLowerCase(),c=["_ext","ext"],n={json:["js","javascript","json"],xml:["xml"]};if(-1!==
e.indexOf("?")){var a=e.split("?"),e=a[0];if(a[1])for(var a=-1===a[1].indexOf("&")?[a[1]]:a[1].split("&"),b=0,g=a.length;b<g;b++){var l=a[b];if(-1!==l.indexOf("=")&&(l=l.split("="),-1!==c.indexOf(l[0]))){var u=f(l[1]);if(u)return u;r("Unable to determine extension type '"+l[1]+"' provided for URI: ["+d+"], falling back to filename part.")}}}return-1!==e.indexOf(".")?(d=e.split("."),f(d[d.length-1])):v},get:function(d,f){var e=null,c=null,n=null,f=f||null;if(d===v)return v;if(isFinite(d))return d;
"function"===typeof d&&(d=d(f));if("object"===typeof d)return f&&!(d instanceof f)?new f(d):d;if("string"==typeof d){if(-1!==d.indexOf("\n"))return d;"#"==d[0]&&(e=d.substr(1),(n=document.getElementById(e))&&(c=n.src||null));!n&&(!e&&!c&&d)&&(c=d)}if(n&&!c)return CubicVR.util.collectTextNode(n);if(c){var e=null,a=o[c]||null;if(!a){var b=q.getURIFileType(c);if(b===v&&!n)return c;"json"===b?a=CubicVR.util.getJSON(c):e="xml"===b?CubicVR.util.getXML(c):CubicVR.util.getURL(c);e&&e.childNodes?a=q.getFirstEntry(q.xml2json(e)):
e&&(a=e)}a&&o[c]===v&&(o[c]=a);if(f){if(m[c]&&m[c]instanceof f)return m[c];if(a)return m[c]=new f(a),m[c]}else if(a)return a;return c}e&&!n&&console.log("Unable to retrieve requested ID: '"+d+"'");return v},clearCache:function(){m={};o={}},getURL:function(d){try{var f=new XMLHttpRequest;f.open("GET",d,!1);f.send(null);if(200===f.status||0===f.status){if(f.responseText.length)return f.responseText;if(f.responseXML)return f.responseXML}}catch(e){alert(d+" failed to load.")}return null},getXML:function(d){try{var f=
new XMLHttpRequest;f.open("GET",d,!1);f.overrideMimeType("application/xml");f.send(null);if(200===f.status||0===f.status)return f.responseXML}catch(e){try{alert(d+" failed to load.")}catch(c){throw e;}}return null},getJSON:function(d){try{var f=new XMLHttpRequest;f.open("GET",d,!1);f.overrideMimeType("application/json");f.send(null);if(200===f.status||0===f.status)return eval("("+f.responseText+")")}catch(e){try{alert(d+" failed to load.")}catch(c){throw e;}}return null},repackArray:function(d,f,
e){d.length!==parseInt(f,10)*parseInt(e,10)&&r("array repack error, data size !== stride*count: data.length="+d.length+" stride="+f+" count="+e);for(var e=[],c=0,n=0,a=d.length;n<a;n++){var b=n%f;0===b&&(e[c]=[]);e[c][b]=d[n];b===f-1&&c++}return e},collectTextNode:function(d){if(!d)return"";for(var f="",d=d.childNodes,e=0,c=d.length;e<c;e++)f+=d[e].nodeValue;return f},floatDelimArray:function(d,f){"\n"!=f&&(d=d.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var e=d.split(f?f:","),c=0,n=e.length;c<
n;c++)e[c]=parseFloat(e[c]);e[e.length-1]!==e[e.length-1]&&e.pop();return e},intDelimArray:function(d,f){"\n"!=f&&(d=d.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var e=d.split(f?f:","),c=0,n=e.length;c<n;c++)e[c]=parseInt(e[c],10);e[e.length-1]!==e[e.length-1]&&e.pop();return e},textDelimArray:function(d,f){"\n"!=f&&(d=d.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var e=d.split(f?f:","),c=0,n=e.length;c<n;c++)e[c]=e[c];return e},xmlstring2json:function(d){for(var d=d.replace(/<\!--.*?--\>/gm,
"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),f=/^\s+$/gm,e,c=[],n=[],a={},b=a,g=0,l=d.length;g<l;g++){var u=d[g];if(!(f.test(u)||""===u)&&!/<\?\s?xml[^>]*>/.test(u))if(/<.*?>/.test(u)){e=u.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==e[0]&&(u=e.split(" "),e=u[0],u=u.slice(1).join(" "),c.push(e),n.push(a),a[e]&&!(a[e]instanceof Array)?a[e]=[a[e]]:(a[e]||(a[e]={}),a=a[e]),a instanceof Array&&(a.push({}),a=a[a.length-1]),"/"===e.substr(e.length-1)||"/"===u.substr(u.length-1)))e="/"+e;if("/"===e[0]){e=
e.substr(1);if(c.length&&c[c.length-1]!==e)return console.log("Unmatched tag, aborting: "+e),!1;c.pop();a=n.length?n[n.length-1]:null;n.pop()}}else{var m=n[n.length-1][e];m instanceof Array?(m.pop(),m.push(q.parseNumeric(u))):n[n.length-1][e]=q.parseNumeric(u)}}return b},xmlstring2badgerfish:function(d){for(var d=d.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),f=/^\s+$/gm,e,c=[],n=[],a={},b=a,g=0,l=d.length;g<l;g++)if(e=d[g],!(f.test(e)||""===e)&&!/<\?\s?xml[^>]*>/.test(e))if(/<.*?>/.test(e)){e=
e.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==e[0]){var u=e.split(" ");e=u[0];u=u.slice(1).join(" ");c.push(e);n.push(a);a[e]&&!(a[e]instanceof Array)?a[e]=[a[e]]:a[e]||(a[e]={});a=a[e];a instanceof Array&&(a.push({}),a=a[a.length-1]);if("/"===e.substr(e.length-1)||"/"===u.substr(u.length-1))e="/"+e;for(var u=q.multiSplit(u,"= "),m="",x=0;x<u.length;x++){var s=u[x];"/"===s[s.length-1]&&(s=s.substr(0,s.length-1));if(1===x%2){if("'"===s[0]||'"'===s[0]){for(var o=s[0],s=s.substr(1);s[s.length-1]!==o&&u.length+
1<x;)s+=u.splice(x+1,1);s[s.length-1]===o&&(s=s.substr(0,s.length-1))}a["@"+m]=s}else m=s}}if("/"===e[0]){e=e.substr(1);if(c.length&&c[c.length-1]!==e)return console.log("Unmatched tag, aborting: "+c[c.length-1]),!1;c.pop();a=n.length?n[n.length-1]:null;n.pop()}}else a.$=e;return b},xml2badgerfish:function(d){var f={},e=[],c,n,a,b,g,l=/^\s+|\s+$/g;d.jsonParent=f;for(e.push(d);e.length;){n=e.pop();var u=null;a=n.jsonParent;d=0;for(c=n.childNodes.length;d<c;d++)b=n.childNodes[d],g=b.tagName,g!==v&&
(u=u||{},u[g]=u[g]||0,u[g]++);if(n.attributes&&n.attributes.length){d=0;for(c=n.attributes.length;d<c;d++)b=n.attributes[d],a["@"+b.name]=b.value}d=0;for(c=n.childNodes.length;d<c;d++)b=n.childNodes[d],g=b.tagName,1===b.nodeType?(1<u[g]?(a[g]=a[g]||[],a[g].push({}),b.jsonParent=a[g][a[g].length-1]):(a[g]=a[g]||{},b.jsonParent=a[g]),e.push(b)):3===b.nodeType&&""!==b.nodeValue.replace(l,"")&&(a.$=a.$||"",a.$+=b.nodeValue)}return f},isTextNode:function(d){for(var d=d.childNodes,f=0,e=d.length;f<e;f++)if(3!==
d[f].nodeType||d[f].childNodes.length)return!1;return!0},parseNumeric:function(d){var f=null,e,f=d.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(""===f)return f;if((-1!==f.indexOf(" ")||-1!==f.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(f))if(/[^0-9\-\+]+/g.test(f))if(/[^0-9\- ]+/g.test(f))if(/[^0-9\-,]+/g.test(f))if(/[^0-9\.e\-\+ ]+/g.test(f))if(/[^0-9\.,e\+\-]+/g.test(f))if(/[^0-9,\-\+ ]+/g.test(f)){if(!/[^0-9\.,e\-\+ ]+/g.test(f)){f=f.split(" ");
d=0;for(e=f.length;d<e;d++)f[d]=q.floatDelimArray(f[d],",");return f}}else{f=f.split(" ");d=0;for(e=f.length;d<e;d++)f[d]=q.intDelimArray(f[d],",");return f}else return q.floatDelimArray(f,",");else return q.floatDelimArray(f," ");else return q.intDelimArray(f,",");else return q.intDelimArray(f," ");else return parseInt(f,10);e=parseFloat(f);return!isNaN(e)?/[^0-9\-\+]+/g.test(f)?e:parseInt(f,10):d},xml2json:function(d){var f={},e=[],c,n,a,b,g;d.jsonParent=f;for(e.push(d);e.length;){n=e.pop();var l=
null;a=n.jsonParent;d=0;for(c=n.childNodes.length;d<c;d++)b=n.childNodes[d],g=b.tagName,g!==v&&(l=l||{},l[g]=l[g]||0,l[g]++);d=0;for(c=n.childNodes.length;d<c;d++){b=n.childNodes[d];g=b.tagName;var u=q.isTextNode(b);1===b.nodeType&&(1<l[g]?(a[g]=a[g]||[],u?a[g].push(q.parseNumeric(q.collectTextNode(b))):(a[g].push({}),b.jsonParent=a[g][a[g].length-1])):u?a[g]=q.parseNumeric(q.collectTextNode(b)):(a[g]=a[g]||{},b.jsonParent=a[g]),u||e.push(b))}}return f}};return{util:q,get:q.get,clearCache:q.clearCache}});
"undefined"===typeof Iuppiter&&(Iuppiter={version:"3026 $".replace(" $","")});Iuppiter.toByteArray=function(h){var v=[],r,m;for(r=0;r<h.length;r++)m=h.charCodeAt(r),127>=m?v.push(m):(2047>=m?v.push(m>>6|192):(65535>=m?v.push(m>>12|224):(v.push(m>>18|240),v.push(m>>12&63|128)),v.push(m>>6&63|128)),v.push(m&63|128));return v};
Iuppiter.Base64={CA:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CAS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",IA:Array(256),IAS:Array(256),init:function(){var h;for(h=0;256>h;h++)Iuppiter.Base64.IA[h]=-1,Iuppiter.Base64.IAS[h]=-1;h=0;for(iS=Iuppiter.Base64.CA.length;h<iS;h++)Iuppiter.Base64.IA[Iuppiter.Base64.CA.charCodeAt(h)]=h,Iuppiter.Base64.IAS[Iuppiter.Base64.CAS.charCodeAt(h)]=h;Iuppiter.Base64.IA["="]=Iuppiter.Base64.IAS["="]=0},encode:function(h,
v){var r,m,o,q,d,f,e,c,n;r=v?Iuppiter.Base64.CAS:Iuppiter.Base64.CA;o=h.constructor==Array?h:Iuppiter.toByteArray(h);q=o.length;d=3*(q/3);f=(q-1)/3+1<<2;m=Array(f);for(c=e=0;e<d;)n=(o[e++]&255)<<16|(o[e++]&255)<<8|o[e++]&255,m[c++]=r.charAt(n>>18&63),m[c++]=r.charAt(n>>12&63),m[c++]=r.charAt(n>>6&63),m[c++]=r.charAt(n&63);e=q-d;0<e&&(n=(o[d]&255)<<10|(2==e?(o[q-1]&255)<<2:0),m[f-4]=r.charAt(n>>12),m[f-3]=r.charAt(n>>6&63),m[f-2]=2==e?r.charAt(n&63):"=",m[f-1]="=");return m.join("")},decode:function(h,
v){var r,m,o,q,d,f,e,c,n,a,b,g;r=v?Iuppiter.Base64.IAS:Iuppiter.Base64.IA;h.constructor==Array?(o=h,d=!0):(o=Iuppiter.toByteArray(h),d=!1);q=o.length;f=0;for(e=q-1;f<e&&0>r[o[f]];)f++;for(;0<e&&0>r[o[e]];)e--;c="="==o[e]?"="==o[e-1]?2:1:0;m=e-f+1;n=76<q?("\r"==o[76]?m/78:0)<<1:0;q=(6*(m-n)>>3)-c;m=Array(q);b=a=0;for(eLen=3*(q/3);a<eLen;)g=r[o[f++]]<<18|r[o[f++]]<<12|r[o[f++]]<<6|r[o[f++]],m[a++]=g>>16&255,m[a++]=g>>8&255,m[a++]=g&255,0<n&&19==++b&&(f+=2,b=0);if(a<q){for(n=g=0;f<=e-c;n++)g|=r[o[f++]]<<
18-6*n;for(r=16;a<q;r-=8)m[a++]=g>>r&255}if(d)return m;for(g=0;g<m.length;g++)m[g]=String.fromCharCode(m[g]);return m.join("")}};Iuppiter.Base64.init();
(function(){Iuppiter.compress=function(h){var v=[],r,m=0,o=0,q,d,f=128,e,c,n=Array(256);for(r=0;256>r;r++)n[r]=3435973836;h=h.constructor==Array?h:Iuppiter.toByteArray(h);for(r=h.length;m<r;){if(256==(f<<=1)){if(o>=r-1-16){e=r;for(o=m=0;e;e--)v[o++]=h[m++];break}f=1;d=o;v[o++]=0}if(m>r-66)v[o++]=h[m++];else if(q=(h[m]+13^h[m+1]-13^h[m+2])&255,c=m-n[q]&1023,n[q]=m,q=m-c,0<=q&&q!=m&&h[m]==h[q]&&h[m+1]==h[q+1]&&h[m+2]==h[q+2]){v[d]|=f;for(e=3;66>e&&h[m+e]==h[q+e];e++);v[o++]=e-3<<2|c>>8;v[o++]=c;m+=
e}else v[o++]=h[m++]}return v};Iuppiter.decompress=function(h,v){var r,m=[],o,q=0,d=0,f,e,c=128,n;r=h.constructor==Array?h:Iuppiter.toByteArray(h);for(o=r.length;q<o;){if(256==(c<<=1))c=1,e=r[q++];if(e&c)if(n=(r[q]>>2)+3,f=(r[q]<<8|r[q+1])&1023,q+=2,0<=(f=d-f))for(;0<=--n;)m[d++]=m[f++];else break;else m[d++]=r[q++]}if(!("undefined"==typeof v?0:v)){for(r=0;r<d;r++)m[r]=String.fromCharCode(m[r]);m=m.join("")}return m}})();
CubicVR.RegisterModule("Shader",function(h){function v(a,b){var g=h.util,l,n,f,x,s=o.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";-1!==a.indexOf("\n")?(f=a,l=e(o.gl,a,"x-shader/x-vertex")):(l=c(o.gl,a),null===l&&(f=g.getURL(a),l=e(o.gl,f,"x-shader/x-vertex")));s.getShaderParameter(l,s.COMPILE_STATUS)||(this.vertexLog=s.getShaderInfoLog(l),this.success=!1);-1!==b.indexOf("\n")?(x=b,n=e(o.gl,b,"x-shader/x-fragment")):(n=c(o.gl,
b),null===n&&(x=g.getURL(b),n=e(o.gl,x,"x-shader/x-fragment")));s.getShaderParameter(n,s.COMPILE_STATUS)||(this.fragmentLog=s.getShaderInfoLog(n),this.success=!1);this.success?(this.shader=s.createProgram(),s.attachShader(this.shader,l),s.attachShader(this.shader,n),s.linkProgram(this.shader),o.gl.getProgramParameter(this.shader,s.LINK_STATUS)||(d("Error linking shader:\n"+s.getProgramInfoLog(this.shader)),this.success=!1)):(l=g.multiSplit(this.vertexLog,";\n"),g=g.multiSplit(this.fragmentLog,";\n"),
l.length&&this.dumpErrors(l,f),g.length&&this.dumpErrors(g,x))}function r(a){this._update=a.update||null;this._init=a.init||null;this._vertex=h.get(a.vertex)||null;this._fragment=h.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var m=h.undef,o=h.GLCore,q=h.enums,d=h.log,f=h.util;q.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},mode:{POINT_SPRITE:512,POINT_SIZE:1024,POINT_CIRCLE:2048},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var e=function(a,b,g){if("x-shader/x-fragment"===g)g=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===g)g=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(g,b);a.compileShader(g);return g},c=function(a,b){var g=document.getElementById(b);if(!g)return null;for(var l=
"",c=g.firstChild;c;)3===c.nodeType&&(l+=c.textContent),c=c.nextSibling;if("x-shader/x-fragment"===g.type)g=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===g.type)g=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(g,l);a.compileShader(g);return g};v.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,b,g){for(var g=(g||"Error on line")+" ",b=b.split("\n"),l=0,c=a.length;l<c;l++){var e=a[l];if(0===e.indexOf("ERROR: ")){var e=e.substr(7).trim(),
n=e.substr(0,e.indexOf(" ")),e=e.substr(n.length),n=n.split(":"),n=parseInt(n[1],10);console.log(n+"> "+b[n-1]);console.log(g+n+", :"+e)}}},bindSelf:function(a){var b,g,l;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(b=a.split("["),l=b[0],b=b[1].split("]"),g=b[0],b=b[1].split("."),b=b[1],this[l]===m&&(this[l]=[]),this[l][g]===m&&(this[l][g]={}),this[l][g][b]=this.uniforms[a]):(b=a.split("."),l=b[0],b=b[1],this[l]===m&&(this[l]={}),this[l][b]=this.uniforms[a]):-1!==a.indexOf("[")?(b=a.split("["),l=b[0],
b=b[1].split("]"),g=b[0],this[l]===m&&(this[l]=[]),this[l][g]=this.uniforms[a]):this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==m&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.VECTOR;
this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==m&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==m&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=
q.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_FLOAT;
this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==m&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){o.gl.useProgram(this.shader)},setMatrix:function(a,b){var g=this.uniforms[a];if(null!==g){var l=b.length;16===l?
o.gl.uniformMatrix4fv(g,!1,b):9===l?o.gl.uniformMatrix3fv(g,!1,b):4===l&&o.gl.uniformMatrix2fv(g,!1,b)}},setInt:function(a,b){var g=this.uniforms[a];null!==g&&o.gl.uniform1i(g,b)},setFloat:function(a,b){var g=this.uniforms[a];null!==g&&o.gl.uniform1f(g,b)},setVector:function(a,b){var g=this.uniforms[a];if(null!==g){var l=b.length;4==l?o.gl.uniform4fv(g,b):3==l?o.gl.uniform3fv(g,b):2==l?o.gl.uniform2fv(g,b):o.gl.uniform4fv(g,b)}},clearArray:function(a){var b=o.gl,a=this.uniforms[a];null!==a&&b.disableVertexAttribArray(a)},
bindArray:function(a,b){var g=o.gl,l=this.uniforms[a];if(null!==l){var c=this.uniform_type[a];c===q.shader.uniform.ARRAY_VERTEX?(g.bindBuffer(g.ARRAY_BUFFER,b),g.vertexAttribPointer(l,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(l)):c===q.shader.uniform.ARRAY_UV?(g.bindBuffer(g.ARRAY_BUFFER,b),g.vertexAttribPointer(l,2,g.FLOAT,!1,0,0)):c===q.shader.uniform.ARRAY_FLOAT&&(g.bindBuffer(g.ARRAY_BUFFER,b),g.vertexAttribPointer(l,1,g.FLOAT,!1,0,0))}}};var n={tidyScript:function(a){return a.replace(/\t+/g,
" ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g," ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var b={},a=f.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var g=a[i];0===g.indexOf("#define")&&(g=g.split(" "),2<g.length&&(b[g[1]]=g.slice(2).join(" ")))}return b},replaceAll:function(a,b,g,l){var g=g||"",l=l||"",c;for(c in b)if(b.hasOwnProperty(c))for(var e=g+c+l;-1!==a.indexOf(e);)a=
a.replace(e,g+b[c]+l);return a},getShaderInfo:function(a,b){var g,l,c,e,d,s,o=["uniform","attribute","varying"],h=[],q={};s={};var r;b===m&&(b="");a=n.tidyScript(a);b=n.tidyScript(b);q.v_define=n.getDefines(a);q.f_define=n.getDefines(b);a=n.replaceAll(a,q.v_define,"[","]");b=n.replaceAll(b,q.f_define,"[","]");r=f.multiSplit(a+"\n"+b,"\n;");var t=[];e=c=-1;g=0;for(l=r.length;g<l;g++)d=r[g],-1===c&&0===d.indexOf("struct")?c=g:-1===e&&(-1!==c&&-1!==d.indexOf("}"))&&(e=g+1),-1!==c&&-1!==e&&(d=r.slice(c,
e).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,"").replace(/\n\n/gm,"\n"),t.push({start:c,end:e,struct:d.split("\n")}),e=c=-1);g=0;for(l=t.length;g<l;g++){var w=t[g].struct,z=null;c=0;for(e=w.length;c<e;c++)d=w[c].split(" "),1>=d.length||("struct"==d[0]?(z=d[1],s[z]={}):z&&(s[z][d[1]]=d[0]))}q.struct=s;g=0;for(l=o.length;g<l;g++)q[o[g]]=[];g=0;for(l=r.length;g<l;g++){d=r[g];c=0;for(e=o.length;c<e;c++)if(t=o[c],0===d.indexOf(t)&&(s=d.split(" "),3===s.length&&s[0]==t&&-1===
h.indexOf(s[2])))if(h.push(s[2]),-1!==s[2].indexOf("[")){var w=s[2].split("["),z=w[1].replace("]",""),C=parseInt(z,10);C===C&&(z=C);q[t].push({name:w[0],type:s[1],isArray:!0,len:z})}else q[t].push({name:s[2],type:s[1]})}return q},genShaderVarList:function(a,b){var c=a[b],l=[],e,n,d,f,m,o;if(!c)return[];e=0;for(n=c.length;e<n;e++){var h=c[e];if(a.struct[h.type]){var q=a.struct[h.type];if(q&&h.isArray){d=0;for(f=h.len;d<f;d++)for(o in m=h.name+"["+d+"]",q)q.hasOwnProperty(o)&&l.push({location:m+"."+
o,type:q[o],basename:h.name})}else for(o in q)l.push({location:h.name+"."+o,type:q[o],basename:h.name})}else if(h.isArray){d=0;for(f=h.len;d<f;d++)m=h.name+"["+d+"]",l.push({location:m,type:h.type,basename:h.name})}else l.push({location:h.name,type:h.type,basename:h.name})}return l},getShaderVars:function(a){var b={};b.uniform=n.genShaderVarList(a,"uniform");b.attribute=n.genShaderVarList(a,"attribute");return b}};r.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},
ready:function(){return this._initialized},isReady:function(){return this._initialized},hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,b,c,l,e){c=c||[];a=h.util.get(a);b=h.util.get(b);e=e||"#define customShader_splice";if(l=l===m?this._vertex||this._fragment:l)l=a.indexOf(e),e=b.indexOf(e),-1!==l&&this._vertex&&(a=a.substr(0,l)+this._vertex),-1!==e&&this._fragment&&(b=b.substr(0,e)+this._fragment);this._shader=new h.Shader(a,b);this._shaderInfo=n.getShaderInfo(a,b);this._shaderVars=
n.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,"uniform",c);this._appendShaderVars(this._shaderVars,"attribute",c);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,b,c){for(var a=function(a,b){return function(l,c){c!==m&&(f.activeTexture(f.TEXTURE0+l),f.bindTexture(o.gl.TEXTURE_2D,h.Textures[c.tex_id]));b.value=l;a.update(b)}},l=0,e=this._shaderVars[b].length;l<e;l++){var n=this._shaderVars[b][l],d=n.location;if(-1===
c.indexOf(n.basename)&&(n=n.type,"vec3"===n?"attribute"===b?this._shader.addVertexArray(d):this._shader.addVector(d):"vec2"===n?"attribute"===b?this._shader.addUVArray(d):this._shader.addVector(d):"vec4"===n?"attribute"!==b&&this._shader.addVector(d):"float"===n?"attribute"===b?this._shader.addFloatArray(d):this._shader.addFloat(d):"sampler2D"===n||"int"===n?this._shader.addInt(d):("mat4"===n||"mat3"===n||"mat2"===n)&&this._shader.addMatrix(d),d=this._bindSelf(d),"sampler2D"==n&&d)){var f=o.gl;d.set=
a(this,d)}}},_bindSelf:function(a){var b,c,l,e;if(null!==this._shader.uniforms[a]){var n=function(a,b){return function(l){b.value=l;a.update(b)}};-1!==a.indexOf(".")?-1!==a.indexOf("[")?(b=a.split("["),l=b[0],b=b[1].split("]"),c=b[0],b=b[1].split("."),b=b[1],this[l]===m&&(this[l]=[]),this[l][c]===m&&(this[l][c]={}),e={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[l][c][b]=e):(b=a.split("."),l=b[0],b=b[1],this[l]===m&&(this[l]={}),e={location:this._shader.uniforms[a],
value:null,type:this._shader.uniform_type[a]},this[l][b]=e):-1!==a.indexOf("[")?(b=a.split("["),l=b[0],b=b[1].split("]"),c=b[0],this[l]===m&&(this[l]=[]),e={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[l][c]=e):(e={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=e);this._bindings.push(e);e&&(e.set=n(this,e));return e}},_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var b=0,c=this._bindings.length;b<
c;b++)this.update(this._bindings[b],a)},update:function(a){if(this._initialized){var b=o.gl,c=a.value,l=a.location;null!==l&&(a.type===q.shader.uniform.MATRIX?(a=c.length,16===a?b.uniformMatrix4fv(l,!1,c):9===a?b.uniformMatrix3fv(l,!1,c):4===a&&b.uniformMatrix2fv(l,!1,c)):a.type===q.shader.uniform.INT?b.uniform1i(l,c):a.type===q.shader.uniform.VECTOR?(a=c.length,4===a&&b.uniform4fv(l,c),3===a?b.uniform3fv(l,c):2===a?b.uniform2fv(l,c):b.uniform4fv(l,c)):a.type===q.shader.uniform.FLOAT?b.uniform1f(l,
c):a.type===q.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(l,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(l)):a.type===q.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(l,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(l)):a.type===q.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(l,1,b.FLOAT,!1,0,0),b.enableVertexAttribArray(l)))}}};return{Shader:v,shader_util:n,CustomShader:r}});
CubicVR.RegisterModule("MainLoop",function(h){function v(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function r(){null!==h.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(r),h.GLCore.mainloop.interval())}function m(e,c,n){window.requestAnimationFrame===q&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null);null!==h.GLCore.mainloop&&(!window.requestAnimationFrame&&h.GLCore.mainloop&&clearInterval(h.GLCore.mainloop.interval),h.GLCore.mainloop=null);if(null===e)h.GLCore.mainloop=null;else{if(!(this instanceof m))return new m(e,c,n);this.renderList=[];var a=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],b=new v;b.start();this.timer=b;this.func=e;this.doclear=c!==q?c:!0;h.GLCore.mainloop=this;f.resizeList.length&&!h.GLCore.resize_active&&
(window.addEventListener("resize",function(){h.GLCore.onResize()},!1),h.GLCore.resize_active=!0);c=function(){return function(){var c=h.GLCore.gl;b.update();h.GLCore.mainloop.doclear&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);e(b,h.GLCore.gl);var l=a[a.length-1],n=l.scenes;l.update&&l.update(b,c);if(n){c=0;for(l=n.length;c<l;++c){var d=n[c];if(!d.paused){d.update&&d.update(b,h.GLCore.gl);d.render()}}}}}();n?this.loopFunc=c:window.requestAnimationFrame?(this.interval=c,window.requestAnimationFrame(r)):
this.interval=setInterval(c,20)}}function o(e,c,n){this.canvas=e;this.camera=c;this.mpos=[0,0];this.mdown=!1;var a=this;this.mEvents={};this.keyState=[];for(var b in d.keyboard)this.keyState[b]=!1;this.onMouseDown=function(){return function(b){a.mdown=!0;a.mpos=[b.pageX-b.target.offsetLeft,b.pageY-b.target.offsetTop];a.mEvents.mouseDown&&a.mEvents.mouseDown(a,a.mpos,a.keyState)}}();this.onMouseUp=function(){return function(b){a.mdown=!1;a.mpos=[b.pageX-b.target.offsetLeft,b.pageY-b.target.offsetTop];
a.mEvents.mouseUp&&a.mEvents.mouseUp(a,a.mpos,a.keyState)}}();this.onMouseMove=function(){return function(b){var l=[],b=[b.pageX-b.target.offsetLeft,b.pageY-b.target.offsetTop];l[0]=b[0]-a.mpos[0];l[1]=b[1]-a.mpos[1];a.mpos=b;a.mEvents.mouseMove&&a.mEvents.mouseMove(a,a.mpos,l,a.keyState)}}();this.onMouseWheel=function(){return function(b){b=b.wheelDelta?b.wheelDelta:100*-b.detail;a.mEvents.mouseWheel&&a.mEvents.mouseWheel(a,a.mpos,b,a.keyState)}}();this.onKeyDown=function(){return function(b){var b=
b.keyCode,l=null;a.mEvents.keyPress?(l=a.mEvents.keyPress(a,a.mpos,b,a.keyState),a.keyState[b]=l!==q?!!l:!0):a.keyState[b]=!0;a.keyState[b]&&a.mEvents.keyDown&&(l=a.mEvents.keyDown(a,a.mpos,b,a.keyState),a.keyState[b]=l!==q?!!l:!0)}}();this.onKeyUp=function(){return function(b){b=b.keyCode;a.mEvents.keyUp&&a.mEvents.keyUp(a,a.mpos,b,a.keyState);a.keyState[b]=!1}}();this.eventDefaults={mouseMove:function(a,b,c){a.mdown&&a.orbitView(c)},mouseWheel:function(a,b,c){a.zoomView(c)},mouseDown:null,mouseUp:null,
keyDown:null,keyUp:null,keyPress:null};!1!==n&&this.setEvents(n===q?this.eventDefaults:n);this.bind()}var q=h.undef,d=h.enums,f=h.GLCore;d.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,
KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,
SEMICOLON:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};v.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(e){this.lock_rate=1/e;this.lock_state=
!0},unlock:function(){var e=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=e-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);
this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(e){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-e},setSeconds:function(e){this.setMilliseconds(1E3*e|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-
this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(e){this.paused_state=e},getPaused:function(){return this.paused_state}};m.prototype={setPaused:function(e){this.timer.setPaused(e)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(e){this.timer.setSeconds(e)},getTimerSeconds:function(){return this.timer.getSeconds()},
resetTimer:function(){this.timer.reset()},addScene:function(e){this.renderStack[this.renderStack.length-1].scenes.push(e);return e},pushSceneGroup:function(e){e.scenes=e.scenes||[];this.renderStack.push(e);for(var c=0;c<e.scenes.length;++c)e.scenes[c].enable();e.start&&e.start()},popSceneGroup:function(){for(var e=this.renderStack[this.renderStack.length-1],c=0;c<e.scenes.length;++c)e.scenes[c].disable();1<this.renderStack.length&&this.renderStack.pop();e.stop&&e.stop()},getScene:function(e){for(var c=
renderStack[renderStack.length-1],n,a=0,b=c.scenes.length;a<b;++a)if(c.scenes[a].scene.name===e){n=c.scenes[a];break}return n},resumeScene:function(e){"string"===typeof e&&(e=this.getScene(e));e.enable();e.paused=!1},pauseScene:function(e){"string"===typeof e&&(e=this.getScene(e));e.paused=!0;e.disable()},removeScene:function(e){var c=renderStack[renderStack.length-1];"string"===typeof e&&(e=this.getScene(e));var n=c.scenes.indexOf(e);-1<n&&c.scenes.splice(n,1);return e},runOnce:function(){this.loopFunc()}};
o.prototype={isKeyPressed:function(e){return this.keyState[e]},getKeyState:function(e){return e!==q?this.keyState[e]:this.keyState},setEvents:function(e){this.mEvents={};for(var c in e)this.bindEvent(c,e[c])},orbitView:function(e){var c=h.vec3,n=c.subtract(this.camera.target,this.camera.position),n=c.length(n);this.camera.position=c.moveViewRelative(this.camera.position,this.camera.target,-n*e[0]/300,0);this.camera.position[1]+=n*e[1]/300;this.camera.position=c.add(this.camera.target,c.multiply(c.normalize(c.subtract(this.camera.position,
this.camera.target)),n))},panView:function(e,c){var n=h.vec3;c||(c=!1);var a=n.subtract(this.camera.target,this.camera.position),a=n.length(a),b=this.camera.position;c?this.camera.position=n.moveViewRelative(this.camera.position,this.camera.target,-a*e[0]/300,-a*e[1]/300):(this.camera.position=n.moveViewRelative(this.camera.position,this.camera.target,-a*e[0]/300,0),this.camera.position[1]+=a*e[1]/300);a=n.subtract(this.camera.position,b);this.camera.target=n.add(this.camera.target,a)},zoomView:function(e,
c,n){var a=h.vec3,b=a.subtract(this.camera.target,this.camera.position),b=a.length(b),b=b-e/1E3;c||(c=0.1);n||(n=1E3);b<c&&(b=c);b>n&&(b=n);this.camera.position=a.add(this.camera.target,a.multiply(a.normalize(a.subtract(this.camera.position,this.camera.target)),b))},bindEvent:function(e,c){this.mEvents[e]=c===q?this.eventDefaults[e]:c},unbindEvent:function(e){this.bindEvent(e,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",
this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",
this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(e){this.camera=e},getMousePosition:function(){return this.mpos}};return{Timer:v,MainLoop:m,MouseViewController:o,setMainLoop:function(e){h.GLCore.mainloop=e},keyboard:d.keyboard}});
CubicVR.RegisterModule("Texture",function(h){function v(a,b){if(1===a||1===b)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==b)for(;0===b%2;)b/=2;return 1<a||1<b?!1:!0}function r(b){var e=h.GLCore.gl;if("CANVAS"===b.nodeName||"IMG"===b.nodeName||"VIDEO"===b.nodeName)this.canvasSource=b;else{this.canvasSource=document.createElement("CANVAS");if(void 0===b.width||void 0===b.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=b.width;this.canvasSource.height=
b.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=b.update;this.texture=new h.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var g=this.canvasSource;(!g.height||!g.width)&&a("Warning - CanvasTexture input has no initial width and height, edges clamped.");!g.height||!g.width||!v(g.width,g.height)?(this.setFilter(c.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,
e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)):(this.setFilter(c.texture.filter.LINEAR_MIP),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT));"IMG"===b.nodeName&&this.update()}function m(a,b){if(!a)throw"PDF Texture Error: page is null.";var e=this,g=h.GLCore.gl,n=this.canvasSource=document.createElement("canvas"),d;n.mozOpaque=!0;n.width=b.width;n.height=b.height;d=this.canvasContext=
n.getContext("2d");d.save();d.fillStyle="rgb(255, 255, 255)";d.fillRect(0,0,n.width,n.height);d.restore();var f=b.viewport||a.getViewport(1);f.width=n.width;f.height=n.height;a.render({canvasContext:d,viewport:f,continueCallback:function(a){a()}}).then(function(){e.update()});this.texture=new h.Texture;this.updateFunction=b.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;
v(n.width,n.height)?(this.setFilter(c.texture.filter.LINEAR_MIP),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.REPEAT),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE))}function o(a,b,e){var g=h.GLCore.gl;this.texture=new h.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=b;this.canvas.height=e;this.pjs=
new Processing(this.canvas,h.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;v(this.canvas.width,this.canvas.height)?this.setFilter(c.texture.filter.LINEAR_MIP):(this.setFilter(c.texture.filter.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE))}function q(a,
b,g){var n=e.gl;this.width=b;this.height=g;this.srcTex=a;this.outTex=new h.RenderBuffer(b,g);v(b,g);a=[1/b,1/g,0];this.outputBuffer=new h.RenderBuffer(b,g,!1);this.fsQuad=h.fsQuad.make(b,g);shaderNMap=new h.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(n.TEXTURE0);this.setFilter(c.texture.filter.LINEAR);
n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)}function d(a,b,g){var n=e.gl;this.width=a;this.height=b;this.outTex=new h.RenderBuffer(a,b,g);this.texture=this.outTex.texture;var d=v(a,b);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(n.TEXTURE0);d?(this.setFilter(c.texture.filter.LINEAR),
n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE));this.dims=[a,b];this.depth=g?!0:!1}function f(a,b){this.scene=a;this.renderTex=new d(b?b.width:a.camera.width,b?b.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var e=h.GLCore,c=h.enums,n=h.undef,a=h.log;c.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var b=function(a,b){this.img_path=a;this.filter_type=b};b.prototype={getTexture:function(a,b){return new g(this.img_path,this.filter_type,a,b)}};var g=function(a,b,g,d,f){var m=
e.gl;this.tex_id=h.Textures.length;this.filterType=-1;this.onready=f;this.loaded=!1;h.Textures[this.tex_id]=m.createTexture();h.Textures_obj[this.tex_id]=this;a&&("string"===typeof a?h.Images[this.tex_id]=new Image:"object"===typeof a&&"IMG"===a.nodeName&&(h.Images[this.tex_id]=a),h.Textures_ref[a]=this.tex_id);m.bindTexture(m.TEXTURE_2D,h.Textures[this.tex_id]);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR);if(a){var o=this.tex_id,
q=b!==n?b:e.default_filter,r=this;h.Images[this.tex_id].onload=function(){m.bindTexture(m.TEXTURE_2D,h.Textures[o]);m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,true);m.pixelStorei(m.UNPACK_COLORSPACE_CONVERSION_WEBGL,m.NONE);var a=h.Images[o];m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,a);if(a=v(a.width,a.height)){m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.REPEAT);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.REPEAT)}else{m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE);
m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE)}if(h.Textures_obj[o].filterType===-1){if(a)q=c.texture.filter.LINEAR_MIP;else if(q===c.texture.filter.LINEAR_MIP)q=c.texture.filter.LINEAR;h.Textures_obj[o].filterType===-1&&h.Textures_obj[o].setFilter(q)}else h.Textures_obj[o].setFilter(h.Textures_obj[o].filterType);if(r.onready)r.onready();m.bindTexture(m.TEXTURE_2D,null);r.loaded=true};g?(h.Images[this.tex_id].deferredSrc=a,g.addImage(d,a,h.Images[this.tex_id])):"string"===typeof a&&
(h.Images[this.tex_id].src=a)}this.active_unit=-1};g.prototype={setFilter:function(a){if(-1<this.tex_id){var b=h.GLCore.gl;b.bindTexture(b.TEXTURE_2D,h.Textures[this.tex_id]);a===c.texture.filter.LINEAR?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR)):a===c.texture.filter.LINEAR_MIP?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_NEAREST),b.generateMipmap(b.TEXTURE_2D)):
a===c.texture.filter.NEAREST?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST)):a===c.texture.filter.NEAREST_MIP&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST_MIPMAP_LINEAR),b.generateMipmap(b.TEXTURE_2D));this.filterType=a}},use:function(a){-1<this.tex_id&&(e.gl.activeTexture(a),e.gl.bindTexture(e.gl.TEXTURE_2D,h.Textures[this.tex_id]),this.active_unit=
a)},clear:function(){-1<this.tex_id&&-1!==this.active_unit&&(e.gl.activeTexture(this.active_unit),e.gl.bindTexture(e.gl.TEXTURE_2D,null),this.active_unit=-1)},destroy:function(){var a=h.GLCore.gl;-1<this.tex_id&&h.Textures[this.tex_id]&&(a.deleteTexture(h.Textures[this.tex_id]),delete h.Textures_obj[this.tex_id],this.tex_id=-1)}};r.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};m.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};o.prototype={update:function(){var a=h.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){var a=
e.gl,b=a.getParameter(a.VIEWPORT);this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);h.fsQuad.render(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(b[0],b[1],b[2],b[3])}};d.prototype={begin:function(){var a=e.gl;this.dims=a.getParameter(a.VIEWPORT);this.outTex.use();a.viewport(0,0,this.width,this.height);this.depth?a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT)},
end:function(){var a=e.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};f.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:g,DeferredLoadTexture:b,CanvasTexture:r,PdfTexture:m,TextTexture:function(a,b){var c=b&&b.color||"#fff",e=b&&b.bgcolor,g=b&&b.font||"18pt Arial",d=b&&b.align||"start",f=b&&b.y||0,m=b&&b.width||n,o=b&&b.height||n,h,q=document.createElement("CANVAS"),
z=q.getContext("2d"),C=0,C="string"===typeof a?1:a.length;z.font=g;var v=b&&b.lineHeight||z.measureText("OO").width,F;if(1===C)F=z.measureText(a).width;else for(h=F=0;h<C;++h){var y=z.measureText(a[h]).width;y>F&&(F=y)}q.width=m||F;q.height=o||v*C;e&&(z.fillStyle=e,z.fillRect(0,0,q.width,q.height));z.fillStyle=c;z.font=g;z.textAlign=d;z.textBaseline="top";if(1===C)c=b&&b.x||"center"===d?q.width/2:"right"===d?q.width:0,z.fillText(a,c,f);else for(h=0;h<C;++h)c=b&&b.x||"center"===d?q.width/2:"right"===
d?q.width:0,z.fillText(a[h],c,f+h*v);z.fill();this.use=r.prototype.use;this.clear=r.prototype.clear;this.update=r.prototype.update;r.apply(this,[q]);this.update();this.canvasSource=null},PJSTexture:o,NormalMapGen:q,RenderTexture:d,SceneRenderTexture:f}});
CubicVR.RegisterModule("DrawBufferTexture",function(h){var v=h.GLCore,r=h.enums;r.draw={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2,MULTIPLY:3}};var m=function(m){m=m||{};this.operation=h.parseEnum(r.draw.op,m.operation||m.op)||r.draw.op.REPLACE;this.brushType=h.parseEnum(r.draw.brush,m.brushType)||r.draw.brush.SINE;this.brushSize=m.size||5;this.color=m.color||[255,255,255,255]};m.prototype={setOperation:function(m){this.operation=h.parseEnum(r.draw.op,m)},getOperation:function(){return this.operation},
setBrushType:function(m){this.brushType=h.parseEnum(r.draw.brush,m)||r.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(m){this.brushSize=m},getSize:function(){return this.brushSize},setColor:function(m){this.color=m},getColor:function(){return this.color.slice(0)}};return{DrawBufferTexture:h.extendClassGeneral(h.Texture,function(o){o=o||{};h.Texture.apply(this,[o.image,o.filter,o.deferred_bin,o.binId,o.readyFunc]);this.width=o.width||0;this.height=o.height||0;this.imageBufferData=
this.imageBuffer=null;this.brush=o.brush||new m;this.drawBuffer=[];this.width&&this.height&&this.setupImageBuffer(this.width,this.height)},{getUint8Buffer:function(){return this.imageBuffer},needsFlush:function(){return 0!==this.drawBuffer.length},getWidth:function(){return this.width},getHeight:function(){return this.height},setupImageBuffer:function(){this.imageBufferData=new ArrayBuffer(4*this.width*this.height);this.imageBuffer=new Uint8Array(this.imageBufferData);this.update()},setBrush:function(m){this.brush=
m},getBrush:function(){return this.brush},draw:function(m,h,d){var f=d||this.brush,d=f.getOperation(),e=f.getSize(),c=f.getBrushType(),f=f.getColor();this.drawBuffer.push([m,h,d,e,c,f])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var m=this.drawBuffer.pop();this.drawFunc(m[0],m[1],m[2],m[3],m[4],m[5])}return!0},drawFunc:function(m,h,d,f,e,c){for(var n=this.imageBuffer,a=this.width,b=this.height,g=parseInt(Math.floor(m),10)-f;g<parseInt(Math.ceil(m),10)+f;g++)for(var l=
g-m,u,E=parseInt(Math.floor(h),10)-f;E<parseInt(Math.ceil(h),10)+f;E++)if(!(0>g||g>=a||0>E||E>=b)){u=E-h;var x;0===e&&(x=(1-Math.sqrt(l*l+u*u)/f)/2);u=4*(E*a+g);0===d?0>x&&(x=0):1===d?0>x&&(x=0):2===d&&(x=-x,0<x&&(x=0));var s=Math.floor(n[u]*(1-x)+c[0]*x),G=Math.floor(n[u+1]*(1-x)+c[1]*x),A=Math.floor(n[u+2]*(1-x)+c[2]*x),r=Math.floor(n[u+3]*(1-x)+c[3]*x);255<s?s=255:0>s&&(s=0);255<G?G=255:0>G&&(G=0);255<A?A=255:0>A&&(A=0);255<r?r=255:0>r&&(r=0);n[u]=s;n[u+1]=G;n[u+2]=A;n[u+3]=r}},update:function(){var m=
v.gl;this.flush();m.bindTexture(m.TEXTURE_2D,h.Textures[this.tex_id]);m.texImage2D(m.TEXTURE_2D,0,m.RGBA,this.width,this.height,0,m.RGBA,m.UNSIGNED_BYTE,this.imageBuffer);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR)}}),DrawBufferBrush:m}});
CubicVR.RegisterModule("Material",function(h){function v(c){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(c=h.get(c)||{},c.shader||null);null===q&&(q=new h.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
q._init_shader(q._vertex,q._fragment,!1));this.customShader&&(!this.customShader._init_shader&&"object"===typeof this.customShader)&&(this.customShader=new h.CustomShader(this.customShader));this.diffuse=c.diffuse||[1,1,1];this.specular=c.specular||[0.1,0.1,0.1];this.color=c.color||[1,1,1];this.ambient=c.ambient||[0,0,0];this.name=c.name||null;this.visible=c.visible!==r?c.visible:!0;this.friction=c.friction!==r?c.friction:0.3;this.collision=c.visible!==r?c.collision:!0;this.opacity=c.opacity===r?
1:c.opacity;this.shininess=c.shininess===r?1:c.shininess;this.max_smooth=c.max_smooth===r?60:c.max_smooth;this.env_amount=c.env_amount===r?0.75:c.env_amount;this.morph=c.morph===r?!1:c.morph;this.color_map=c.colorMap===r?!1:c.colorMap;this.uvOffset=c.uvOffset===r?[0,0]:c.uvOffset;this.noFog=c.noFog===r?!1:c.noFog;this.pointSprite=c.pointSprite||!1;this.pointSize=c.pointSize||0;this.pointCircle=c.pointCircle||0;if(c.textures)for(var e in c.textures)this.setTexture(c.textures[e],e)}var r=h.undef,m=
h.GLCore,o=h.enums,q=null,d=[o.texture.map.REFLECT,o.texture.map.SPECULAR,o.texture.map.NORMAL,o.texture.map.BUMP],f=[],e="textureColor textureEnvSphere textureNormal textureBump textureReflect textureSpecular textureAmbient textureAlpha matrixModelView matrixProjection matrixObject matrixNormal vertexPosition vertexNormal vertexColor vertexTexCoord materialTexOffset vertexMorphPosition vertexMorphNormal materialMorphWeight lightDiffuse lightSpecular lightIntensity lightDistance lightPosition lightDirection lightCutOffAngle lightShadowMap lightProjectionMap lightDepthClip lightShadowMatrix lightAmbient materialDiffuse materialColor materialAmbient materialSpecular materialShininess materialEnvironment materialAlpha postDepthInfo".split(" ");
v.prototype={clone:function(){var c=new h.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,collision:this.collision,pointSprite:this.pointSprite,pointSize:this.pointSize,pointCircle:this.pointCircle,name:this.name}),e;for(e in this.textures)this.textures.hasOwnProperty(e)&&
c.setTexture(this.textures[e],e);return c},setVisibility:function(c){this.visible=c},getVisibility:function(){return this.visible},setCollision:function(c){this.collision=c},getCollision:function(){return this.collision},setFriction:function(c){this.friction=c},getFriction:function(){return this.friction},setTexture:function(c,e){if(c&&(e=h.parseEnum(o.texture.map,e)||0,h.features.texturePerPixel||-1===d.indexOf(e)))!c.use&&"string"===typeof c&&(c=h.Textures_ref[c]!==r?h.Textures_obj[h.Textures_ref[c]]:
new h.Texture(c)),this.textures[e]=c},calcShaderMask:function(){var c;c=0+("object"===typeof this.textures[o.texture.map.COLOR]?o.shader.map.COLOR:0);c+="object"===typeof this.textures[o.texture.map.SPECULAR]?o.shader.map.SPECULAR:0;c+="object"===typeof this.textures[o.texture.map.NORMAL]?o.shader.map.NORMAL:0;c+="object"===typeof this.textures[o.texture.map.BUMP]?o.shader.map.BUMP:0;c+="object"===typeof this.textures[o.texture.map.REFLECT]?o.shader.map.REFLECT:0;c+="object"===typeof this.textures[o.texture.map.ENVSPHERE]?
o.shader.map.ENVSPHERE:0;c+="object"===typeof this.textures[o.texture.map.AMBIENT]?o.shader.map.AMBIENT:0;c+="object"===typeof this.textures[o.texture.map.ALPHA]?o.shader.map.ALPHA:0;c+=this.pointSprite?o.shader.mode.POINT_SPRITE:0;c+=this.pointSize?o.shader.mode.POINT_SIZE:0;c+=this.pointCircle?o.shader.mode.POINT_CIRCLE:0;c+=1!==this.opacity?o.shader.map.ALPHA:0;c+=this.color_map?o.shader.map.COLORMAP:0;1!==this.opacity&&(this.blendEnabled=!0);return c},getShaderHeader:function(c,e){return(e!==
r?"#define LIGHT_COUNT "+e+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[o.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[o.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+("object"===typeof this.textures[o.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[o.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[o.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+
("object"===typeof this.textures[o.texture.map.ENVSPHERE]?1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[o.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[o.texture.map.ALPHA]?1:0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(c===o.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(c===o.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(c===o.light.type.SPOT||c===o.light.type.SPOT_SHADOW||c===
o.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(c===o.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(m.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(c===o.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(c===o.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(m.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?
1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+(m.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(m.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(m.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(h.features.lightPerPixel?1:0)+"\n#define POINT_SPRITE "+(this.pointSprite?1:0)+"\n#define POINT_SIZE "+(this.pointSize?1:0)+"\n#define POINT_CIRCLE "+(this.pointCircle?1:0)+"\n\n"},bindObject:function(c,e){var a=m.gl,b=e.vertexPosition,g=e.vertexTexCoord,l=e.vertexNormal,d=e.vertexColor;
a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_points);a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(b);g!==r&&(null!==c.compiled.gl_uvs&&-1!==g)&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_uvs),a.vertexAttribPointer(g,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(g));f.uv=g;l!==r&&(null!==c.compiled.gl_normals&&-1!==l)&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_normals),a.vertexAttribPointer(l,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(l));f.un=l;d!==r&&(null!==c.compiled.gl_colors&&
-1!==d)&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_colors),a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(d));f.uc=d;c.morphTarget&&(b=e.vertexMorphPosition,l=e.vertexMorphNormal,a.bindBuffer(a.ARRAY_BUFFER,c.morphTarget.gl_points),a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(b),l!==r&&(null!==c.morphTarget.gl_normals&&-1!==l)&&(a.bindBuffer(a.ARRAY_BUFFER,c.morphTarget.gl_normals),a.vertexAttribPointer(l,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(l)),
a.uniform1f(e.materialMorphWeight,c.morphWeight));c.compiled.unrolled?a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null):a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.compiled.gl_elements)},bindLines:function(c,e){var a=m.gl,b=e.vertexPosition,g=e.vertexTexCoord,l=e.vertexNormal,d=e.vertexColor;c.compiled.unrolled?(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_lines),a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(b),f.up=b,g!==r&&(null!==c.compiled.gl_line_uvs&&-1!==g)&&(a.bindBuffer(a.ARRAY_BUFFER,
c.compiled.gl_line_uvs),a.vertexAttribPointer(g,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(g)),f.uv=g,l!==r&&(null!==c.compiled.gl_line_normals&&-1!==l)&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_line_normals),a.vertexAttribPointer(l,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(l)),f.un=l,d!==r&&(null!==c.compiled.gl_line_colors&&-1!==d)&&(a.bindBuffer(a.ARRAY_BUFFER,c.compiled.gl_line_colors),a.vertexAttribPointer(d,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(d)),f.uc=d):a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
c.compiled.gl_line_elements);c.morphTarget&&(b=e.vertexMorphPosition,l=e.vertexMorphNormal,a.bindBuffer(a.ARRAY_BUFFER,c.morphTarget.gl_lines),a.vertexAttribPointer(b,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(b),l!==r&&(null!==c.morphTarget.gl_line_normals&&-1!==l)&&(a.bindBuffer(a.ARRAY_BUFFER,c.morphTarget.gl_line_normals),a.vertexAttribPointer(l,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(l)),a.uniform1f(e.materialMorphWeight,c.morphWeight))},clearObject:function(c,e){var a=m.gl;f.uv!==r&&-1!==
f.uv&&a.disableVertexAttribArray(f.uv);f.un!==r&&-1!==f.un&&a.disableVertexAttribArray(f.un);f.uc!==r&&-1!==f.uc&&a.disableVertexAttribArray(f.uc);c.morphTarget&&e&&(up=e.vertexMorphPosition,a.disableVertexAttribArray(up),un=e.vertexMorphNormal,null!==un&&(null!==c.compiled.gl_normals&&-1!==un)&&a.disableVertexAttribArray(un))},use:function(c,n){var a,b=m.gl,g=this.textures,l=!0,n=n||0,c=c||0;this.shader[c]||(this.shader[c]=[]);var d=this.shader[c][n],f=this.customShader&&c===o.light.type.DEPTH_PACK&&
!this.customShader.hasDepthPack();d&&(1!==this.opacity&&!0!==this.blendEnabled)&&(this.dirtyFlag=!0);!0===this.dirtyFlag&&(d=null,this.dirtyFlag=!1);if(d)l=d!==q,d.use();else{a=this.calcShaderMask(c);if(!this.customShader||f)h.ShaderPool[c][a]||(h.ShaderPool[c][a]=[]),d=h.ShaderPool[c][a][n];if(!d){var x=this.getShaderHeader(c,n),s=x+m.CoreShader_vs,x=x+m.CoreShader_fs;this.customShader&&!f?this.customShader._initialized||(this.customShader._init_shader(s,x,e),d=this.customShader.getShader(),d.isCompiled()||
(l=!1,d=q.getShader())):(d=new h.Shader(s,x),d.isCompiled()||(l=!1,d=q.getShader()),h.ShaderPool[c][a][n]=d);a=0;if(c!==o.light.type.DEPTH_PACK){if(c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)a+=n,c===o.light.type.SPOT_SHADOW_PROJECTOR&&(a+=n);"object"===typeof g[o.texture.map.COLOR]&&d.addInt("textureColor",a++);"object"===typeof g[o.texture.map.ENVSPHERE]&&d.addInt("textureEnvSphere",a++);"object"===typeof g[o.texture.map.NORMAL]&&d.addInt("textureNormal",
a++);"object"===typeof g[o.texture.map.BUMP]&&d.addInt("textureBump",a++);"object"===typeof g[o.texture.map.REFLECT]&&d.addInt("textureReflect",a++);"object"===typeof g[o.texture.map.SPECULAR]&&d.addInt("textureSpecular",a++);"object"===typeof g[o.texture.map.AMBIENT]&&d.addInt("textureAmbient",a++)}"object"===typeof g[o.texture.map.ALPHA]&&d.addInt("textureAlpha",a++);d.addMatrix("matrixModelView");d.addMatrix("matrixProjection");d.addMatrix("matrixObject");d.addMatrix("matrixNormal");d.addVertexArray("vertexPosition",
0);d.addVertexArray("vertexNormal");this.color_map&&d.addVertexArray("vertexColor");this.morph&&(d.addVertexArray("vertexMorphPosition"),d.addVertexArray("vertexMorphNormal"),d.addFloat("materialMorphWeight",0));for(a=0;a<n;a++)if(d.addVector("lightDiffuse["+a+"]"),d.addVector("lightSpecular["+a+"]"),d.addFloat("lightIntensity["+a+"]"),d.addFloat("lightDistance["+a+"]"),d.addVector("lightPosition["+a+"]"),d.addVector("lightDirection["+a+"]"),(c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||
c===o.light.type.SPOT)&&d.addFloat("lightCutOffAngle["+a+"]"),c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)d.addInt("lightShadowMap["+a+"]"),c===o.light.type.SPOT_SHADOW_PROJECTOR&&d.addInt("lightProjectionMap["+a+"]"),d.addVector("lightDepthClip["+a+"]"),d.addMatrix("lightShadowMatrix["+a+"]");c!==o.light.type.DEPTH_PACK&&(d.addVector("lightAmbient"),d.addVector("materialDiffuse"),d.addVector("materialColor"),d.addVector("materialAmbient"),d.addVector("materialSpecular"),
d.addFloat("materialShininess"),d.addFloat("materialEnvironment"));d.addFloat("materialAlpha");(m.depth_alpha||c===o.light.type.DEPTH_PACK||c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)&&d.addVector("postDepthInfo");d.addUVArray("vertexTexCoord");d.addVector("materialTexOffset");m.fog_enabled&&!this.noFog&&(d.addVector("fogColor",m.fogColor),d.addFloat("fogDensity",m.fogDensity),d.addFloat("fogNear",m.fogNear),d.addFloat("fogFar",m.fogFar));if(this.pointSprite||
this.pointSize)d.addFloat("pointSize",1),this.pointSize&&!this.pointSprite&&d.addVector("viewPort")}this.shader[c][n]=d;d.use();-1!=d.materialTexOffset&&b.uniform2fv(d.materialTexOffset,[0,0])}a=0;if(c!==o.light.type.DEPTH_PACK){if(c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)a+=n,c===o.light.type.SPOT_SHADOW_PROJECTOR&&(a+=n);if(s=g[o.texture.map.COLOR])s.use(m.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.ENVSPHERE])s.use(m.gl.TEXTURE0+a),a++,b.uniform1f(d.materialEnvironment,
this.env_amount);if(s=g[o.texture.map.NORMAL])s.use(m.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.BUMP])s.use(m.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.REFLECT])s.use(m.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.SPECULAR])s.use(m.gl.TEXTURE0+a),a++;if(s=g[o.texture.map.AMBIENT])s.use(m.gl.TEXTURE0+a),a++}if(s=g[o.texture.map.ALPHA])s.use(m.gl.TEXTURE0+a),a++;m.fog_enabled&&!this.noFog&&(b.uniform3fv(d.fogColor,m.fogColor),b.uniform1f(d.fogDensity,m.fogDensity),b.uniform1f(d.fogNear,m.fogNear),b.uniform1f(d.fogFar,
m.fogFar));c!==o.light.type.DEPTH_PACK?(b.uniform3fv(d.materialColor,this.color),b.uniform3fv(d.materialDiffuse,this.diffuse),b.uniform3fv(d.materialAmbient,this.ambient),b.uniform3fv(d.materialSpecular,this.specular),b.uniform1f(d.materialShininess,128*this.shininess),b.uniform3fv(d.lightAmbient,h.globalAmbient),1>this.opacity&&b.uniform1f(d.materialAlpha,this.opacity),(m.depth_alpha||c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)&&b.uniform3fv(d.postDepthInfo,
[m.depth_alpha_near,m.depth_alpha_far,0])):b.uniform3fv(d.postDepthInfo,[m.shadow_near,m.shadow_far,0]);d.materialTexOffset&&b.uniform2fv(d.materialTexOffset,this.uvOffset);if(this.pointSprite||this.pointSize)b.uniform1f(d.pointSize,this.pointSize),this.pointSprite||b.uniform3fv(d.viewPort,[m.viewportWidth,m.viewportHeight,0]);this.customShader&&(c!==o.light.type.DEPTH_PACK||c===o.light.type.DEPTH_PACK&&!f)&&this.customShader._doUpdate({material:this,textureIndex:a});return l}};return{Material:v}});
CubicVR.RegisterModule("Mesh",function(h){function v(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function r(d){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;this.genNormals=
!0;d=h.get(d)||{};if(d instanceof h.Mesh)this.booleanAdd(d),d._clones=d._clones||1,d._clones++,this.name=d.name?d.name+"_copy"+d._clones:null;else{this.name=d.name||null;this.dynamic=d.dynamic||!1;if(d.material){var f=d.material;f.length?this.materials=f:"object"===typeof f&&(f.use?this.setFaceMaterial(f):this.setFaceMaterial(new h.Material(f)))}(d.point||d.points)&&this.build(d);d.part?this.build(d.part):d.parts&&this.build(d.parts);if((this.primitives=d.primitives||d.primitive||null)&&!this.primitives.length||
"string"===typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var f=0,e=this.primitives.length;f<e;f++){var c=this.primitives[f];"string"===typeof c&&(c=h.get(c));var n=h.primitives[c.type];if(c.type&&n)this.booleanAdd(n(c));else if(c.type){q("Mesh error, primitive "+c.type+" is unknown.");var c="",a;for(a in h.primitives)h.primitives.hasOwnProperty(a)&&(""!==c&&(c+=", "),c+=a);q("Available primitive types are: "+c)}else q("Mesh error, primitive "+
(f+1)+" lacks type.")}this.pointMode=d.pointMode;this.buildWireframe=d.buildWireframe||d.wireframe||!!d.wireframeMaterial||!!d.pointModeMaterial||d.triangulateWireframe||d.pointMode||!1;this.triangulateWireframe=d.triangulateWireframe||null;this.wireframeMaterial=h.get(d.wireframeMaterial,h.Material)||null;this.pointModeMaterial=h.get(d.pointModeMaterial,h.Material)||null;this.wireframe=d.wireframe||!1;d.flipFaces&&this.faces.length&&this.flipFaces();(d.prepare||d.compile&&this.faces.length)&&this.prepare();
(d.clean||d.compile&&this.faces.length&&!this.dynamic)&&this.clean();this.genNormals&&(d.calcNormals&&!d.compile&&!d.prepare)&&this.calcNormals()}}var m=h.undef,o=h.GLCore,q=h.log;v.prototype={setUV:function(d,f){f!==m?this.uvs[f]=d:2!==d.length?this.uvs=d:this.uvs.push(d)},setPointNormal:function(d,f){f!==m?this.point_normals[f]=d:"number"===typeof d[0]?this.point_normals.push(d):this.point_normals=d},setNormal:function(d){this.normal=d;if(!this.point_normals.length&&this.points.length)for(var f=
0,e=this.points.length;f<e;f++)this.point_normals[f]=d},setColor:function(d,f){f!==m?this.point_colors[f]=d:"number"!==typeof d[0]?this.point_colors=d:this.point_colors.push(d)},flip:function(){for(var d=0,f=this.point_normals.length;d<f;d++)this.point_normals[d]=[-this.point_normals[d][0],-this.point_normals[d][1],-this.point_normals[d][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};r.prototype={setPointMode:function(d){this.pointMode=
d},isPointMode:function(){return this.pointMode},setWireframe:function(d){this.wireframe=d},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(d){this.wireframeMaterial=d},getWireframeMaterial:function(){return this.wireframeMaterial},setPointModeMaterial:function(d){this.pointModeMaterial=d},getPointModeMaterial:function(){return this.pointModeMaterial},build:function(d,f){var e,c;"string"===typeof d&&(d=h.get(d));d&&!d.length&&(d=[d]);var n=this.faces.length;f&&f.length&&
this.points.concat(f);for(var a=0,b=d.length;a<b;a++){var g=d[a];e=g.material;c=g.points||g.point;var l=g.faces||g.face,u=g.uv||g.uvs,m=g.color||g.colors,o=g.normal||g.normals,g=g.segment||null;null!==g&&this.setSegment(parseInt(g,10));if(c&&c.length&&(this.points=this.points.concat(c),l&&n)){l=l.slice(0);c=0;for(g=l.length;c<g;c++)for(var s=l[c],G=0,A=l.length;G<A;G++)s[G]+=n}e&&(e.length?this.materials=e:"object"===typeof e&&(e.use?this.setFaceMaterial(e):this.setFaceMaterial(new h.Material(e))));
l&&l.length&&this.addFace(l);if(l&&u&&"object"===typeof u){g=null;if(u.length)if(u.length===l.length){e=0;for(c=u.length;e<c;e++)this.faces[e+n].setUV(u[e])}else q("Mesh error in part, face count: "+l.length+", uv count:"+u.length);else g=u.apply?u:new h.UVMapper(u);g&&g.apply(this,this.currentMaterial,this.currentSegment,n,this.faces.length-n)}if(l&&o)if(o.length&&o[0].length)if(o.length===l.length){this.genNormals=!1;u="number"===typeof o[0][0];e=0;for(c=o.length;e<c;e++)u?this.faces[e+n].setNormal(o[e]):
this.faces[e+n].setPointNormal(o[e])}else q("Mesh error in part, face count: "+l.length+", normals count:"+u.length);else q("Mesh error in part, unknown something where normals should be? ["+typeof o+"]");if(l&&m&&"object"===typeof m)if(m.length&&m.length===l.length){e=0;for(c=m.length;e<c;e++)this.faces[e+n].setColor(m[e]);this.materials[this.currentMaterial].colorMap=!0}else q("Mesh error in part, face count: "+l.length+", color count:"+m.length)}return this},showAllSegments:function(){for(var d in this.segment_state)this.segment_state.hasOwnProperty(d)&&
(this.segment_state[d]=!0)},hideAllSegments:function(){for(var d in this.segment_state)this.segment_state.hasOwnProperty(d)&&(this.segment_state[d]=!1)},setSegment:function(d,f){f!==m?this.segment_state[d]=f:this.currentSegment=d},addPoint:function(d){if(3!==d.length||"object"===typeof d[0])for(var f=0,e=d.length;f<e;f++)this.points.push(d[f]);else this.points.push(d);return this.points.length-1},getMaterialIndex:function(d){return this.materials.indexOf(d)},setFaceMaterial:function(d,f){var e;"number"==
typeof d?e=d:(e=this.materials.indexOf(d),-1===e&&(this.materials.push(d),e=this.materials.length-1));f!==m?this.faces[f]!==m&&(this.faces[f].material=e):this.currentMaterial=e;return this},addFace:function(d,f,e,c){if(d===m)return this.currentFace=this.faces.length,this.faces.push(new v),this.currentFace;if("number"!==typeof d[0]){f=0;for(e=d.length;f<e;f++)this.addFace(d[f])}else return f===m?(this.currentFace=this.faces.length,this.faces.push(new v)):(this.faces[f]===m&&(this.faces[f]=new v),this.currentFace=
f),"object"===typeof d&&(this.faces[this.currentFace].points=d),e!==m?this.setFaceMaterial(e,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial,this.faces[this.currentFace].segment=c!==m?c:this.currentSegment,this.currentFace},flipFaces:function(){for(var d=0,f=this.faces.length;d<f;d++)this.faces[d].flip()},triangulate:function(){for(var d,f,e,c,n,a,b=0,g=this.faces.length;b<g;b++)if(n=this.faces[b],c=n.points,4===c.length){if(a=this.faces[this.addFace([c[2],c.pop(),c[0]],
this.faces.length,n.material,n.segment)],a.normal=n.normal.slice(0),d=n.point_colors,4===d.length&&(a.point_colors=[d[2].slice(0),d.pop(),d[0].slice(0)]),f=n.uvs,4===f.length&&(a.uvs=[f[2].slice(0),f.pop(),f[0].slice(0)]),e=n.point_normals,4===e.length)a.point_normals=[e[2].slice(0),e.pop(),e[0].slice(0)]}else if(4<c.length){d=[];a=[];var l,u;f=[0,0,0];e=h.vec3;var m;l=0;for(u=c.length;l<u;l++)f=e.add(f,this.points[c[l]]),a[l]=this.points[c[l]];f[0]/=c.length;f[1]/=c.length;f[2]/=c.length;l=0;for(u=
c.length;l<u;l++)if(!e.equal(f,this.points[c[l]])){m=e.normalize(e.subtract(this.points[c[l]],f));break}l=n.normal=h.polygon.normal(a);a=m;var o=e.normalize(e.cross(m,l));l=0;for(u=c.length;l<u;l++){var s=e.subtract(f,this.points[c[l]]);d[l]=[e.dot(a,s),e.dot(o,s)]}o=h.polygon.triangulate2D(d);if(null!==o){d=n.point_colors;f=n.uvs;e=n.point_normals;l=0;for(u=o.length;l<u;l+=3)if(0===l?(this.faces[b]=new h.Face,a=this.faces[b]):a=this.faces[this.addFace()],a.material=n.material,a.segment=n.segment,
a.points=[c[o[l]],c[o[l+1]],c[o[l+2]]],a.normal=n.normal.slice(0),d.length&&(a.point_colors=[d[o[l]].slice(0),d[o[l+1]].slice(0),d[o[l+2]].slice(0)]),f.length&&(a.uvs=[f[o[l]].slice(0),f[o[l+1]].slice(0),f[o[l+2]].slice(0)]),e.length)a.point_normals=[e[o[l]].slice(0),e[o[l+1]].slice(0),e[o[l+2]].slice(0)]}else h.log("Unable to triangulate face "+b+", possible degenerate poly.")}return this},booleanAdd:function(d,f){var e=h.mat4,c=this.points.length,n,a,b,g;n=f;f=n===m?m:"array"===typeof n?n:"object"===
typeof n?n.getResult?n.getResult():n.position||n.rotation||n.scale?h.mat4.transform(n.position,n.rotation,n.scale):n:void 0;d.wireframeMaterial&&(this.wireframeMaterial=d.wireframeMaterial);d.pointMaterial&&(this.pointMaterial=d.pointMaterial);if(f!==m){a=f;n=0;for(b=d.points.length;n<b;n++)this.addPoint(e.vec3_multiply(d.points[n],a))}else{n=0;for(b=d.points.length;n<b;n++)this.addPoint([d.points[n][0],d.points[n][1],d.points[n][2]])}e=[];n=0;for(b=d.materials.length;n<b;n++)a=this.materials.indexOf(d.materials[n]),
-1===a?(this.materials.push(d.materials[n]),e[n]=this.materials.length-1):e[n]=a;n=0;for(b=d.faces.length;n<b;n++){var l=[];a=0;for(g=d.faces[n].points.length;a<g;a++)l.push(d.faces[n].points[a]+c);l=this.faces[this.addFace(l)];l.segment=d.faces[n].segment;l.material=e[d.faces[n].material];l.material===m&&(l.material=0);a=0;for(g=d.faces[n].uvs.length;a<g;a++)l.uvs[a]=[d.faces[n].uvs[a][0],d.faces[n].uvs[a][1]];a=0;for(g=d.faces[n].point_normals.length;a<g;a++)l.point_normals[a]=[d.faces[n].point_normals[a][0],
d.faces[n].point_normals[a][1],d.faces[n].point_normals[a][2]]}return this},calcFaceNormals:function(d,f){var e=h.vec3,c=h.triangle,n=0,a=this.faces.length,b,g=this.points,l;d&&(n=d);for(f&&(a=f+1);n<a;n++)b=this.faces[n],l=b.points,b.normal=3>l.length?[0,0,0]:e.normalize(c.normal(g[l[0]],g[l[1]],g[l[2]]));return this},getMaterial:function(d){if(!isNaN(parseInt(d,10)))return this.materials[f];for(var f=0,e=this.materials.length;f<e;f++)if(this.materials[f].name===d)return this.materials[f];return null},
getMaterials:function(){return this.materials},bindInstanceMaterials:function(d){this.instanceMaterials=d},calcNormals:function(d){var f=h.vec3,e=!1,c;this.genNormals=!0;this.dynamic&&(c=[],d=d||{});d!==m&&(c=[],e=!0);this.calcFaceNormals();var n,a,b,g,l=Array(this.points.length);n=0;for(g=l.length;n<g;n++)l[n]=[];g=this.faces.length;for(n=0;n<g;n++){b=this.faces[n].points.length;for(a=0;a<b;a++)l[this.faces[n].points[a]].push([n,a])}n=0;for(g=this.points.length;n<g;n++){var u=l[n].length;for(a=0;a<
u;a++){var o=1,x=l[n][a][0],s=l[n][a][1],q=this.materials.length?this.materials[this.faces[x].material].max_smooth:60,A=this.faces[x];e&&(c[x]===m&&(c[x]=[]),c[x][s]===m&&(c[x][s]=[]));var r=Array(3);r[0]=A.normal[0];r[1]=A.normal[1];r[2]=A.normal[2];if(0!==q)for(b=0;b<u;b++)if(a!==b){var B=l[n][b][0],t=this.faces[B],w=f.angle(t.normal,A.normal);if(w!==w||w*(180/Math.PI)<=q)e&&c[x][s].push(B),r[0]+=t.normal[0],r[1]+=t.normal[1],r[2]+=t.normal[2],o++}r[0]/=o;r[1]/=o;r[2]/=o;this.faces[x].point_normals[s]=
f.normalize(r)}}if(e){n=f=0;for(g=c.length;n<g;n++){a=0;for(b=c[n].length;a<b;a++)f+=c[n][a].length}d.faceCount||(d.faceCount=new Uint8Array(3*this.faces.length));d.faceNorm||(d.faceNorm=65535<this.faces.length?new Uint32Array(f):new Uint16Array(f));d.faceNormIdx||(d.faceNormIdx=65535<this.faces.length?new Uint32Array(this.faces.length):new Uint16Array(this.faces.length));n=f=0;for(g=this.faces.length;n<g;n++)for(a=0;3>a;a++)if(e=c[n][a],d.faceCount[3*n+a]=e?e.length:0,d.faceNormIdx[n]=f,e){b=0;for(e=
e.length;b<e;b++)d.faceNorm[f++]=c[n][a][b]}else f++;this.normalMapRef=d}return this},recalcNormals:function(d,f){if(this.genNormals){var e,c,n,a,b,g,l,u,o,h,f=f||{};if(d=d||this.normalMapRef){e=f.segments!==m?!0:!1;c=f.segments;this.calcFaceNormals();var s=0,q=0,A=0,r;if(e)for(var q=this.dynamicData.VBO.dynamicMap,B=d.faceNormIdx,t=0,w=c.length;t<w;t++)for(var z=q.segmentMap[c[t]],C=0,v=z.length;C<v;C++){e=z[C];o=this.faces[e];r=o.normal;s=B[e];for(j=0;3>j;j++){u=o.point_normals[j];b=r[0];g=r[1];
l=r[2];h=d.faceCount[3*e+j];n=0;for(iMax=h;n<iMax;n++)a=d.faceNorm[s+n],a=this.faces[a],a=a.normal,b+=a[0],g+=a[1],l+=a[2];h?(n=h+1,b/=n,g/=n,l/=n,n=Math.sqrt(b*b+g*g+l*l),b/=n,g/=n,l/=n,u[0]=b,u[1]=g,u[2]=l):A++}}else{e=0;for(c=this.faces.length;e<c;e++){o=this.faces[e];r=o.normal;for(j=0;3>j;j++){u=o.point_normals[j];b=r[0];g=r[1];l=r[2];h=d.faceCount[q++];n=0;for(iMax=h;n<iMax;n++)a=d.faceNorm[s++],a=this.faces[a],a=a.normal,b+=a[0],g+=a[1],l+=a[2];h?(n=h+1,b/=n,g/=n,l/=n,n=Math.sqrt(b*b+g*g+l*
l),b/=n,g/=n,l/=n,u[0]=b,u[1]=g,u[2]=l):A++}}}return this}}},removeDoubles:function(d){var f=[],e=[],c,n,a,b;c=0;for(n=this.points.length;c<n;c++){var g=-1,l=this.points[c];a=0;for(b=f.length;a<b;a++)if(h.vec3.equal(l,f[a],d)){g=a;break}-1!=g?e[c]=g:(e[c]=f.length,f.push(this.points[c]))}this.points=f;c=0;for(n=this.faces.length;c<n;c++){d=this.faces[c];a=0;for(b=d.points.length;a<b;a++)d.points[a]=e[d.points[a]]}return this},buildEdges:function(){var d,f,e,c,n=[],a=[];d=0;for(e=this.faces.length;d<
e;d++){var b=this.faces[d];f=0;for(c=b.points.length;f<c;f++){var g,l,u;u=b.segment;matId=b.material;f?(l=b.points[f],g=b.points[f-1]):(l=b.points[f],g=b.points[c-1]);n[g]=n[g]||{};n[g][matId]=n[g][matId]||{};n[g][matId][u]=n[g][matId][u]||{};!n[g][matId][u][l]&&(!n[l]||!n[l][matId][u][g])&&a.push([matId,u,g,l])}}this.edges=a;return this},subdivide:function(d,f){var e=h.vec3,f=f===m?!0:f;d===m&&(d=1);if(0!==d){var c,n,a,b,g,l={},u=[],o=[],x=this.points.length,s=this.faces.length,G=[],A=[],r=[],B=
[];c=0;for(a=s;c<a;c++)if(g=this.faces[c],g.points&&(3===g.points.length||4===g.points.length)){var t=[0,0,0];n=0;for(b=g.points.length;n<b;n++){var w=this.points[g.points[n]];t[0]+=w[0];t[1]+=w[1];t[2]+=w[2]}t[0]/=b;t[1]/=b;t[2]/=b;G[c]=this.addPoint(t);if(g.uvs.length===g.points.length){t=[0,0];n=0;for(b=g.uvs.length;n<b;n++)w=g.uvs[n],t[0]+=w[0],t[1]+=w[1];t[0]/=b;t[1]/=b;A[c]=t}if(g.point_colors.length===g.points.length){t=[0,0,0];n=0;for(b=g.point_colors.length;n<b;n++)w=g.point_colors[n],t[0]+=
w[0],t[1]+=w[1],t[2]+=w[2];t[0]/=b;t[1]/=b;t[2]/=b;r[c]=t}if(g.point_normals.length===g.points.length){t=[0,0,0];n=0;for(b=g.point_normals.length;n<b;n++)w=g.point_normals[n],t[0]+=w[0],t[1]+=w[1],t[2]+=w[2];t[0]/=b;t[1]/=b;t[2]/=b;B[c]=t}}c=0;for(a=this.faces.length;c<a;c++){g=this.faces[c];n=0;for(b=g.points.length;n<b;n++){var z,C;n?(z=n,C=n-1):(z=n,C=b-1);w=g.points[z];t=g.points[C];l[t]=l[t]||{};u[t]=u[t]||[];u[t].push(c);l[t][w]={face:c,a:t,b:w,fpa:z,fpb:C}}}for(c in l)if(l.hasOwnProperty(c))for(n in l[c])if(l[c].hasOwnProperty(n)){a=
l[c][n];g=l[n][c];if(g===m){q("Mesh.subdivide error. Hole at face #"+a.face+", Edge:["+a.fpa+"->"+a.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}a.edge_point||(b=e.multiply(e.add(this.points[a.a],this.points[a.b]),0.5),f?(t=e.multiply(e.add(this.points[G[a.face]],this.points[G[g.face]]),0.5),a.edge_point=e.multiply(e.add(b,t),0.5)):a.edge_point=b,g.edge_point=a.edge_point,a.edge_avg=b,g.edge_avg=b,a.ep_idx=this.addPoint(a.edge_point),g.ep_idx=a.ep_idx);o[a.a]=o[a.a]||
[];o[a.a].push(a.edge_avg);b=this.faces[a.face].uvs;b.length&&(g=b[a.fpa],b=b[a.fpb],a.uv=[(g[0]+b[0])/2,(g[1]+b[1])/2]);g=this.faces[a.face].point_colors;g.length&&(a.color=e.multiply(e.add(g[a.fpa],g[a.fpb]),0.5));g=this.faces[a.face].point_normals;g.length&&(a.normal=e.normalize(e.multiply(e.add(g[a.fpa],g[a.fpb]),0.5)))}if(f){g=[];c=0;for(a=x;c<a;c++)if(t=[0,0,0],u[c]){n=0;for(b=u[c].length;n<b;n++)w=this.points[G[u[c][n]]],t[0]+=w[0],t[1]+=w[1],t[2]+=w[2];t[0]/=b;t[1]/=b;t[2]/=b;g[c]=t}t=[];
c=0;for(a=x;c<a;c++)if(w=[0,0,0],o[c]){n=0;for(b=o[c].length;n<b;n++)z=o[c][n],w[0]+=z[0],w[1]+=z[1],w[2]+=z[2];w[0]/=b;w[1]/=b;w[2]/=b;t[c]=w}c=0;for(a=x;c<a;c++)u[c]&&(x=u[c].length,n=1/x,o=2/x,x=e.multiply(this.points[c],(x-3)/x),x=e.add(x,e.multiply(g[c],n)),x=e.add(x,e.multiply(t[c],o)),this.points[c]=x)}for(c=0;c<s;c++)if(g=this.faces[c],!(3!==g.points.length&&4!==g.points.length))if(e=g.points.slice(0),u=g.uvs.slice(0),n=g.point_colors.slice(0),o=g.point_normals.slice(0),x=u.length===e.length,
a=n.length===e.length,b=o.length===e.length,g=g.material,3===e.length){if(this.setFaceMaterial(g),t=l[e[0]][e[1]],w=l[e[2]][e[0]],this.addFace([e[0],t.ep_idx,G[c],w.ep_idx],c),x&&(this.faces[c].uvs=[u[0],t.uv,A[c],w.uv]),a&&(this.faces[c].point_colors=[n[0],t.color,r[c],w.color]),b&&(this.faces[c].point_normals=[o[0],t.normal,B[c],w.normal]),t=l[e[1]][e[2]],w=l[e[0]][e[1]],g=this.addFace([e[1],t.ep_idx,G[c],w.ep_idx]),x&&(this.faces[g].uvs=[u[1],t.uv,A[c],w.uv]),a&&(this.faces[g].point_colors=[n[1],
t.color,r[c],w.color]),b&&(this.faces[g].point_normals=[o[1],t.normal,B[c],w.normal]),t=l[e[2]][e[0]],w=l[e[1]][e[2]],g=this.addFace([e[2],t.ep_idx,G[c],w.ep_idx]),x&&(this.faces[g].uvs=[u[2],t.uv,A[c],w.uv]),a&&(this.faces[g].point_colors=[n[2],t.color,r[c],w.color]),b)this.faces[g].point_normals=[o[2],t.normal,B[c],w.normal]}else if(this.setFaceMaterial(g),t=l[e[0]][e[1]],w=l[e[3]][e[0]],this.addFace([e[0],t.ep_idx,G[c],w.ep_idx],c),x&&(this.faces[c].uvs=[u[0],t.uv,A[c],w.uv]),a&&(this.faces[c].point_colors=
[n[0],t.color,r[c],w.color]),b&&(this.faces[c].point_normals=[o[0],t.normal,B[c],w.normal]),t=l[e[1]][e[2]],w=l[e[0]][e[1]],g=this.addFace([e[1],t.ep_idx,G[c],w.ep_idx]),x&&(this.faces[g].uvs=[u[1],t.uv,A[c],w.uv]),a&&(this.faces[g].point_colors=[n[1],t.color,r[c],w.color]),b&&(this.faces[g].point_normals=[o[1],t.normal,B[c],w.normal]),t=l[e[2]][e[3]],w=l[e[1]][e[2]],g=this.addFace([e[2],t.ep_idx,G[c],w.ep_idx]),x&&(this.faces[g].uvs=[u[2],t.uv,A[c],w.uv]),a&&(this.faces[g].point_colors=[n[2],t.color,
r[c],w.color]),b&&(this.faces[g].point_normals=[o[2],t.normal,B[c],w.normal]),t=l[e[3]][e[0]],w=l[e[2]][e[3]],g=this.addFace([e[3],t.ep_idx,G[c],w.ep_idx]),x&&(this.faces[g].uvs=[u[3],t.uv,A[c],w.uv]),a&&(this.faces[g].point_colors=[n[3],t.color,r[c],w.color]),b)this.faces[g].point_normals=[o[3],t.normal,B[c],w.normal];d--;if(0!==d)this.subdivide(d,f);else return this}},removeInternals:function(){var d,f,e,c,n,a={},b=this.faces.length,g,l,u,o;d=0;for(e=this.faces.length;d<e;d++){n=this.faces[d];f=
0;for(c=n.points.length;f<c;f++)f?(u=f,o=f-1):(u=f,o=c-1),g=n.points[u],l=n.points[o],a[g]=a[g]||{},a[g][l]===m?a[g][l]=[d]:a[g][l].push(d)}e=function(b){return-1!==a[l][g].indexOf(b)};for(d=0;d<b;d++){n=this.faces[d];var h=null;f=0;for(c=n.points.length;f<c;f++)f?(u=f,o=f-1):(u=f,o=c-1),g=n.points[u],l=n.points[o],h=h?h.filter(e):a[l][g];h.length&&(this.faces.splice(d,1),b--,d--)}return this},prepare:function(d){d===m&&(d=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads();
this.genNormals&&this.calcNormals();this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();d&&!this.dynamic&&this.clean();return this},clean:function(){var d,f;d=0;for(f=this.points.length;d<f;d++)delete this.points[d],this.points[d]=null;this.points=[];d=0;for(f=this.faces.length;d<f;d++)delete this.faces[d].points,delete this.faces[d].point_normals,delete this.faces[d].uvs,delete this.faces[d].normal,delete this.faces[d],this.faces[d]=null;this.faces=[];return this},compileMap:function(d){var f=
h.vec3,e=h.vec2;d===m&&(d=1.0E-5);var c={segments:[],bounds:[]},n=[],a,b,g,l,u,o,x,s;this.materials.length||this.materials.push(new h.Material);a=0;for(o=this.materials.length;a<o;a++)n[a]=[];a=0;for(o=this.faces.length;a<o;a++)3===this.faces[a].points.length&&(g=this.faces[a].material,l=this.faces[a].segment,n[g][l]===m&&(n[g][l]=[],c.segments.push(l)),n[g][l].push(a));var q=[],A=0,r=!1,B=!1,t=!1,w;a=0;for(o=n.length;a<o;a++)for(b in n[a])if(n[a].hasOwnProperty(b))for(g=0;g<n[a][b].length;g++)w=
n[a][b][g],r=r||0!==this.faces[w].uvs.length,B=B||0!==this.faces[w].point_normals.length,t=t||0!==this.faces[w].point_colors.length;if(r)for(a=0;a<this.faces.length;a++)if(!this.faces[a].uvs.length)for(b=0;b<this.faces[a].points.length;b++)this.faces[a].uvs.push([0,0]);if(B)for(a=0;a<this.faces.length;a++)if(!this.faces[a].point_normals.length)for(b=0;b<this.faces[a].points.length;b++)this.faces[a].point_normals.push([0,0,0]);if(t)for(a=0;a<this.faces.length;a++)if(!this.faces[a].point_colors.length)for(b=
0;b<this.faces[a].points.length;b++)this.faces[a].point_colors.push([0,0,0]);a=0;for(o=n.length;a<o;a++)for(b in n[a])if(n[a].hasOwnProperty(b)){g=0;for(x=n[a][b].length;g<x;g++){w=n[a][b][g];for(l=0;3>l;l++){var z=this.faces[w].points[l],C=-1;if(q[z]!==m){u=0;for(s=q[z].length;u<s;u++){var v=q[z][u][0],F=q[z][u][1],C=q[z][u][2];B&&(C=f.equal(this.faces[v].point_normals[F],this.faces[w].point_normals[l],d)?C:-1);r&&(C=e.equal(this.faces[v].uvs[F],this.faces[w].uvs[l],d)?C:-1);t&&(C=f.equal(this.faces[v].point_colors[F],
this.faces[w].point_colors[l],d)?C:-1)}}-1!==C?(c.elements===m&&(c.elements=[]),c.elements[a]===m&&(c.elements[a]=[]),c.elements[a][b]===m&&(c.elements[a][b]=[]),c.elements[a][b].push(C)):(c.points===m&&(c.points=[]),c.points.push(z),0===c.bounds.length?(c.bounds[0]=[this.points[z][0],this.points[z][1],this.points[z][2]],c.bounds[1]=[this.points[z][0],this.points[z][1],this.points[z][2]]):(this.points[z][0]<c.bounds[0][0]&&(c.bounds[0][0]=this.points[z][0]),this.points[z][1]<c.bounds[0][1]&&(c.bounds[0][1]=
this.points[z][1]),this.points[z][2]<c.bounds[0][2]&&(c.bounds[0][2]=this.points[z][2]),this.points[z][0]>c.bounds[1][0]&&(c.bounds[1][0]=this.points[z][0]),this.points[z][1]>c.bounds[1][1]&&(c.bounds[1][1]=this.points[z][1]),this.points[z][2]>c.bounds[1][2]&&(c.bounds[1][2]=this.points[z][2])),B&&(c.normals===m&&(c.normals=[]),c.normals.push([w,l])),t&&(c.colors===m&&(c.colors=[]),c.colors.push([w,l])),r&&(c.uvs===m&&(c.uvs=[]),c.uvs.push([w,l])),c.elements===m&&(c.elements=[]),c.elements[a]===m&&
(c.elements[a]=[]),c.elements[a][b]===m&&(c.elements[a][b]=[]),c.elements[a][b].push(A),q[z]===m&&(q[z]=[]),q[z].push([w,l,A]),A++)}}}if(this.edges){c.line_elements=[];a=0;for(o=this.edges.length;a<o;a++)f=this.edges[a],g=f[0],l=f[1],d=f[2],f=f[3],c.line_elements[g]=c.line_elements[g]||[],c.line_elements[g][l]=c.line_elements[g][l]||[],c.line_elements[g][l].push(q[d][0][2]),c.line_elements[g][l].push(q[f][0][2])}c.dynamic=this.dynamic;return c},compileVBO:function(d,f,e,c,n,a,b,g){"object"==typeof f?
(f=f.element!==m?f.element:!0,e=f.vertex!==m?f.vertex:!0,a=f.color!==m?f.color:!0,c=f.normal!==m?f.normal:!0,n=f.uv!==m?f.uv:!0,b=f.lines!==m?f.lines:!!d.line_elements,g=f.dynamic!==m?f.dynamic:d.dynamic):(f===m&&(f=!0),e===m&&(e=!0),a===m&&(a=!0),c===m&&(c=!0),n===m&&(n=!0),b===m&&(b=!!d.line_elements),g===m&&(g=d.dynamic));var l={},u,o,h,s,q,A,r,B,t;u=d.points.length||d.uvs.length||d.normals.length||d.colors.length;var w=65535<u;g&&(t={points:w?new Uint32Array(d.points.length):new Uint16Array(d.points.length),
face_points:w?new Uint32Array(2*d.points.length):new Uint16Array(2*d.points.length),segments:null},l.dynamicMap=t,l.dynamic=!0);if(e=d.points&&e){l.vbo_points=new Float32Array(3*u);s=0;for(A=u;s<A;s++)h=d.points[s],l.vbo_points[3*s]=this.points[h][0],l.vbo_points[3*s+1]=this.points[h][1],l.vbo_points[3*s+2]=this.points[h][2],g&&(t.points[s]=h)}if(g){o=d.normals||d.colors||d.uvs;s=0;for(A=o.length;s<A;s++)h=o[s],t.face_points[2*s]=h[0],t.face_points[2*s+1]=h[1]}if(c=d.normals&&c){l.vbo_normals=new Float32Array(3*
u);s=o=0;for(A=u;s<A;s++)h=d.normals[s],l.vbo_normals[o++]=this.faces[h[0]].point_normals[h[1]][0],l.vbo_normals[o++]=this.faces[h[0]].point_normals[h[1]][1],l.vbo_normals[o++]=this.faces[h[0]].point_normals[h[1]][2]}if(a=d.colors&&a){l.vbo_colors=new Float32Array(3*u);s=o=0;for(A=u;s<A;s++)h=d.colors[s],l.vbo_colors[o++]=this.faces[h[0]].point_colors[h[1]][0],l.vbo_colors[o++]=this.faces[h[0]].point_colors[h[1]][1],l.vbo_colors[o++]=this.faces[h[0]].point_colors[h[1]][2]}if(n=d.uvs&&n){u=d.uvs.length;
l.vbo_uvs=new Float32Array(2*u);s=o=0;for(A=u;s<A;s++)h=d.uvs[s],l.vbo_uvs[o++]=this.faces[h[0]].uvs[h[1]][0],l.vbo_uvs[o++]=this.faces[h[0]].uvs[h[1]][1]}u=[];h=0;if(f){l.elements_ref=[];l.vbo_elements=[];s=0;for(A=d.elements.length;s<A;s++)for(q in l.elements_ref[s]=[],f=0,d.elements[s])if(d.elements[s].hasOwnProperty(q)){B=d.elements[s][q];o=0;for(r=B.length;o<r;o++)u.push(B[o]);l.elements_ref[s][f]=[q|0,B.length|0];f++}h=u.length/3;w||(l.vbo_elements=new Uint16Array(u))}l.segments=d.segments;
l.bounds=d.bounds;if(b){if(w){if(l.vbo_lines=[],c&&(l.vbo_line_normals=[]),n&&(l.vbo_line_uvs=[]),a)l.vbo_line_colors=[]}else l.vbo_line_elements=[];l.line_elements_ref=[];s=0;for(A=d.line_elements.length;s<A;s++)for(q in l.line_elements_ref[s]=[],f=0,d.line_elements[s])if(d.line_elements[s].hasOwnProperty(q)){B=d.line_elements[s][q];o=0;for(r=B.length;o<r;o++)if(w){if(b=B[o],l.vbo_lines.push(l.vbo_points[3*b]),l.vbo_lines.push(l.vbo_points[3*b+1]),l.vbo_lines.push(l.vbo_points[3*b+2]),c&&(l.vbo_line_normals.push(l.vbo_normals[3*
b]),l.vbo_line_normals.push(l.vbo_normals[3*b+1]),l.vbo_line_normals.push(l.vbo_normals[3*b+2])),a&&(l.vbo_line_colors.push(l.vbo_colors[3*b]),l.vbo_line_colors.push(l.vbo_colors[3*b+1]),l.vbo_line_colors.push(l.vbo_colors[3*b+2])),n)l.vbo_line_uvs.push(l.vbo_uvs[2*b]),l.vbo_line_uvs.push(l.vbo_uvs[2*b+1])}else l.vbo_line_elements.push(B[o]);l.line_elements_ref[s][f]=[q|0,B.length|0];f++}if(w){if(l.vbo_lines=new Float32Array(l.vbo_lines),c&&(l.vbo_line_normals=new Float32Array(l.vbo_line_normals)),
n&&(l.vbo_line_uvs=new Float32Array(l.vbo_line_uvs)),a)l.vbo_line_colors=new Float32Array(l.vbo_line_colors)}else l.vbo_line_elements=new Uint16Array(l.vbo_line_elements)}if(w){console.log("Mesh "+(this.name?this.name+" ":"")+"exceeded element index limit -- unrolling "+h+" triangles..");var z,v,D,F;e&&(z=new Float32Array(9*h));c&&(v=new Float32Array(9*h));n&&(D=new Float32Array(6*h));a&&(F=new Float32Array(9*h));var y,I;g&&(y=new Uint32Array(6*h),I=new Uint32Array(3*h));s=0;for(A=h;s<A;s++)if(q=
9*s,w=3*u[3*s],b=3*u[3*s+1],h=3*u[3*s+2],g&&(f=3*s,o=2*f,y[o]=t.face_points[2*u[f]],y[o+1]=t.face_points[2*u[f]+1],y[o+2]=t.face_points[2*u[f+1]],y[o+3]=t.face_points[2*u[f+1]+1],y[o+4]=t.face_points[2*u[f+2]],y[o+5]=t.face_points[2*u[f+2]+1],I[f]=t.points[u[f]],I[f+1]=t.points[u[f+1]],I[f+2]=t.points[u[f+2]]),e&&(z[q]=l.vbo_points[w],z[q+1]=l.vbo_points[w+1],z[q+2]=l.vbo_points[w+2],z[q+3]=l.vbo_points[b],z[q+4]=l.vbo_points[b+1],z[q+5]=l.vbo_points[b+2],z[q+6]=l.vbo_points[h],z[q+7]=l.vbo_points[h+
1],z[q+8]=l.vbo_points[h+2]),c&&(v[q]=l.vbo_normals[w],v[q+1]=l.vbo_normals[w+1],v[q+2]=l.vbo_normals[w+2],v[q+3]=l.vbo_normals[b],v[q+4]=l.vbo_normals[b+1],v[q+5]=l.vbo_normals[b+2],v[q+6]=l.vbo_normals[h],v[q+7]=l.vbo_normals[h+1],v[q+8]=l.vbo_normals[h+2]),n&&(f=2*u[3*s],o=2*u[3*s+1],r=2*u[3*s+2],D[6*s]=l.vbo_uvs[f],D[6*s+1]=l.vbo_uvs[f+1],D[6*s+2]=l.vbo_uvs[o],D[6*s+3]=l.vbo_uvs[o+1],D[6*s+4]=l.vbo_uvs[r],D[6*s+5]=l.vbo_uvs[r+1]),a)F[q]=l.vbo_colors[w],F[q+1]=l.vbo_colors[w+1],F[q+2]=l.vbo_colors[w+
2],F[q+3]=l.vbo_colors[b],F[q+4]=l.vbo_colors[b+1],F[q+5]=l.vbo_colors[b+2],F[q+6]=l.vbo_colors[h],F[q+7]=l.vbo_colors[h+1],F[q+8]=l.vbo_colors[h+2];e&&(l.vbo_points=z);c&&(l.vbo_normals=v);n&&(l.vbo_uvs=D);a&&(l.vbo_colors=F);g&&(delete t.points,delete t.face_points,t.points=I,t.face_points=y);l.unrolled=!0}else l.unrolled=!1;if(g&&1<d.segments.length){d=[];o=t.points;s=0;for(A=o.length;s<A;s++)e=this.faces[t.face_points[2*s]].segment||0,d[e]===m&&(d[e]=[]),d[e].push(s);l.dynamicMap.segmentMap=d}return l},
updateVBO:function(d,f){if(!d.dynamic)return!1;var e,c,n=d.dynamicMap,a=f.points&&!!d.vbo_points,b=f.normals&&!!d.vbo_normals,g=f.uvs&&!!d.vbo_uvs,l=f.colors&&!!d.vbo_colors;c=f.segments;var u,o,h;if(f.segments!==m)for(var s=0,q=c.length;s<q;s++)for(var A=n.segmentMap[c[s]],r=0,B=A.length;r<B;r++){if(e=A[r],o=this.faces[n.face_points[2*e]],h=n.face_points[2*e+1],a&&(u=this.points[n.points[e]],d.vbo_points[3*e]=u[0],d.vbo_points[3*e+1]=u[1],d.vbo_points[3*e+2]=u[2]),b&&(u=o.point_normals[h],d.vbo_normals[3*
e]=u[0],d.vbo_normals[3*e+1]=u[1],d.vbo_normals[3*e+2]=u[2]),l&&(u=o.point_colors[h],d.vbo_colors[3*e]=u[0],d.vbo_colors[3*e+1]=u[1],d.vbo_colors[3*e+2]=u[2]),g)u=o.uvs[h],d.vbo_uvs[2*e]=u[0],d.vbo_uvs[2*e+1]=u[1]}else{e=0;for(c=n.points.length;e<c;e++){o=this.faces[n.face_points[2*e]];h=n.face_points[2*e+1];if(!o){console.log(n.face_points[2*e]);return}a&&(u=this.points[n.points[e]],d.vbo_points[3*e]=u[0],d.vbo_points[3*e+1]=u[1],d.vbo_points[3*e+2]=u[2]);b&&(u=o.point_normals[h],d.vbo_normals[3*
e]=u[0],d.vbo_normals[3*e+1]=u[1],d.vbo_normals[3*e+2]=u[2]);l&&(u=o.point_colors[h],d.vbo_colors[3*e]=u[0],d.vbo_colors[3*e+1]=u[1],d.vbo_colors[3*e+2]=u[2]);g&&(u=o.uvs[h],d.vbo_uvs[2*e]=u[0],d.vbo_uvs[2*e+1]=u[1])}}return this},rebufferVBO:function(d,f,e){var c=o.gl;e.points&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_points),c.bufferData(c.ARRAY_BUFFER,d.vbo_points,c.DYNAMIC_DRAW));e.normals&&d.vbo_normals&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_normals),c.bufferData(c.ARRAY_BUFFER,d.vbo_normals,c.DYNAMIC_DRAW));
e.uvs&&d.vbo_uvs&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_uvs),c.bufferData(c.ARRAY_BUFFER,d.vbo_uvs,c.DYNAMIC_DRAW));e.colors&&d.vbo_colors&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_colors),c.bufferData(c.ARRAY_BUFFER,d.vbo_colors,c.DYNAMIC_DRAW));c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(d,f){var e=o.gl,c={};f===m&&(f={});c.gl_points=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c.gl_points);e.bufferData(e.ARRAY_BUFFER,d.vbo_points,e.STATIC_DRAW);d.vbo_normals?(c.gl_normals=e.createBuffer(),
e.bindBuffer(e.ARRAY_BUFFER,c.gl_normals),e.bufferData(e.ARRAY_BUFFER,d.vbo_normals,e.STATIC_DRAW)):c.gl_normals=f.gl_normals?f.gl_normals:null;d.vbo_uvs?(c.gl_uvs=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,c.gl_uvs),e.bufferData(e.ARRAY_BUFFER,d.vbo_uvs,e.STATIC_DRAW)):c.gl_uvs=f.gl_uvs?f.gl_uvs:null;d.vbo_colors?(c.gl_colors=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,c.gl_colors),e.bufferData(e.ARRAY_BUFFER,d.vbo_colors,e.STATIC_DRAW)):c.gl_colors=f.gl_colors?f.gl_colors:null;!d.vbo_elements&&
f.gl_elements?(c.gl_elements=f.gl_elements,c.elements_ref=f.elements_ref):(d.vbo_elements.length&&(c.gl_elements=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,c.gl_elements),e.bufferData(e.ELEMENT_ARRAY_BUFFER,d.vbo_elements,e.STATIC_DRAW)),c.elements_ref=d.elements_ref);!d.vbo_line_elements&&f.gl_line_elements?(c.gl_line_elements=f.gl_line_elements,c.line_elements_ref=f.line_elements_ref):d.vbo_line_elements&&(c.gl_line_elements=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,c.gl_line_elements),
e.bufferData(e.ELEMENT_ARRAY_BUFFER,d.vbo_line_elements,e.STATIC_DRAW),c.line_elements_ref=d.line_elements_ref);!d.vbo_lines&&f.gl_lines?c.gl_lines=f.gl_lines:d.vbo_lines?(c.gl_lines=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,c.gl_lines),e.bufferData(e.ARRAY_BUFFER,d.vbo_lines,e.STATIC_DRAW),c.line_elements_ref=d.line_elements_ref):c.gl_lines=null;!d.vbo_line_colors&&f.gl_line_colors?c.gl_line_colors=f.gl_line_colors:d.vbo_line_colors?(c.gl_line_colors=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,
c.gl_line_colors),e.bufferData(e.ARRAY_BUFFER,d.vbo_line_colors,e.STATIC_DRAW)):c.gl_line_colors=null;!d.vbo_line_uvs&&f.gl_line_uvs?c.gl_line_uvs=f.gl_line_uvs:d.vbo_line_uvs?(c.gl_line_uvs=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,c.gl_line_uvs),e.bufferData(e.ARRAY_BUFFER,d.vbo_line_uvs,e.STATIC_DRAW)):c.gl_line_uvs=null;!d.vbo_line_normals&&f.gl_line_normals?c.gl_line_normals=f.gl_line_normals:d.vbo_line_normals?(c.gl_line_normals=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,c.gl_line_normals),
e.bufferData(e.ARRAY_BUFFER,d.vbo_line_normals,e.STATIC_DRAW)):c.gl_line_normals=null;c.segments=d.segments;c.bounds=d.bounds;c.unrolled=d.unrolled;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return c},update:function(d){var d=d||{},f=!0;d.points!==m&&(f=d.points);var e=d.uvs||d.uv||d.texture||d.all||!1,c=!0;d.normals!==m&&(c=d.normals);var n=d.colors||d.color||d.all||!1,d=d.segments||d.segment;d!==m&&d.length===m&&(d=[d]);if(!this.dynamic)return q("Mesh not defined as dynamic, cannot update."),!1;
c&&this.normalMapRef&&this.recalcNormals(m,{segments:d});f={points:f,uvs:e,normals:c,colors:n,segments:d};this.updateVBO(this.dynamicData.VBO,f);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,f)},bindBuffer:function(d){null===this.originBuffer&&(this.originBuffer=d);this.compiled=d;this.segment_state=[];for(var f=0,e=d.segments.length;f<e;f++)this.segment_state[d.segments[f]]=!0;this.bb=d.bounds},compile:function(d){if(0<this.faces.length&&0<this.points.length){var d=this.compileVBO(this.compileMap(d)),
f=this.bufferVBO(d);this.bindBuffer(f);if(this.dynamic){this.sourcePoints=[];for(var e=0,c=this.points.length;e<c;e++)this.sourcePoints[e]=this.points[e].slice(0);this.dynamicData={VBO:d,buffer:f}}}return this},addMorphTarget:function(d){null===this.morphTargets&&(this.morphTargets=[]);this.morphTargets.push(d)},setMorphSource:function(d){this.morphSourceIndex!==d&&(this.morphSourceIndex=d,this.bindBuffer(this.morphTargets[d]))},setMorphTarget:function(d){this.morphTargetIndex!==d&&(this.morphTargetIndex=
d,this.morphTarget=this.morphTargets[d])},setMorphWeight:function(d){this.morphWeight=d},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};r.prototype.triangulateQuads=r.prototype.triangulate;return{Mesh:r,Face:v}});
CubicVR.RegisterModule("UVMapper",function(h){function v(e){e=h.get(e)||{};this.rotation=e.rotation===r?[0,0,0]:e.rotation;this.scale=e.scale===r?[1,1,1]:e.scale;this.center=e.center===r?[0,0,0]:e.center;this.projection_mode=e.projectionMode===r?m.uv.projection.PLANAR:h.parseEnum(m.uv.projection,e.projectionMode);this.projection_axis=e.projectionAxis===r?m.uv.axis.X:h.parseEnum(m.uv.axis,e.projectionAxis);this.wrap_w_count=e.wrapW===r?1:e.wrapW;this.wrap_h_count=e.wrapH===r?1:e.wrapH}var r=h.undef,
m=h.enums,o=2*Math.PI,q=Math.PI/2;m.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var d=function(e,c,d){return 0===e&&0===d?0:0===d?0>e?q:-q:0>d?-Math.atan(e/d)+Math.PI:-Math.atan(e/d)},f=function(e,c,d){var a;0===e&&0===d?(a=0,e=0!==c?0>c?-q:q:0):(a=0===d?0>e?q:-q:0>d?-Math.atan(e/d)+Math.PI:-Math.atan(e/d),e=Math.sqrt(e*e+d*d),e=0===e?0>c?-q:q:Math.atan(c/e));return[a,e]};v.prototype={setRotation:function(e){this.rotation=e},setScale:function(e){this.scale=
e},setCenter:function(e){this.center=e},setProjectionAxis:function(e){this.projection_axis=e},setProjectionMode:function(e){this.projection_mode=e},setWrapW:function(e){this.wrap_w_count=e},setWrapH:function(e){this.wrap_h_count=e},apply:function(e,c,n,a,b){var g=h.mat4,l,u,E,x,s,G=new h.Transform,A=!1,H=null;if(this.center[0]||this.center[1]||this.center[2])G.translate(-this.center[0],-this.center[1],-this.center[2]),A=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
G.rotate(this.rotation[2],0,0,1),this.rotation[1]&&G.rotate(this.rotation[1],0,1,0),this.rotation[2]&&G.rotate(this.rotation[0],1,0,0),A=!0;A&&(H=G.getResult());"object"===typeof c&&(c=e.materials.indexOf(c));var G=0,B=e.faces.length;a&&(G=a);for(b&&(B=b+1);G<B;G++)if(e.faces[G].material===c&&!(n!==r&&e.faces[G].segment!==n)){var t,w,z;if(this.projection_mode===m.uv.projection.CUBIC||this.projection_mode===m.uv.projection.SKY)t=Math.abs(e.faces[G].normal[0]),w=Math.abs(e.faces[G].normal[1]),z=Math.abs(e.faces[G].normal[2]);
for(var a=[],b=0,v=e.faces[G].points.length;b<v;b++){u=e.faces[G].points[b];var D=e.faces[G].points[(b+1)%3],F=e.faces[G].points[(b+2)%3];l=e.points[u];var y=e.points[D],I=e.points[F],J;A&&(l=g.vec3_multiply(l,H));J=this.projection_mode;if(J===m.uv.projection.SKY)u=e.sky_mapping,t>=w&&t>=z&&(E=l[2]/this.scale[2]+this.scale[2]/2,x=-l[1]/this.scale[1]+this.scale[1]/2,0>e.faces[G].normal[0]?(E=(u[2][2]-u[2][0])*(1-E),x=1-(u[2][3]-u[2][1])*x,E+=u[2][0],x+=u[2][1]):(E*=u[3][2]-u[3][0],x=1-(u[3][3]-u[3][1])*
x,E+=u[3][0],x+=u[3][1])),w>=t&&w>=z&&(E=l[0]/this.scale[0]+this.scale[0]/2,x=-l[2]/this.scale[2]+this.scale[2]/2,0>e.faces[G].normal[1]?(E*=u[1][2]-u[1][0],x=1-(u[1][3]-u[1][1])*x,E+=u[1][0],x-=u[1][1]):(E*=u[0][2]-u[0][0],x=1-(u[0][3]-u[0][1])*x,E+=u[0][0],x-=u[0][1])),z>=t&&z>=w&&(E=l[0]/this.scale[0]+this.scale[0]/2,x=l[1]/this.scale[1]+this.scale[1]/2,0>e.faces[G].normal[2]?(E*=u[4][2]-u[4][0],x=1-(u[4][3]-u[4][1])*(1-x),E+=u[4][0],x-=u[4][1]):(E=(u[5][2]-u[5][0])*(1-E),x=1-(u[5][3]-u[5][1])*
(1-x),E+=u[5][0],x+=u[5][1])),e.faces[G].setUV([E,x],b);else if(J===m.uv.projection.CUBIC)t>=w&&t>=z&&(E=l[2]/this.scale[2]+0.5,x=l[1]/this.scale[1]+0.5),w>=t&&w>=z&&(E=-l[0]/this.scale[0]+0.5,x=l[2]/this.scale[2]+0.5),z>=t&&z>=w&&(E=-l[0]/this.scale[0]+0.5,x=l[1]/this.scale[1]+0.5),0<e.faces[G].normal[0]&&(E=-E),0>e.faces[G].normal[1]&&(E=-E),0<e.faces[G].normal[2]&&(E=-E),e.faces[G].setUV([E,x],b);else if(J===m.uv.projection.PLANAR)E=this.projection_axis===m.uv.axis.X?l[2]/this.scale[2]+0.5:-l[0]/
this.scale[0]+0.5,x=this.projection_axis===m.uv.axis.Y?l[2]/this.scale[2]+0.5:l[1]/this.scale[1]+0.5,e.faces[G].setUV([E,x],b);else{if(J===m.uv.projection.CYLINDRICAL)J=this.projection_axis,J===m.uv.axis.X?(s=d(l[2],l[0],-l[1]),x=-l[0]/this.scale[0]+0.5):J===m.uv.axis.Y?(s=d(-l[0],l[1],l[2]),x=-l[1]/this.scale[1]+0.5):J===m.uv.axis.Z&&(s=d(-l[0],l[2],-l[1]),x=-l[2]/this.scale[2]+0.5),s=1-s/o,1!==this.wrap_w_count&&(s*=this.wrap_w_count),l=s,u=x;else if(J===m.uv.projection.SPHERICAL){var K,L,M;J=this.projection_axis;
J===m.uv.axis.X?(K=a[u]?a[u]:f(l[2],l[0],-l[1]),a[u]||(a[u]=K),L=a[D]?a[D]:f(y[2],y[0],-y[1]),a[D]||(a[D]=L),M=a[F]?a[F]:f(I[2],I[0],-I[1]),a[F]||(a[F]=M)):J===m.uv.axis.Y?(K=a[u]?a[u]:f(l[0],-l[1],l[2]),a[u]||(a[u]=K),L=a[D]?a[D]:f(y[0],-y[1],y[2]),a[D]||(a[D]=L),M=a[F]?a[F]:f(I[0],-I[1],I[2]),a[F]||(a[F]=M)):J===m.uv.axis.Z&&(K=a[u]?a[u]:f(-l[0],l[2],-l[1]),a[u]||(a[u]=K),L=a[D]?a[D]:f(-y[0],y[2],-y[1]),a[D]||(a[D]=L),M=a[F]?a[F]:f(-I[0],I[2],-I[1]),a[F]||(a[F]=M));Math.abs(K[0]-L[0])>q&&Math.abs(K[0]-
M[0])>q&&(K[0]=K[0]>L[0]&&K[0]>M[0]?K[0]-o:K[0]+o);Math.abs(K[1]-L[1])>q&&Math.abs(K[1]-M[1])>q&&(K[1]=K[1]>L[1]&&K[1]>M[1]?K[1]-o:K[1]+o);s=1-K[0]/o;u=0.5-K[1]/Math.PI;1!==this.wrap_w_count&&(s*=this.wrap_w_count);1!==this.wrap_h_count&&(u*=this.wrap_h_count);l=s}else u=l=0;e.faces[G].setUV([l,u],b)}}}return this}};return{UVMapper:v}});
CubicVR.RegisterModule("Renderer",function(h){var v=h.undef;return{renderObject:function(r,m,o,q,d,f,e,c){var n=!1,d=d||!1,f=f||!1;if(null!==r.compiled){var a=0,b=h.GLCore.gl,g,l=q===v?0:q.length,u,E=0,x,s=null,G=r.instanceMaterials||r.materials,e=(r.wireframe||e)&&r.compiled.line_elements_ref,c=(r.pointMode||c)&&r.compiled.line_elements_ref,A=b.TRIANGLES;e?A=b.LINES:c&&(A=b.POINTS);var H=e||c?r.compiled.line_elements_ref:r.compiled.elements_ref,B=!1,t,w,z;b.depthFunc(b.LEQUAL);o===v&&(o=cubicvr_identity);
for(var C=0,D=H.length;C<D;C++){var s=e&&r.wireframeMaterial?r.wireframeMaterial:c&&r.pointModeMaterial?r.pointModeMaterial:G[C],F=0,E=!1;if(1>s.opacity&&d)n=!0;else if(!(f&&1<=s.opacity)){1!==s.opacity?(b.enable(b.BLEND),b.depthMask(0),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA)):(b.depthMask(1),b.disable(b.BLEND),b.blendFunc(b.ONE,b.ONE));for(var y=0,I=H[C].length;y<I;y++)if(x=H[C][y][0],E=!1,g=H[C][y][1],F+=g,s.visible){if(!r.segment_state[x])if(F>g){a+=2*g;F-=g;if(l){w=!1;for(t=0;t<l;){g=l-
t;g>h.MAX_LIGHTS&&(g=h.MAX_LIGHTS);0<t&&!w&&(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),b.depthFunc(b.EQUAL),w=!0);u=q[t];z=u.light_type;for(E=0;E<g;E++)if(q[E+t].light_type!=z){g=E;break}s.use(u.light_type,g);u=s.shader[u.light_type][g];b.uniformMatrix4fv(u.matrixModelView,!1,m.mvMatrix);b.uniformMatrix4fv(u.matrixProjection,!1,m.pMatrix);b.uniformMatrix4fv(u.matrixObject,!1,o);b.uniformMatrix3fv(u.matrixNormal,!1,m.nMatrix);B||(s.bindObject(r,u),B=-1!=u.vertexTexCoord,(e||c)&&s.bindLines(r,u));
for(E=0;E<g;E++)q[E+t].setupShader(u,E);r.compiled.unrolled?b.drawArrays(A,a,F):b.drawElements(A,F,b.UNSIGNED_SHORT,a);t+=g}w&&(b.disable(b.BLEND),b.depthFunc(b.LEQUAL))}else s.use(0,0),b.uniformMatrix4fv(s.shader[0][0].matrixModelView,!1,m.mvMatrix),b.uniformMatrix4fv(s.shader[0][0].matrixProjection,!1,m.pMatrix),b.uniformMatrix4fv(s.shader[0][0].matrixObject,!1,o),b.uniformMatrix3fv(s.shader[0][0].matrixNormal,!1,m.nMatrix),B||(s.bindObject(r,s.shader[0][0]),B=-1!=s.shader[0][0].vertexTexCoord,
(e||c)&&s.bindLines(r,s.shader[0][0])),r.compiled.unrolled?b.drawArrays(A,a,F):b.drawElements(A,F,b.UNSIGNED_SHORT,a);a+=2*F;F=0;E=!0}else a+=2*F,F=0}else a+=2*g,F-=g;if(!E&&r.segment_state[x]&&s.visible){if(l){w=!1;for(t=0;t<l;){g=l-t;g>h.MAX_LIGHTS&&(g=h.MAX_LIGHTS);0<t&&!w&&(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),b.depthFunc(b.EQUAL),w=!0);u=q[t];z=u.light_type;for(E=0;E<g;E++)if(q[E+t].light_type!=z){g=E;break}s.use(u.light_type,g);u=s.shader[u.light_type][g];b.uniformMatrix4fv(u.matrixModelView,
!1,m.mvMatrix);b.uniformMatrix4fv(u.matrixProjection,!1,m.pMatrix);b.uniformMatrix4fv(u.matrixObject,!1,o);b.uniformMatrix3fv(u.matrixNormal,!1,m.nMatrix);B||(s.bindObject(r,u),B=-1!=u.vertexTexCoord,(e||c)&&s.bindLines(r,u));for(E=0;E<g;E++)q[E+t].setupShader(u,E);r.compiled.unrolled?b.drawArrays(A,a,F):b.drawElements(A,F,b.UNSIGNED_SHORT,a);t+=g}w&&(b.disable(b.BLEND),b.depthFunc(b.LEQUAL))}else s.use(0,0),b.uniformMatrix4fv(s.shader[0][0].matrixModelView,!1,m.mvMatrix),b.uniformMatrix4fv(s.shader[0][0].matrixProjection,
!1,m.pMatrix),b.uniformMatrix4fv(s.shader[0][0].matrixObject,!1,o),b.uniformMatrix3fv(s.shader[0][0].matrixNormal,!1,m.nMatrix),B||(s.bindObject(r,s.shader[0][0]),B=-1!=s.shader[0][0].vertexTexCoord,(e||c)&&s.bindLines(r,s.shader[0][0])),r.compiled.unrolled?b.drawArrays(A,a,F):b.drawElements(A,F,b.UNSIGNED_SHORT,a);a+=2*F}}}s&&u?s.clearObject(r,u):s.clearObject(r,null);b.depthMask(1);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return n}}}});
CubicVR.RegisterModule("Light",function(h){function v(d,f){d=h.get(d)||{};d===o&&(d=m.light.type.POINT);f===o&&(f=m.light.method.DYNAMIC);"object"==typeof d?(this.light_type=d.type!==o?h.parseEnum(m.light.type,d.type):m.light.type.POINT,this.diffuse=d.diffuse!==o?d.diffuse:[1,1,1],this.specular=d.specular!==o?d.specular:[1,1,1],this.intensity=d.intensity!==o?d.intensity:1,this.position=d.position!==o?d.position:[0,0,0],this.direction=d.direction!==o?d.direction:[0,0,0],this.distance=d.distance!==
o?d.distance:this.light_type===m.light.type.AREA?30:10,this.cutoff=d.cutoff!==o?d.cutoff:60,this.map_res=d.map_res!==o?d.map_res:this.light_type===m.light.type.AREA?2048:512,this.map_res=d.mapRes!==o?d.mapRes:this.map_res,this.method=d.method!==o?h.parseEnum(m.light.method,d.method):f,this.areaCam=d.areaCam!==o?d.areaCam:null,this.areaCeiling=d.areaCeiling!==o?d.areaCeiling:40,this.areaFloor=d.areaFloor!==o?d.areaFloor:-40,this.areaAxis=d.areaAxis!==o?d.areaAxis:[1,1,0],this.projectorTex=d.projector!==
o?d.projector:null):(this.light_type=h.parseEnum(m.light.type,d),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===m.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===m.light.type.AREA?2048:512,this.method=h.parseEnum(m.light.method,f),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);this.target=d.target||null;if(this.projectorTex&&"string"===
typeof this.projectorTex){var e=this.projectorTex;this.projectorTex=h.Textures_ref[e]!==o?h.Textures_obj[h.Textures_ref[e]]:new h.Texture(e)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.motion=null;this.rotation=[0,0,0];(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA&&h.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var r=h.GLCore,
m=h.enums,o=h.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];m.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};v.prototype={get x(){return this.position[0]},set x(d){this.position[0]=d},get y(){return this.position[1]},set y(d){this.position[1]=d},get z(){return this.position[2]},set z(d){this.position[2]=d},get rotX(){return this.rotation[0]},set rotX(d){this.rotation[0]=d},get rotY(){return this.rotation[1]},
set rotY(d){this.rotation[1]=d},get rotZ(){return this.rotation[2]},set rotZ(d){this.rotation[2]=d},get dirX(){return this.direction[0]},set dirX(d){this.direction[0]=d},get dirY(){return this.direction[1]},set dirY(d){this.direction[1]=d},get dirZ(){return this.direction[2]},set dirZ(d){this.direction[2]=d},get pos(){return this.position.slice(0)},set pos(d){this.position=d.slice(0)},get rot(){return this.rotation.slice(0)},set rot(d){this.rotation=d.slice(0)},get dir(){return this.direction.slice(0)},
set dir(d){this.direction=vec3.normalize(d.slice(0))},setType:function(d){if(d===m.light.type.AREA&&!h.features.lightShadows)this.dummyCam=new h.Camera,this.areaCam=new h.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,d=m.light.type.DIRECTIONAL;else if((d===m.light.type.SPOT_SHADOW||d===m.light.type.SPOT_SHADOW_PROJECTOR)&&!h.features.lightShadows)d=m.light.type.SPOT;this.light_type=d},setParent:function(d){this.parent=d},setMethod:function(d){this.method=d},setDiffuse:function(d){this.diffuse=
d},setSpecular:function(d){this.specular=d},setIntensity:function(d){this.intensity=d},setPosition:function(d){this.position=d},setDistance:function(d){this.distance=d},setCutoff:function(d){this.cutoff=d},setTarget:function(d){this.target=d.slice(0)},prepare:function(d){var f=h.mat4,e=h.mat3,c=this.light_type;this.target&&this.lookat(this.target);this.parent?c===m.light.type.SPOT||c===m.light.type.SPOT_SHADOW||c===m.light.type.SPOT_SHADOW_PROJECTOR?(c=f.inverse_mat3(this.parent.tMatrix),e.transpose_inline(c),
this.lDir=e.vec3_multiply(this.direction,c),this.lDir=e.vec3_multiply(this.lDir,d.nMatrix),this.lPos=f.vec3_multiply(this.position,f.multiply(d.mvMatrix,this.parent.tMatrix))):c===m.light.type.POINT&&(this.lPos=f.vec3_multiply(this.position,f.multiply(d.mvMatrix,this.parent.tMatrix))):c===m.light.type.DIRECTIONAL?this.lDir=e.vec3_multiply(this.direction,d.nMatrix):c===m.light.type.SPOT||c===m.light.type.SPOT_SHADOW||c===m.light.type.SPOT_SHADOW_PROJECTOR?(this.lDir=e.vec3_multiply(this.direction,
d.nMatrix),this.lPos=f.vec3_multiply(this.position,d.mvMatrix)):c===m.light.type.POINT?this.lPos=f.vec3_multiply(this.position,d.mvMatrix):c===m.light.type.AREA&&(this.lDir=e.vec3_multiply(this.direction,d.nMatrix))},control:function(d,f,e){d===m.motion.POS?this.position[f]=e:d===m.motion.INTENSITY&&(this.intensity=e)},getAABB:function(){var d=h.vec3,f=h.aabb,e=[[0,0,0],[0,0,0]];f.engulf(e,[this.distance,this.distance,this.distance]);f.engulf(e,[-this.distance,-this.distance,-this.distance]);e[0]=
d.add(e[0],this.position);e[1]=d.add(e[1],this.position);return this.aabb=e},setDirection:function(d,f,e){var c=h.vec3;if("object"===typeof d)this.setDirection(d[0],d[1],d[2]);else return this.direction=c.normalize([d,f,e]),this.target=null,this},lookat:function(d,f,e){var c=h.vec3;if("object"===typeof d)this.lookat(d[0],d[1],d[2]);else return this.direction=c.normalize(c.subtract([d,f,e],this.position)),this.target=[d,f,e],this},setRotation:function(d,f,e){var c=h.mat4,n=h.vec3;if("object"===typeof d)this.setRotation(d[0],
d[1],d[2]);else{var a=new h.Transform;a.rotate([-d,-f,-e]);a.pushMatrix();this.direction=n.normalize(c.vec3_multiply([1,0,0],a.getResult()));this.rotation=[d,f,e];return this}},setupShader:function(d,f){var e=r.gl;e.uniform3fv(d.lightDiffuse[f],this.diffuse);e.uniform3fv(d.lightSpecular[f],this.specular);this.lPos&&e.uniform3fv(d.lightPosition[f],this.lPos);this.lDir&&e.uniform3fv(d.lightDirection[f],this.lDir);e.uniform1f(d.lightIntensity[f],this.intensity);e.uniform1f(d.lightDistance[f],this.distance);
(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.SPOT)&&e.uniform1f(d.lightCutOffAngle[f],this.cutoff);if(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA)this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(r.gl.TEXTURE0+2*f),e.uniform1i(d.lightShadowMap[f],2*f),this.projectorTex.use(r.gl.TEXTURE0+2*f+
1),e.uniform1i(d.lightProjectionMap[f],2*f+1)):(this.shadowMapTex.texture.use(r.gl.TEXTURE0+f),e.uniform1i(d.lightShadowMap[f],f)),e.uniform3fv(d.lightDepthClip[f],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),e.uniformMatrix4fv(d.lightShadowMatrix[f],!1,this.spMatrix)},setShadow:function(d){h.features.lightShadows&&(this.map_res=d,this.shadowMapTex=new h.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(m.texture.filter.NEAREST),this.dummyCam=new h.Camera(this.map_res,
this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0)},hasShadow:function(){return has_shadow},setProjector:function(d){this.projectorTex=d},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var d=r.gl,f=h.mat4,e=h.mat3;this.shadowMapTex.use();d.viewport(0,0,this.map_res,this.map_res);d.clear(d.DEPTH_BUFFER_BIT|d.COLOR_BUFFER_BIT);this.light_type!==m.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),
this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var c=f.inverse_mat3(this.parent.tMatrix);e.transpose_inline(c);e.vec3_multiply(this.direction,c);f.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);f.multiply(this.dummyCam.mvMatrix.slice(0),f.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],
this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);d.cullFace(d.FRONT)},shadowEnd:function(){var d=r.gl;d.bindFramebuffer(d.FRAMEBUFFER,null);d.cullFace(d.BACK);this.setupTexGen()},setupTexGen:function(){var d=h.mat4;this.spMatrix=d.multiply(q,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=d.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=d.multiply(this.spMatrix,this.dummyCam.mvMatrix)},
setAreaAxis:function(d){this.areaAxis=d},updateAreaLight:function(){var d=h.vec3,f=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var e=0,e=Math.tan(this.areaCam.fov/2*(Math.PI/180)),c=d.subtract(this.areaCam.target,this.areaCam.position);c[1]=0;c=d.normalize(c);d.normalize(d.cross(c,[0,1,0]));var n=-Math.atan2(c[2],c[0]),e=this.distance/2*Math.abs(e)-this.distance/2;e<this.distance/3/2&&(e=this.distance/3/2);var c=d.multiply(c,e),e=this.areaAxis[1]*(Math.PI/
180),a=Math.tan(this.areaAxis[0]*(Math.PI/180)),e=[Math.tan(e),0,a],n=n-Math.atan2(e[0],e[2]);this.position=d.add(d.add(this.areaCam.position,c),d.multiply(e,f));this.position[1]=this.areaCeiling;this.target=d.add(d.add(this.areaCam.position,c),d.multiply(e,-f));this.target[1]=this.areaFloor;this.direction=d.normalize(d.subtract(this.target,this.position));this.dummyCam.rotation[2]=n*(180/Math.PI);d=this.dummyCam.farclip*Math.abs(this.direction[1])*f;f=this.orthoBounds(this.position,this.distance,
this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);f[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);f=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);f[1][1]>this.areaFloor&&(f=f[1][1]-this.areaFloor,d+=f/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=d;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(d,
f,e,c,n,a){var c=h.vec3,b=c.normalize([n[0],n[4],n[8]]),g=c.normalize([n[1],n[5],n[9]]),n=c.normalize(c.cross(g,b)),l;l=e/2;e=[];f=c.multiply(b,f/2);b=c.multiply(g,l);a=c.multiply(n,a);e[0]=c.add(c.subtract(d,f),c.add(b,a));e[1]=c.add(c.add(d,f),c.add(b,a));e[2]=c.subtract(c.subtract(d,f),c.add(b,a));e[3]=c.subtract(c.add(d,f),c.add(b,a));aabb1=e[0];aabb2=e[0];for(d=1;4>d;d++)aabb1[0]>e[d][0]&&(aabb1[0]=e[d][0]),aabb1[1]>e[d][1]&&(aabb1[1]=e[d][1]),aabb1[2]>e[d][2]&&(aabb1[2]=e[d][2]),aabb2[0]<e[d][0]&&
(aabb2[0]=e[d][0]),aabb2[1]<e[d][1]&&(aabb2[1]=e[d][1]),aabb2[2]<e[d][2]&&(aabb2[2]=e[d][2]);return[aabb1,aabb2]}};return{Light:v}});
CubicVR.RegisterModule("Camera",function(h){function v(e,c,d,a,b){var g=h.mat4;this.frustum=new h.Frustum;"object"==typeof e?(this.position=e.position||[0,0,-1],this.rotation=e.rotation||[0,0,0],this.target=e.target||[0,0,0],this.fov=e.fov||60,this.nearclip=e.nearclip||e.nearClip||e.near||0.1,this.farclip=e.farclip||e.farClip||e.far||400,this.targeted=e.targeted!==o?e.targeted:!0,this.calc_nmatrix=e.calcNormalMatrix!==o?e.calcNormalMatrix:!0,this.name=e.name||"camera"+f,c=e.height?e.height:o,e=e.width?
e.width:o):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=d!==o?d:60,this.nearclip=a!==o?a:0.1,this.farclip=b!==o?b:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+f);this.motion=this.targetSceneObject=null;this.transform=new h.Transform;this.manual=!1;this.setDimensions(e!==o?e:512,c!==o?c:512);this.mvMatrix=g.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++f}function r(e){this.position=
e!==o?e:[0,0,0]}function m(e,c,d){this.camPath=new h.Motion;this.targetPath=new h.Motion;this.start_position=e!==o?e:[8,8,8];this.target=c!==o?c:[0,0,0];this.bounds=d!==o?d:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var o=h.undef,q=h.enums,d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=0;v.prototype={get x(){return this.position[0]},
set x(e){this.position[0]=e},get y(){return this.position[1]},set y(e){this.position[1]=e},get z(){return this.position[2]},set z(e){this.position[2]=e},get rotX(){return this.rotation[0]},set rotX(e){this.rotation[0]=e},get rotY(){return this.rotation[1]},set rotY(e){this.rotation[1]=e},get rotZ(){return this.rotation[2]},set rotZ(e){this.rotation[2]=e},get targetX(){return this.target[0]},set targetX(e){this.target[0]=e},get targetY(){return this.target[1]},set targetY(e){this.target[1]=e},get targetZ(){return this.target[2]},
set targetZ(e){this.target[2]=e},get pos(){return this.position.slice(0)},set pos(e){this.position=e.slice(0)},get rot(){return this.rotation.slice(0)},set rot(e){this.rotation=e.slice(0)},trackTarget:function(e,c,d){this.position=h.vec3.trackTarget(this.position,e,c,d)},setParent:function(e){this.parent=e},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?h.mat4.vec3_multiply(this.position,
this.parent.tMatrix):this.position},setOrtho:function(e,c,d,a){this.ortho=!0;this.ortho_view.left=e;this.ortho_view.right=c;this.ortho_view.bottom=d;this.ortho_view.top=a},control:function(e,c,d){e===q.motion.ROT?this.rotation[c]=d:e===q.motion.POS?this.position[c]=d:e===q.motion.FOV?this.setFOV(d):e===q.motion.LENS?this.setLENS(d):e===q.motion.NEARCLIP?this.setClip(d,this.farclip):e===q.motion.FARCLIP&&this.setClip(this.nearclip,d)},makeFrustum:function(e,c,d,a,b,g){return[2*b/(c-e),0,0,0,0,2*b/
(a-d),0,0,(c+e)/(c-e),(a+d)/(a-d),-(g+b)/(g-b),-1,0,0,-2*g*b/(g-b),0]},setTargeted:function(e){this.targeted=e},calcProjection:function(){var e=h.mat4,c=h.mat3;this.pMatrix=this.ortho?e.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):e.perspective(this.fov,this.aspect,this.nearclip,this.farclip);!this.targeted&&this.mvMatrix&&(e.identity(this.mvMatrix),e.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),
e.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&e.multiply(this.mvMatrix.slice(0),e.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=e.inverse_mat3(this.mvMatrix),c.transpose_inline(this.nMatrix)):e.identity(this.nMatrix));this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(e,c){this.nearclip=e;this.farclip=c;this.calcProjection()},setDimensions:function(e,c){this.width=e;this.height=c;this.aspect=e/c;this.calcProjection()},
setAspect:function(e){this.aspect=e;this.calcProjection()},resize:function(e,c){this.setDimensions(e,c)},setFOV:function(e){this.fov=e;this.ortho=!1;this.calcProjection()},setLENS:function(e){this.setFOV(2*Math.atan(16/e)*(180/Math.PI))},lookat:function(e,c,n,a,b,g,l,f,m){var o=h.mat4,s=h.mat3;"object"==typeof e?this.lookat(this.position[0],this.position[1],this.position[2],e[0],e[1],e[2],0,1,0):(this.mvMatrix=o.lookat(e,c,n,a,b,g,l,f,m),this.rotation[2]&&(this.transform.clearStack(),this.transform.rotate(-this.rotation[2],
0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult()),null!==this.parent&&o.multiply(this.mvMatrix.slice(0),o.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=o.inverse_mat3(this.mvMatrix),s.transpose_inline(this.nMatrix)):this.nMatrix=d,this.frustum.extract(this,this.mvMatrix,this.pMatrix))},unProject:function(e,c,d){var a=h.mat4,b=h.vec3,g=[0,0,this.width,this.height],e=a.vec4_multiply(a.vec4_multiply([2*((e-g[0])/g[2])-1,-(2*((c-g[1])/
g[3])-1),1,1],a.inverse(this.pMatrix)),a.inverse(this.mvMatrix)),e=[e[0]/e[3],e[1]/e[3],e[2]/e[3]];return d!==o?(c=this.getParentedPosition(),b.add(c,b.multiply(b.normalize(b.subtract(e,c)),d))):e},project:function(e,c,d){var a=h.mat4,a=a.vec4_multiply(a.vec4_multiply([e,c,d,1],this.mvMatrix),this.pMatrix);a[2]=h.vec3.length(h.vec3.subtract([e,c,d],this.position));return[(a[0]/a[3]+1)/2*this.width,(-a[1]/a[3]+1)/2*this.height,a[2]]}};r.prototype={control:function(e,c,d){e===q.motion.POS&&(this.position[c]=
d)}};m.prototype={inBounds:function(e){var c=h.vec3;if(!(e[0]>this.bounds[0][0]&&e[1]>this.bounds[0][1]&&e[2]>this.bounds[0][2]&&e[0]<this.bounds[1][0]&&e[1]<this.bounds[1][1]&&e[2]<this.bounds[1][2]))return!1;for(var d=0,a=this.avoid_sphere.length;d<a;d++)if(c.length(e,this.avoid_sphere[d][0])<this.avoid_sphere[d][1])return!1;return!0},findNextNode:function(e,c){var d=h.vec3,a=[0,0,0],b=[0,0,0],g=a=0,l=!1;do if(b[0]=Math.random()-0.5,b[1]=Math.random()-0.5,b[2]=Math.random()-0.5,b=d.normalize(b),
a=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,a=d.add(c.position,d.multiply(b,a)),l=this.inBounds(a),g++,30<g){a=c.position;break}while(!l);return a},run:function(e){this.current_time=e;0===this.path_time&&(this.path_time=this.current_time,this.camPath.setKey(q.motion.POS,q.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(q.motion.POS,q.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(q.motion.POS,q.motion.Z,this.path_time,this.start_position[2]));
for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var c=new r,d=new r;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,c);this.camPath.apply(this.path_time-this.segment_time,d);c=this.findNextNode(c,d);this.camPath.setKey(q.motion.POS,q.motion.X,this.path_time,c[0]);this.camPath.setKey(q.motion.POS,q.motion.Y,this.path_time,c[1]);this.camPath.setKey(q.motion.POS,q.motion.Z,this.path_time,c[2]);this.path_length++}c=new r;this.camPath.apply(e,
c);return c.position},addSafeBound:function(e,c){this.safe_bb.push([e,c])},addAvoidSphere:function(e,c){this.avoid_sphere.push([e,c])}};return{Camera:v,AutoCamera:m}});
CubicVR.RegisterModule("StereoCameraRig",function(h){var v=h.enums;v.stereo={mode:{STEREO:1,RIFT:2,TWOCOLOR:3,INTERLACE:4}};var r=function(m){m=m||{};camera=m.camera||null;var o=h.getCanvas();this.eyeSpacing=m.eyeSpacing||0.6;this.mode=h.parseEnum(v.stereo.mode,m.mode||1);this.doubleBuffer=!1;this.leftColor=[0,0,1];this.rightColor=[1,0,0];this.eyeWarpEnabled=m.eyeWarp;if(!camera||!(camera instanceof h.Camera))throw"StereoCameraRig Error: camera not provided?";this.fov=m.fov||camera.fov;this.camLeft=
new h.Camera({fov:this.fov,aspect:this.aspect,targeted:camera.targeted});this.camRight=new h.Camera({fov:this.fov,aspect:this.aspect,targeted:camera.targeted});camera.parent&&(this.camLeft.setParent(camera.parent),this.camRight.setParent(camera.parent));this.camera=camera;this.fxChain=m.fxChain||m.fxChainA||new h.PostProcessChain(o.width,o.height,!1);this.fxChainB=m.fxChainB||null;h.addResizeable(this.fxChain);this.fxChainB&&h.addResizeable(this.fxChainB);this.shaderEyeWarp=new h.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main()\n{\nvec2 uv = vTex;\nuv.x *= 2.0;\nif (uv.x>1.0) {\nuv.x -= 1.0;\n}\nvec2 cen = vec2(0.5,0.5) - uv.xy;\nif (length(cen)>0.5) discard;\nvec2 mcen = -0.02*tan(length(cen)*3.14)*(cen);\nuv += mcen;\nif (uv.x>1.0||uv.x<0.0||uv.y>1.0||uv.y<0.0) discard;\nuv.x /= 2.0;\nif (vTex.x > 0.5) {\nuv.x+=0.5;\n}\ngl_FragColor = texture2D(srcTex, uv);\n}",outputMode:"replace",enabled:!1});this.shaderTwoColor=
new h.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform sampler2D rightTex;\nvarying vec2 vTex;\nuniform vec3 leftColor;\nuniform vec3 rightColor;\nvoid main()\n{\nvec3 leftSample = texture2D(srcTex, vTex).rgb;\nvec3 rightSample = texture2D(rightTex, vTex).rgb;\nleftSample.rgb = vec3((leftSample.r+leftSample.g+leftSample.b)/3.0);\nrightSample.rgb = vec3((rightSample.r+rightSample.g+rightSample.b)/3.0);\ngl_FragColor = vec4(leftSample.rgb*leftColor+rightSample.rgb*rightColor,1.0);\n}",
outputMode:"replace",enabled:!1,init:function(m){m.addInt("rightTex",2);m.addVector("leftColor",this.leftColor);m.addVector("rightColor",this.rightColor)}});this.shaderInterlace=new h.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main()\n{\nvec2 uv = vTex;\nuv.y *= 0.5;\nif (mod(floor(vTex.y/texel.y),2.0)==0.0) {\nuv.y+=0.5;\n}\ngl_FragColor = texture2D(srcTex, uv);\n}",
outputMode:"replace",enabled:!1});this.fxChain.addShader(this.shaderEyeWarp);this.fxChain.addShader(this.shaderTwoColor);this.fxChain.addShader(this.shaderInterlace);this.aspect=m.aspect;this.aspect||(this.aspect=this.mode==v.stereo.mode.STEREO?o.width/2/o.height:o.width/o.height);this.setMode({mode:this.mode})};r.prototype={setMode:function(m){m=m||{mode:1};this.mode=h.parseEnum(v.stereo.mode,m.mode);fov=m.fov||this.fov;aspect=m.aspect||this.aspect;this.leftColor=m.leftColor||this.leftColor;this.rightColor=
m.rightColor||this.rightColor;switch(this.mode){case v.stereo.mode.STEREO:this.setDoubleBuffer(!1);this.setEyeWarp(!1);this.setInterlace(!1);this.setTwoColor(!1);break;case v.stereo.mode.RIFT:aspect=110/90;fov=110;this.setDoubleBuffer(!1);this.setEyeWarp(!0);this.setInterlace(!1);this.setTwoColor(!1);break;case v.stereo.mode.TWOCOLOR:this.setDoubleBuffer(!0);this.setEyeWarp(!1);this.setInterlace(!1);this.setTwoColor(!0);this.shaderTwoColor.shader.use();this.shaderTwoColor.shader.setVector("leftColor",
this.leftColor);this.shaderTwoColor.shader.setVector("rightColor",this.rightColor);break;case v.stereo.mode.INTERLACE:this.setDoubleBuffer(!1),this.setEyeWarp(!1),this.setInterlace(!0),this.setTwoColor(!1)}this.camLeft.setAspect(aspect);this.camLeft.setFOV(fov);this.camLeft.setTargeted(this.camera.targeted);this.camRight.setAspect(aspect);this.camRight.setFOV(fov);this.camRight.setTargeted(this.camera.targeted)},getMode:function(){return this.mode},setupCameras:function(){var m=this.camera;this.camLeft.rot=
m.rot;this.camRight.rot=m.rot;m.unProject(m.farclip);this.camLeft.pos=m.pos;this.camRight.pos=m.pos;this.camera.targeted?(this.camLeft.position=h.vec3.moveViewRelative(this.camera.position,this.camera.target,-this.eyeSpacing/2,0),this.camRight.position=h.vec3.moveViewRelative(this.camera.position,this.camera.target,this.eyeSpacing/2,0),this.camLeft.target=h.vec3.moveViewRelative(this.camera.position,this.camera.target,-this.eyeSpacing/2,0,this.camera.target),this.camRight.target=h.vec3.moveViewRelative(this.camera.position,
this.camera.target,this.eyeSpacing/2,0,this.camera.target)):(this.camLeft.position[0]-=this.eyeSpacing/2,this.camRight.position[0]+=this.eyeSpacing/2);!this.camera.parent&&!this.camera.targeted&&(m=h.mat4.transform(h.vec3.subtract([0,0,0],this.camera.position),this.camera.rotation),this.camLeft.parent={tMatrix:m},this.camRight.parent={tMatrix:m})},renderScene:function(m){this.setupCameras();var o=h.getCanvas(),q=this.fxChain,d=this.fxChainB,f=h.GLCore.gl,e=o.width/2,c=o.height/2,n=o.height,o=o.width;
this.shaderEyeWarp.enabled=this.eyeWarpEnabled;this.shaderTwoColor.enabled=this.twoColorEnabled;this.shaderInterlace.enabled=this.interlaceEnabled;this.twoColorEnabled&&d?(q.begin(),f.viewport(0,0,o,n),f.clear(f.DEPTH_BUFFER_BIT|f.COLOR_BUFFER_BIT),m.render({camera:this.swapEyes?this.camRight:this.camLeft}),q.end(),d.begin(),f.viewport(0,0,o,n),f.clear(f.DEPTH_BUFFER_BIT|f.COLOR_BUFFER_BIT),m.render({camera:this.swapEyes?this.camLeft:this.camRight}),d.end(),f.viewport(0,0,o,n),d.captureBuffer.texture.use(f.TEXTURE2)):
(q.begin(),f.viewport(0,0,o,n),f.clear(f.DEPTH_BUFFER_BIT|f.COLOR_BUFFER_BIT),this.interlaceEnabled?f.viewport(0,0,o,c):f.viewport(0,0,e,n),m.render({camera:this.swapEyes?this.camRight:this.camLeft}),this.interlaceEnabled?f.viewport(0,c,o,c):f.viewport(e,0,e,n),m.render({camera:this.swapEyes?this.camLeft:this.camRight}),q.end(),f.viewport(0,0,o,n));q.render()},setEyeWarp:function(m){this.eyeWarpEnabled=m},getEyeWarp:function(){return this.eyeWarpEnabled},setSwapEyes:function(m){this.swapEyes=m},getSwapEyes:function(){return this.swapEyes},
setDoubleBuffer:function(m){if(!this.fxChainB){var o=h.getCanvas();this.fxChainB=new h.PostProcessChain(o.width,o.height,!1);h.addResizeable(this.fxChainB)}this.doubleBuffer=m},getDoubleBuffer:function(){return this.doubleBuffer},setTwoColor:function(m){this.twoColorEnabled=m},getTwoColor:function(){return this.twoColorEnabled},setInterlace:function(m){this.interlaceEnabled=m},getInterlace:function(){return this.interlaceEnabled},addUI:function(){var m=document.createElement("div");m.style.position=
"absolute";m.style.top="10px";m.style.left="10px";m.style.color="white";m.style.zIndex=1E3;m.appendChild(document.createTextNode("Mode:"));var o=document.createElement("select");o.options[0]=new Option("Oculus Rift Untested","rift");o.options[1]=new Option("Split Stereo","stereo");o.options[2]=new Option("Red/Blue Stereo","redblue");o.options[3]=new Option("Red/Green Stereo","redgreen");o.options[4]=new Option("Interlaced","interlace");o.selectedIndex=0;m.appendChild(o);m.appendChild(document.createTextNode(" Swap Eyes:"));
var q=document.createElement("input");q.type="checkbox";q.value="1";m.appendChild(q);document.body.appendChild(m);o.selectedIndex=0;var d=this;q.addEventListener("change",function(){d.setSwapEyes(this.checked)},!0);o.addEventListener("change",function(){var f=this.options[this.selectedIndex].value,e=h.getCanvas();switch(f){case "rift":d.setMode({mode:"rift"});break;case "stereo":d.setMode({mode:"stereo",fov:60,aspect:e.width/2/e.height});break;case "redblue":d.setMode({mode:"twocolor",leftColor:[0,
0,1],rightColor:[1,0,0],fov:60,aspect:e.width/e.height});break;case "redgreen":d.setMode({mode:"twocolor",leftColor:[0,1,0],rightColor:[1,0,0],fov:60,aspect:e.width/e.height});break;case "interlace":d.setMode({mode:"interlace",leftColor:[0,1,0],rightColor:[1,0,0],fov:60,aspect:e.width/e.height})}},!0)}};return{StereoCameraRig:r}});
CubicVR.RegisterModule("Motion",function(h){function v(){this.time=this.value=0;this.shape=q.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function r(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(q.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||q.envelope.behavior.CONSTANT,this.out_behavior=h.parseEnum(q.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||q.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=q.envelope.behavior.CONSTANT}function m(a,b){this.controllers=[];this.yzflip=!1;if("object"===typeof a){var c=h.get(a);this.env_init=h.get(c.envelope);this.key_init=h.get(c.key);for(var e in c)if(c.hasOwnProperty(e)&&!("envelope"===e||"key"===e)){var d=c[e],n=h.get(d.envelope),f;for(f in d)if(d.hasOwnProperty(f)&&!("envelope"===f||"key"===f)){var s=d[f];if("object"===typeof s)for(var m in s)this.setKey(e,m,f,s[m]),n&&this.setBehavior(e,m,n)}}}else this.env_init=
a,this.key_init=b}var o=h.undef,q=h.enums;q.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};q.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var d=function(a,b,c){var e=0,e=c-b;if(0===e)return[b,0];b=a-e*Math.floor((a-b)/e);e=-parseInt((b-a)/e+(b>a?0.5:-0.5),10);return[b,e]},f=function(a,b,c,e,d){var n,f;f=d*d;n=3*(b-a);b=3*(c-b)-n;return(e-a-n-b)*
f*d+b*f+n*d+a},e=function(a,b,c,d,n,m,o){var s,h;h=m+0.5*(o-m);s=f(a,b,c,d,h);return 1.0E-4<Math.abs(n-s)?(s>n?o=h:m=h,e(a,b,c,d,n,m,o)):h},c=function(a,b){var c,e,d,n;a.shape===q.envelope.shape.TCB?(c=(1-a.tension)*(1+a.continuity)*(1+a.bias),e=(1-a.tension)*(1-a.continuity)*(1-a.bias),d=b.value-a.value,a.prev?(n=(b.time-a.time)/(b.time-a.prev.time),c=n*(c*(a.value-a.prev.value)+e*d)):c=e*d):a.shape===q.envelope.shape.LINE?(d=b.value-a.value,a.prev?(n=(b.time-a.time)/(b.time-a.prev.time),c=n*(a.value-
a.prev.value+d)):c=d):a.shape===q.envelope.shape.BEZI||a.shape===q.envelope.shape.HERM?(c=a.param[1],a.prev&&(c*=(b.time-a.time)/(b.time-a.prev.time))):a.shape===q.envelope.shape.BEZ2?(c=a.param[3]*(b.time-a.time),c=1.0E-5<Math.abs(a.param[2])?c/a.param[2]:1E5*c):c=0;return c},n=function(a,b){var c,e,d,n;b.shape===q.envelope.shape.LINE?(d=b.value-a.value,b.next?(n=(b.time-a.time)/(b.next.time-a.time),c=n*(b.next.value-b.value+d)):c=d):b.shape===q.envelope.shape.TCB?(c=(1-b.tension)*(1-b.continuity)*
(1+b.bias),e=(1-b.tension)*(1+b.continuity)*(1-b.bias),d=b.value-a.value,b.next?(n=(b.time-a.time)/(b.next.time-a.time),c=n*(e*(b.next.value-b.value)+c*d)):c*=d):b.shape===q.envelope.shape.HERM||b.shape===q.envelope.shape.BEZI?(c=b.param[0],b.next&&(c*=(b.time-a.time)/(b.next.time-a.time))):b.shape===q.envelope.shape.BEZ2?(c=b.param[1]*(b.time-a.time),c=1.0E-5<Math.abs(b.param[0])?c/b.param[0]:1E5*c):c=0;return c};r.prototype={setBehavior:function(a,b){this.in_behavior=h.parseEnum(q.envelope.behavior,
a);this.out_behavior=h.parseEnum(q.envelope.behavior,b)},empty:function(){return 0===this.nKeys},addKey:function(a,b,c){var e="object"==typeof a?a:c;b||(b=0);a||(a=0);e?(e=a,a=e.time,c=this.insertKey(a),c.value=e.value?e.value:b,c.time=e.time?e.time:a,c.shape=h.parseEnum(q.envelope.shape,e.shape)||q.envelope.shape.TCB,c.tension=e.tension?e.tension:0,c.continuity=e.continuity?e.continuity:0,c.bias=e.bias?e.bias:0,c.param=e.param?e.param:[0,0,0,0]):(c=this.insertKey(a),c.value=b);return c},insertKey:function(a){var b=
new v;b.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=b,this.nKeys++,b;for(var c=this.keys;c;){this.firstKey.time>a?this.firstKey=b:this.lastKey.time<a&&(this.lastKey=b);if(c.time>b.time)return b.prev=c.prev,b.prev&&(b.prev.next=b),b.next=c,b.next.prev=b,this.nKeys++,b;if(!c.next)return b.prev=c,c.next=b,this.nKeys++,b;c=c.next}return null},evaluate:function(a){var b,g,l,u,m,o=0;if(0===this.nKeys)return 0;if(1===this.nKeys)return this.keys.value;g=this.firstKey;b=this.lastKey;
if(a<g.time){u=this.in_behavior;if(u===q.envelope.behavior.RESET)return 0;if(u===q.envelope.behavior.CONSTANT)return g.value;if(u===q.envelope.behavior.REPEAT)u=d(a,g.time,b.time),a=u[0];else if(u===q.envelope.behavior.OCILLATE)u=d(a,g.time,b.time),a=u[0],u=u[1],u%2&&(a=b.time-g.time-a);else if(u===q.envelope.behavior.OFFSET)u=d(a,g.time,b.time),a=u[0],u=u[1],o=u*(b.value-g.value);else if(u===q.envelope.behavior.LINEAR)return m=c(g,g.next)/(g.next.time-g.time),m*(a-g.time)+g.value}else if(a>b.time){u=
this.out_behavior;if(u===q.envelope.behavior.RESET)return 0;if(u===q.envelope.behavior.CONSTANT)return b.value;if(u===q.envelope.behavior.REPEAT)u=d(a,g.time,b.time),a=u[0];else if(u===q.envelope.behavior.OCILLATE)u=d(a,g.time,b.time),a=u[0],u=u[1],u%2&&(a=b.time-g.time-a);else if(u===q.envelope.behavior.OFFSET)u=d(a,g.time,b.time),a=u[0],u=u[1],o=u*(b.value-g.value);else if(u===q.envelope.behavior.LINEAR)return u=n(b.prev,b)/(b.time-b.prev.time),u*(a-b.time)+b.value}if(this.lastKey0)if(a>this.lastKey0.time)b=
this.lastKey0;else if(a<this.lastKey0.time)for(b=this.lastKey;a<b.time&&b.prev;)b=b.prev;else b=this.keys;else b=this.keys;for(;a>b.next.time;)b=b.next;g=b.next;this.lastKey0=b;if(a===b.time)return b.value+o;if(a===g.time)return g.value+o;l=(a-b.time)/(g.time-b.time);u=g.shape;if(u===q.envelope.shape.TCB||u===q.envelope.shape.BEZI||u===q.envelope.shape.HERM){m=c(b,g);u=n(b,g);var s,h;h=l*l;s=l*h;a=3*h-s-s;s-=h;a=[1-a,a,s-h+l,s];return a[0]*b.value+a[1]*g.value+a[2]*m+a[3]*u+o}return u===q.envelope.shape.BEZ2?
(a=e(b.time,b.shape===q.envelope.shape.BEZ2?b.time+b.param[2]:b.time+(g.time-b.time)/3,g.time+g.param[0],g.time,a,0,1),f(b.value,b.shape===q.envelope.shape.BEZ2?b.value+b.param[3]:b.value+b.param[1]/3,g.param[1]+g.value,g.value,a)+o):u===q.envelope.shape.LINE?b.value+l*(g.value-b.value)+o:u===q.envelope.shape.STEP?b.value+o:o}};m.prototype={clone:function(){var a=new h.Motion(this.env_init,this.key_init),b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){a.controllers[b]===o&&(a.controllers[b]=
[]);for(var c in this.controllers[b])if(this.controllers[b].hasOwnProperty(c)){var e=this.controllers[b][c],d=a.controllers[b][c]=new r({in_behavior:e.in_behavior,out_behavior:e.out_behavior});d.nKeys=e.nKeys;d.keys=e.keys;d.firstKey=e.firstKey;d.lastKey=e.lastKey}}return a},envelope:function(a,b){b=h.parseEnum(q.motion,b)||0;a=h.parseEnum(q.motion,a)||0;this.controllers[a]===o&&(this.controllers[a]=[]);this.controllers[a][b]===o&&(this.controllers[a][b]=new r(this.env_init));return this.controllers[a][b]},
evaluate:function(a){var b=[],c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){b[c]=[];for(var e in this.controllers[c])this.controllers[c].hasOwnProperty(e)&&(b[c][e]=this.controllers[c][e].evaluate(a))}return b},apply:function(a,b){for(var c in this.controllers)if(this.controllers.hasOwnProperty(c)){var e=parseInt(c,10);if(this.yzflip&&e===q.motion.ROT){this.q||(this.q=new h.Quaternion);var d=this.q,n=this.controllers[c][0].evaluate(a),f=this.controllers[c][1].evaluate(a),s=this.controllers[c][2].evaluate(a);
d.fromEuler(n,s,-f);d=d.toEuler();b.control(e,0,d[0]);b.control(e,1,d[1]);b.control(e,2,d[2])}else for(var m in this.controllers[c])this.controllers[c].hasOwnProperty(m)&&b.control(e,parseInt(m,10),this.controllers[c][m].evaluate(a))}},setKey:function(a,b,c,e,d){b=h.parseEnum(q.motion,b)||0;a=h.parseEnum(q.motion,a)||0;return this.envelope(a,b).addKey(c,e,d?d:this.key_init)},setArray:function(a,b,c,e){var d=[],a=h.parseEnum(q.motion,a)||0,n;for(n in c)if(c.hasOwnProperty(n)){var f=this.envelope(a,
h.parseEnum(q.motion,n));d[n]=f.addKey(b,c[n],e?e:this.key_init)}return d},setBehavior:function(a,b,c,e){var d=this.envelope(a,b);"object"===typeof c&&(e=c,c=e.in_behavior||e.inBehavior||e.behavior,e=e.out_behavior||e.outBehavior||e.behavior);h.parseEnum(q.motion,b);h.parseEnum(q.motion,a);d.setBehavior(c,e)},setBehaviorArray:function(a,b,c){var a=h.parseEnum(q.motion,a)||0,e=this.controllers[a],d;for(d in e)e.hasOwnProperty(d)&&this.envelope(a,h.parseEnum(q.motion,d)||0).setBehavior(b,c)}};return{Motion:m,
Envelope:r,EnvelopeKey:v}});
CubicVR.RegisterModule("EventHandler",function(h){function v(f){f=CubicVR.parseEnum(q.event,f);return f===o?(d("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1):!isNaN(parseInt(f,10))&&(f>=q.event.EVENT_MAX||0>f)?(d("Unknown event ID passed: "+f),!1):f}function r(d){d=d||{};this.name=d.name;d.id=v(d.id)||q.event.TICK;this.id=d.id;this.interval=d.interval||0;this.enabled=d.enabled||
!0;this.action=d.action||null;this.properties=d.properties||{};this.event_properties=d.event_properties||{};this.buffered=d.buffered||!1;this.weight=d.weight===o?-1:d.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function m(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var o=h.undef,
q=CubicVR.enums,d=h.log;q.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};r.prototype={getName:function(){return this.name},setName:function(d){this.name=d},getSubject:function(){return this.subject},setSubject:function(d){this.subject=d},getId:function(){return this.id},setId:function(d){this.id=d},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},
setEnabled:function(d){d&&!this.enabled&&(this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1);this.enabled=d},isBuffered:function(){return this.buffered},setBuffered:function(d){this.buffered=d},setInterval:function(d){this.interval=d},getInterval:function(){return this.interval},setAction:function(d){this.action=d},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(d){this.properties=
d},getProperty:function(d){return this.properties[d]},setProperty:function(d,e){this.properties[d]=e},setEventProperties:function(d){this.event_properties=d},getEventProperties:function(){return this.event_properties},getEventProperty:function(d){return this.event_properties[d]},setEventProperty:function(d,e){this.properties[d]=e},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getSeconds:function(){return this.getTimeUpdated()},
getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(d){this.t_rest=d},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(d){this.setRestInterval(d||0)},awake:function(){this.t_rest=0},update:function(d,e){if(!this.enabled)return!1;var c=0,n=!0;0===this.n_updates?(this.t_updatecall=this.t_update=d,c=1/60):d!==this.t_update?
(this.t_rest||(this.t_last=d-this.t_update,this.t_update=d),c=d-this.t_updatecall,this.t_updatecall=d):n=!1;if(0<this.t_rest)n&&(this.t_resting+=c,this.t_rest-=c,0>this.t_rest&&(this.t_rest=0));else return n&&(this.t_active+=this.t_last,!this.t_rest&&this.interval&&(this.t_rest=this.interval),this.n_updates++),this.callEvent(e),!0;n&&this.n_updates++;return!1},callEvent:function(d){return!this.action?!1:this.action(this,d)}};m.prototype={addEvent:function(d){d.callEvent||(d=new r(d));var e=d.getId();
this.eventProperties[e]||(this.eventProperties[e]={});this.listeners[e]=this.listeners[e]||0;this.listeners[e]++;this.events.push(d);-1===this.listenerNames.indexOf(e)&&this.listenerNames.push(e);return d},removeEvent:function(d){if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(d)&&this.lockRemovals.push(d);else{var e=this.events.indexOf(d);-1!==e&&(d=d.getId(),this.events.splice(e,1),this.listeners[d]--,this.listeners[d]||(this.eventHandled[d]=!0,this.eventParameters[d]=
{},this.eventProperties[d]=[],this.eventPropertyCount[d]=0,e=this.listenerNames.indexOf(d),0<=e&&this.listenerNames.splice(e,1)))}},getProperties:function(d){this.eventParameters[d]=this.eventParameters[d]||{};return this.eventParameters[d]},setProperties:function(d,e){this.eventParameters[d]=e},getProperty:function(d,e){return this.getProperties(d)[e]},setProperty:function(d,e,c){this.getProperties(d)[e]=c},hasEvent:function(d){return!!this.listeners[d]},triggerEvent:function(d,e){if(!this.listeners[d])return null;
this.eventProperties[d]==o&&(this.eventProperties[d]=[]);var c=this.eventProperties[d];this.eventPropertyCount[d]===o&&(this.eventPropertyCount[d]=0);var n=this.eventPropertyCount[d];20<n&&console.log("Warning, event "+d+" count > 20: "+n);c[n]=e&&c?e:c[n]||{};this.eventPropertyCount[d]++;this.eventHandled[d]=!1;return c[n]},update:function(d){var e,c,n,a,b,g;if(this.hasEvent(q.event.TICK)&&0===this.eventPropertyCount[q.event.TICK]&&(e=this.triggerEvent(q.event.TICK)))e.time=d,e.handler=this;this.lockState=
!0;e=0;for(c=this.events.length;e<c;e++){b=this.events[e];g=b.getId();a=this.eventPropertyCount[g];var l=!1;n=!1;if(a){var m=this.eventProperties[g];if(b.isEnabled()){if(b.isBuffered()){if(m.length=a,b.setEventProperties(m),l=l||b.update(d,this),b.isChainBroken()){b.breakChain(!1);break}}else for(n=0;n<a;n++)if(b.setEventProperties(m[e]),l=l||b.update(d,this),b.isChainBroken()){b.breakChain(!1);break}n=!0}}if(l||!n)this.eventHandled[g]=!0}e=0;for(c=this.listenerNames.length;e<c;e++)g=this.listenerNames[e],
this.eventHandled[g]&&(this.eventPropertyCount[g]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){e=0;for(c=this.lockRemovals.length;e<c;e++)this.removeEvent(this.lockRemovals[e]);this.lockRemovals.length=0}}};return{Event:r,EventHandler:m,registerEvent:function(f){f=f.toUpperCase();q.event[f]!==o?d("Error, event '"+f+"' is already registered."):(q.event[f]=q.event.ENUM_MAX,q.event.ENUM_MAX++)},validateEvent:v}});
CubicVR.RegisterModule("Scene",function(h){function v(c,a){return c.light_type-a.light_type}function r(c,a){var b=null,d;c!==q&&null!==c?c.compile?b={}:(b=h.get(c)||{},c=null):b={};this.morphWeight=b.morphWeight||0;this.morphSource=b.morphSource||-1;this.morphTarget=b.morphTarget||-1;this.position=b.position===q?[0,0,0]:b.position;this.rotation=b.rotation===q?[0,0,0]:b.rotation;this.scale=b.scale===q?[1,1,1]:b.scale;this.shadowCast=b.shadowCast===q?!0:b.shadowCast;this.wireframe=b.wireframe||!1;this.pointMode=
b.pointMode||!1;this.motion=b.motion===q?null:h.get(b.motion,h.Motion)||null;this.obj=!b.mesh?c?h.get(c,h.Mesh):null:h.get(b.mesh,h.Mesh);this.name=b.name===q?a!==q?a:null:b.name;this.properties=h.get(b.properties)||{};this.parent=this.children=null;var l=b.children||b.child||b.sceneObject||b.sceneObjects;if(l){if(l&&!l.length||"string"===typeof l)l=[l];if(l.length){b=0;for(d=l.length;b<d;b++)this.bindChild(h.get(l[b],h.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=
[0,0,0];this.lscale=[0,0,0];this.lMatrix=e.identity();this.tMatrix=e.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function m(e,a,b,d,l,f){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=
[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if("object"===typeof e||"string"===typeof e){e=h.get(e);this.octree=e.octree;this.skybox=e.skybox||null;this.name=e.name||"scene"+c;this.wireframe=e.wireframe||!1;this.pointMode=e.pointMode||!1;this.destroy=e.destroy||function(){};this.update=e.update||function(){};this.enable=e.enable||function(){};this.disable=e.disable||function(){};a=e.setup&&e.setup(this)||{};this.update=a.update||this.update;this.enable=a.enable||this.enable;
this.disable=a.disable||this.disable;this.destroy=a.destroy||this.destroy;if((d=e.sceneObjects||e.sceneObject||e.objects)&&!d.length||"string"===typeof d)d=CubicVR.get(d),"object"==typeof d&&!d.length&&(d=[d]);if(d&&d.length){a=0;for(b=d.length;a<b;a++)this.bindSceneObject(h.get(d[a],h.SceneObject))}if((d=e.lights||e.light)&&!d.length||"string"===typeof d)d=CubicVR.get(d),"object"==typeof d&&!d.length&&(d=[d]);if(d&&d.length){a=0;for(b=d.length;a<b;a++)this.bindLight(h.get(d[a],h.Light))}if((d=e.cameras||
e.camera)&&!d.length||"string"===typeof d)d=[d],d=CubicVR.get(d),"object"==typeof d&&!d.length&&(d=[d]);if(d&&d.length){a=0;for(b=d.length;a<b;a++)this.bindCamera(h.get(d[a],h.Camera));this.camera=this.cameras[0]}d||(this.camera=new h.Camera(e.width,e.height,e.fov,e.nearclip,e.farclip))}else this.skybox=null,this.octree=f,this.name="scene"+c,this.camera=new h.Camera(e,a,b,d,l),this.wireframe=!1;this.paused=!1;++c}function o(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr=
{};this.meshBinPtr={}}var q=h.undef,d=h.enums,f=h.GLCore,e=h.mat4;r.prototype={get x(){return this.position[0]},set x(c){this.position[0]=c},get y(){return this.position[1]},set y(c){this.position[1]=c},get z(){return this.position[2]},set z(c){this.position[2]=c},get rotX(){return this.rotation[0]},set rotX(c){this.rotation[0]=c},get rotY(){return this.rotation[1]},set rotY(c){this.rotation[1]=c},get rotZ(){return this.rotation[2]},set rotZ(c){this.rotation[2]=c},get pos(){return this.position.slice(0)},
set pos(c){this.position=c.slice(0)},get rot(){return this.rotation.slice(0)},set rot(c){this.rotation=c.slice(0)},get sclX(){return this.scale[0]},set sclX(c){this.scale[0]=c},get sclY(){return this.scale[1]},set sclY(c){this.scale[1]=c},get sclZ(){return this.scale[2]},set sclZ(c){this.scale[2]=c},get scl(){return this.scale.slice(0)},set scl(c){this.scale=c.slice(0)},clone:function(){var c,a;c=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var b=new h.SceneObject({name:c,
mesh:this.obj,position:this.position.slice(0),rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,pointMode:this.pointMode,motion:this.motion?this.motion.clone():null});if(null!==this.instanceMaterials){b.instanceMaterials=[];c=0;for(a=this.instanceMaterials.length;c<a;c++)b.instanceMaterials[c]=this.instanceMaterials[c].clone()}if(null!==this.children){c=
0;for(a=this.children.length;c<a;c++)b.bindChild(this.children[c].clone())}return b},evaluate:function(c){var a,b;this.independentMotion=!0;this.motion&&this.motion.apply(c,this);if(null!==this.children){a=0;for(b=this.children.length;a<b;a++)this.children[a].evaluate(c)}},isWireframe:function(){return this.wireframe},setWireframe:function(c){this.wireframe=c},setPointMode:function(c){this.pointMode=c},isPointMode:function(){return this.pointMode},addEvent:function(c){this.eventHandler||(this.eventHandler=
new h.EventHandler);c=this.eventHandler.addEvent(c);c.setSubject(this);return c},removeEvent:function(c){this.eventHandler&&this.eventHandler.removeEvent(c)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},setMesh:function(c){this.obj=c},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(c){this.properties=c},getProperty:function(c){return this.properties[c]},setProperty:function(c,a){this.properties[c]=
a},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var c=0,a=this.obj.materials.length;c<a;c++)this.instanceMaterials[c]=this.obj.materials[c].clone();return this.instanceMaterials},getInstanceMaterial:function(c){for(var a=this.getInstanceMaterials(),b=0,d=a.length;b<d;b++)if(a[b].name==c)return a[b];return null},setMorphSource:function(c){this.morphSource=c},setMorphTarget:function(c){this.morphTarget=
c},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(c){this.morphWeight=c},morphTargetCount:function(){return null!==this.obj.morphTargets?this.obj.morphTargets.length:0},setMatrixLock:function(c){this.matrixLock=c},getMatrixLock:function(){return this.matrixLock},setMatrix:function(c){c?(this.tMatrix=c.slice(0),this.matrixLock=!0,this.hasEvents()&&(c=this.getEventHandler(),c.hasEvent(d.event.MATRIX_UPDATE)&&(c.triggerEvent(d.event.MATRIX_UPDATE).matrix=
this.tMatrix))):this.matrixLock=!1},doTransform:function(c){var a=h.vec3;if(!this.matrixLock&&(!a.equal(this.lposition,this.position)||!a.equal(this.lrotation,this.rotation)||!a.equal(this.lscale,this.scale)||c!==q))c!==q?this.tMatrix=c.slice(0):e.identity(this.tMatrix),e.identity(this.lMatrix),e.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),e.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||
e.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),e.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(c=this.getEventHandler(),c.hasEvent(d.event.MOVE)&&
(c=c.triggerEvent(d.event.MOVE),c.oldPosition=this.lposition,c.position=this.position,c.oldRotation=this.lrotation,c.rotation=this.rotation,c.oldScale=this.lscale,c.scale=this.scale))},bindChild:function(c){null===this.children&&(this.children=[]);c.parent=this;this.children.push(c)},control:function(c,a,b){c===d.motion.POS?this.position[a]=b:c===d.motion.SCL?this.scale[a]=b:c===d.motion.ROT&&(this.rotation[a]=b)},getAABB:function(){var c=h.mat4,a=h.vec3;if(this.dirty){var b=Array(8);this.doTransform();
var d,e;if(this.obj){if(!this.obj.bb)return this.aabb=[a.add([-1,-1,-1],this.position),a.add([1,1,1],this.position)];d=this.obj.bb[0];e=this.obj.bb[1]}if(!this.obj||d===q||e===q)return this.aabb=[a.add([-1,-1,-1],this.position),a.add([1,1,1],this.position)];var f=d;d=a.subtract(e,d);b[0]=[f[0],f[1],f[2]];b[1]=[f[0],f[1],f[2]+d[2]];b[2]=[f[0]+d[0],f[1],f[2]];b[3]=[f[0]+d[0],f[1],f[2]+d[2]];b[4]=[f[0],f[1]+d[1],f[2]];b[5]=[f[0],f[1]+d[1],f[2]+d[2]];b[6]=[f[0]+d[0],f[1]+d[1],f[2]];b[7]=[f[0]+d[0],f[1]+
d[1],f[2]+d[2]];f=c.vec3_multiply(b[0],this.tMatrix);d=[f[0],f[1],f[2]];e=[f[0],f[1],f[2]];for(a=1;8>a;++a)f=c.vec3_multiply(b[a],this.tMatrix),d[0]>f[0]&&(d[0]=f[0]),d[1]>f[1]&&(d[1]=f[1]),d[2]>f[2]&&(d[2]=f[2]),e[0]<f[0]&&(e[0]=f[0]),e[1]<f[1]&&(e[1]=f[1]),e[2]<f[2]&&(e[2]=f[2]);this.aabb[0]=d;this.aabb[1]=e;this.dirty=!1}return this.aabb}};var c=0;m.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(c){this.wireframe=c},setPointMode:function(c){this.pointMode=c},isPointMode:function(){return this.pointMode},
setSkyBox:function(c){this.skybox=c},getSceneObject:function(c){return this.sceneObjectsByName[c]},bindSceneObject:function(c,a,b){if(-1==this.sceneObjects.indexOf(c)){this.sceneObjects.push(c);a!==q&&a&&this.pickables.push(c);null!==c.name&&(this.sceneObjectsByName[c.name]=c);if(c.children)for(var d=0,e=c.children.length;d<e;d++)this.bindSceneObject(c.children[d],a,b);return c}},removeLight:function(c){c=this.lights.indexOf(c);0<=c&&this.lights.splice(c,1)},removeSceneObject:function(c){var a;if(this.lockState)this.lockRemovals||
(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(c)&&this.lockRemovals.push(c);else if(a=this.sceneObjects.indexOf(c),0<=a&&this.sceneObjects.splice(a,1),a=this.pickables.indexOf(c),0<=a&&this.pickables.splice(a,1),null!==c.name&&this.sceneObjectsByName[c.name]!==q&&delete this.sceneObjectsByName[c.name],c.children){a=0;for(var b=c.children.length;a<b;a++)this.removeSceneObject(c.children[a])}},bindLight:function(c){this.lights.push(c);this.lights=this.lights.sort(v)},bindCamera:function(c){-1===
this.cameras.indexOf(c)&&(this.cameras.push(c),this.camerasByName[c.name]=c);this.camera=c},removeCamera:function(c){"object"!==typeof c&&(c=this.getCamera(camName));-1===this.cameras.indexOf(c)&&(this.cameras.push(c),this.camerasByName[c.name]=c);return c},bind:function(c,a){c instanceof h.Light?this.bindLight(c):c instanceof h.SceneObject?this.bindSceneObject(c,a):c instanceof h.Camera?this.bindCamera(c):c instanceof h.Vehicle?c.bindToScene(this):c instanceof h.RigidBody&&this.bindSceneObject(c.getSceneObject())},
remove:function(c){c instanceof h.Light?this.removeLight(c):c instanceof h.SceneObject?this.removeSceneObject(c):c instanceof h.Camera?this.removeCamera(c):c instanceof bsae.RigidBody&&this.removeSceneObject(c.getSceneObject())},setCamera:function(c){c&&("object"!==typeof c&&(c=this.getCamera(c)),this.camera=c)},getCamera:function(c){return c===q?this.camera:this.camerasByName[c]},evaluate:function(c){var a,b;a=0;for(b=this.sceneObjects.length;a<b;a++)this.sceneObjects[a].motion&&!this.sceneObjects[a].independentMotion&&
this.sceneObjects[a].motion.apply(c,this.sceneObjects[a]);null!==this.camera.motion&&(null!==this.camera.targetSceneObject&&(this.camera.target=this.camera.targetSceneObject.position),this.camera.motion.apply(c,this.camera));a=0;for(b=this.lights.length;a<b;a++){var d=this.lights[a];null!==d.motion&&d.motion.apply(c,d)}},prepareTransforms:function(c){var a,b;if(c){if(c.doTransform(),c.children){a=0;for(b=c.children.length;a<b;a++)c.children[a].doTransform(c.tMatrix),this.prepareTransforms(c.children[a])}}else if(0!==
this.sceneObjects.length){a=0;for(b=this.sceneObjects.length;a<b;++a)this.prepareTransforms(this.sceneObjects[a])}},updateShadows:function(c,a){var b=f.gl,a=a||this.camera;if(this.shadows_updated)return!1;c||this.doTransform();this.shadows_updated=!0;if(h.features.lightShadows){for(var e=b.getParameter(b.FRAMEBUFFER_BINDING),l=!1,m=b.getParameter(b.VIEWPORT),o=0,q=this.lights.length;o<q;o++){var s=this.lights[o];if(s.light_type==d.light.type.SPOT_SHADOW||s.light_type==d.light.type.SPOT_SHADOW_PROJECTOR||
s.light_type==d.light.type.AREA){var l=!0,r=[new h.Light(d.light.type.DEPTH_PACK)];s.light_type===d.light.type.AREA&&(s.areaCam=a,s.updateAreaLight());f.shadow_near=s.dummyCam.nearclip;f.shadow_far=s.dummyCam.farclip;s.shadowBegin();for(var A=0,H=this.sceneObjects.length;A<H;A++){var B=this.sceneObjects[A];B.parent||!1===B.visible||!1===B.shadowCast||this.renderSceneObject(B,s.dummyCam,r,!1,!0)}s.shadowEnd();e&&b.bindFramebuffer(b.FRAMEBUFFER,e)}}l&&b.viewport(m[0],m[1],m[2],m[3])}},updateCamera:function(c){c=
c||this.camera;!1===c.manual&&(c.targeted?c.lookat(c.position[0],c.position[1],c.position[2],c.target[0],c.target[1],c.target[2],0,1,0):c.calcProjection());f.depth_alpha_near=c.nearclip;f.depth_alpha_far=c.farclip},resize:function(c,a){this.camera&&this.camera.setDimensions(c,a)},doTransform:function(){for(var c=0,a=this.sceneObjects.length;c<a;c++){var b=this.sceneObjects[c];null===b.parent&&this.prepareTransforms(b)}},renderSceneObject:function(c,a,b,d,e,m,o){var x=!1,s=f.gl,d=d!==q&&d,e=e||!1,
m=m||!1;if(c.visible&&c.obj){0>c.scale[0]&&(x=!x);0>c.scale[1]&&(x=!x);0>c.scale[2]&&(x=!x);x&&s.cullFace(s.FRONT);var r=c.obj;null!==r.morphTargets&&(-1!==c.morphSource&&r.setMorphSource(c.morphSource),-1!==c.morphTarget&&r.setMorphTarget(c.morphTarget),null!==c.morphWeight&&(r.morphWeight=c.morphWeight));c.instanceMaterials&&r.bindInstanceMaterials(c.instanceMaterials);h.renderObject(r,a,c.tMatrix,b,e,m,this.isWireframe()||c.isWireframe(),this.isPointMode()||c.isPointMode())&&o&&o.push(c);c.instanceMaterials&&
r.bindInstanceMaterials(null);x&&s.cullFace(s.BACK)}c=c.children;if(d&&c){d=0;for(x=c.length;d<x;d++)this.renderSceneObject(c[d],a,b,!0,e,m,o)}},runEvents:function(c){var a,b;this.lockState=!0;c.getSeconds&&(c=c.getSeconds());a=0;for(b=this.sceneObjects.length;a<b;a++){var d=this.sceneObjects[a];d.hasEvents()&&d.getEventHandler().update(c)}this.lockState=!1;if(this.lockRemovals){a=0;for(b=this.lockRemovals.length;a<b;a++)this.removeSceneObject(this.lockRemovals[a])}this.lockRemovals=null},render:function(c){++this.frames;
c=c||{};c.postProcess&&c.postProcess.begin(!c.postBuffer);var a=c.camera||this.camera,b=f.gl;this.lights_rendered=0;this.doTransform();this.updateCamera(a);this.updateShadows(!0);this.shadows_updated=!1;var d,l;d=0;for(l=this.lights.length;d<l;d++)this.lights[d].prepare(a);this.objects_rendered=0;var m=[],o=[],q=this.lights;d=0;for(l=this.sceneObjects.length;d<l;d++){var s=this.sceneObjects[d];!1===s.visible||null!==s.parent||this.renderSceneObject(s,a,q,!0,!0,!1,o)}d=0;for(l=o.length;d<l;d++)this.renderSceneObject(o[d],
a,q,!1,!1,!0);this.collect_stats&&(this.stats["objects.num_rendered"]=this.objects_rendered,this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=m,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length);null!==this.skybox&&!0===this.skybox.ready&&(b.cullFace(b.FRONT),d=2*a.farclip/Math.sqrt(3),this.skybox.scene_object.position=a.parent?e.vec3_multiply(a.position,a.parent.tMatrix):[a.position[0],a.position[1],
a.position[2]],this.skybox.scene_object.scale=[d,d,d],this.skybox.scene_object.doTransform(),h.renderObject(this.skybox.scene_object.obj,a,this.skybox.scene_object.tMatrix,[]),b.cullFace(b.BACK));c.postProcess&&(c.postProcess.end(),c.postBuffer||c.postProcess.render())},bbRayTest:function(c,a,b,d){var e=h.vec3,f=[],d=d||this.camera,a=2===a.length?d.unProject(a[0],a[1]):e.add(c,a),m;for(m in this.pickables)if(this.pickables.hasOwnProperty(m)&&(d=this.pickables[m],!0===d.visible)){var o,s;s=d.getAABB();
o=s[0];s=s[1];0.2>s[0]-o[0]&&(o[0]-=0.1,s[0]+=0.1);0.2>s[1]-o[1]&&(o[1]-=0.1,s[1]+=0.1);0.2>s[2]-o[2]&&(o[2]-=0.1,s[2]+=0.1);var q=e.multiply(e.add(o,s),0.5),r=e.getClosestTo(c,a,q),q=e.length(e.subtract(r,q));(r[0]>=o[0]&&r[0]<=s[0]?1:0)+(r[1]>=o[1]&&r[1]<=s[1]?1:0)+(r[2]>=o[2]&&r[2]<=s[2]?1:0)>=b&&f.push({dist:q,obj:d})}f.length&&f.sort(function(a,b){return a.dist==b.dist?0:a.dist<b.dist?-1:1});return f}};o.prototype={addMesh:function(c,a,b){this.meshBin[c]===q&&(this.meshBin[c]=[],this.meshBinPtr[c]===
q&&(this.meshBinPtr[c]=0));this.meshMap[a]===q&&(this.meshMap[a]=b,this.meshBin[c].push(b))},addImage:function(c,a,b){this.imageBin[c]===q&&(this.imageBin[c]=[],this.imageBinPtr[c]===q&&(this.imageBinPtr[c]=0));this.imageMap[a]===q&&(this.imageMap[a]=b,this.imageBin[c].push(b))},getMeshes:function(c){return this.meshBin[c]},getImages:function(c){return this.imageBin[c]},rewindMeshes:function(c){this.meshBinPtr[c]=0},rewindImages:function(c){this.imageBinPtr[c]=0},getNextMesh:function(c){var a=this.meshBinPtr[c];
return a<this.meshBin[c].length?(this.meshBinPtr[c]++,this.meshBin[c][a]):null},loadNextMesh:function(c){c=this.getNextMesh(c);return null!==c?(null===c.compiled&&(c.triangulateQuads(),c.compile(),c.clean()),!0):!1},isMeshBinEmpty:function(c){return this.meshBinPtr[c]===this.meshBin[c].length},loadNextImage:function(c){c=this.getNextImage(c);null!==c&&(c.src=c.deferredSrc)},getNextImage:function(c){var a=this.imageBinPtr[c];return a<this.imageBin[c].length?(this.imageBinPtr[c]++,this.imageBin[c][a]):
null},isImageBinEmpty:function(c){return this.imageBinPtr[c]===this.imageBin[c].length}};return{Scene:m,SceneObject:r,SkyBox:function(c){var a=c.texture,c=c.mapping,b=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){a.onready=null;var c=1/h.Images[b.texture.tex_id].width;null===b.mapping&&(b.mapping=[[1/3,0.5,2/3-c,1],[0,0.5,1/3,1],[0,0,1/3-c,0.5],[2/3,0,1,0.5],[2/3+c,0.5,1,1],[1/3,0,2/3,0.5]]);var c=new h.Material({name:"skybox",textures:{color:a},noFog:!0}),d=new h.Mesh;
d.sky_mapping=b.mapping;h.primitives.box({mesh:d,size:1,material:c,uvmapper:{projectionMode:h.enums.uv.projection.SKY,scale:[1,1,1]}});d.prepare();b.scene_object=new h.SceneObject(d);b.ready=!0};if(a&&("string"===typeof a?a=new h.Texture(a,null,null,null,this.onready):a.loaded||(a.onready=this.onready),this.texture=a,c))this.mapping=c,this.onready()},DeferredBin:o}});
CubicVR.RegisterModule("PostProcess",function(h){function v(c){if(c.shader_vertex===o||c.shader_fragment===o)return null;this.outputMode=c.outputMode===o?d.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,c.outputMode);this.onresize=c.onresize===o?null:c.onresize;this.onupdate=c.onupdate===o?null:c.onupdate;this.init=c.init===o?null:c.init;this.enabled=c.enabled===o?!0:c.enabled;this.outputDivisor=c.outputDivisor===o?1:c.outputDivisor;this.shader=new CubicVR.Shader(c.shader_vertex,
c.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function r(c,d,a){var b=q.gl;this.width=c;this.height=d;this.accum=a===o?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(c,d,!0);this.bufferA=new CubicVR.RenderBuffer(c,d,!1);this.bufferB=new CubicVR.RenderBuffer(c,
d,!1);this.bufferC=new CubicVR.RenderBuffer(c,d,!1);this.accumOpacity=1;this.accumIntensity=0.3;this.accum&&(this.accumBuffer=new CubicVR.RenderBuffer(c,d,!1),this.accumBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT),this.blur_shader=new v({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}}));this.bufferA.use();b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.bufferB.use();b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new v({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(c,d)}function m(c,d,a){this.createBuffer(c,d,a)}var o=h.undef,q=h.GLCore,d=CubicVR.enums;d.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var f=[],e=[];r.prototype={setBlurOpacity:function(c){this.accumOpacity=c},setBlurIntensity:function(c){this.accumIntensity=c},makeFSQuad:function(c,d){var a=q.gl,b={},e=c/c,l=d/d;b.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);b.vbo_uvs=new Float32Array([0,0,e,0,e,l,0,l,0,0,e,l]);b.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,
b.gl_points);a.bufferData(a.ARRAY_BUFFER,b.vbo_points,a.STATIC_DRAW);b.gl_uvs=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_uvs);a.bufferData(a.ARRAY_BUFFER,b.vbo_uvs,a.STATIC_DRAW);return b},destroyFSQuad:function(c){var d=q.gl;d.deleteBuffer(c.gl_points);d.deleteBuffer(c.gl_uvs)},renderFSQuad:function(c,d){var a=q.gl;c.use();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);a.bindBuffer(a.ARRAY_BUFFER,d.gl_points);a.vertexAttribPointer(c.aVertex,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(c.aVertex);
a.bindBuffer(a.ARRAY_BUFFER,d.gl_uvs);a.vertexAttribPointer(c.aTex,2,a.FLOAT,!1,0,0);a.enableVertexAttribArray(c.aTex);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);a.drawArrays(a.TRIANGLES,0,6)},addShader:function(c){this.shaders[this.shaders.length]=c;c.shader.use();c.shader.setVector("texel",this.vTexel);if(c.outputDivisor&&1!=c.outputDivisor&&f[c.outputDivisor]===o){var d=this.width/c.outputDivisor|0,a=this.height/c.outputDivisor|0;f[c.outputDivisor]=new CubicVR.RenderBuffer(d,a,!1);e[c.outputDivisor]=
this.makeFSQuad(d,a)}},resize:function(c,d){var a=q.gl;this.width=c;this.height=d;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT));for(var b in f){var a=this.width/b|0,g=this.height/b|0;f[b].destroyBuffer();f[b].createBuffer(a,g,!1);this.destroyFSQuad(e[b]);e[b]=this.makeFSQuad(a,g)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;b=0;for(a=this.shaders.length;b<a;b++)if(this.shaders[b].shader.use(),this.shaders[b].shader.setVector("texel",this.vTexel),null!==this.shaders[b].onresize)this.shaders[b].onresize(this.shaders[b].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var c=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=c},begin:function(c){var d=q.gl;this.captureBuffer.use();c&&(this.captureBuffer.depth?d.clear(d.DEPTH_BUFFER_BIT|d.COLOR_BUFFER_BIT):d.clear(d.COLOR_BUFFER_BIT))},end:function(){var c=q.gl;c.bindFramebuffer(c.FRAMEBUFFER,null)},render:function(){var c=q.gl;this.captureBuffer.texture.use(c.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(c.TEXTURE0);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var n=0,a=0,b=this.shaders.length;a<b;a++){var g=this.shaders[a];if(g.enabled){this.swap();this.inputBuffer.texture.use(c.TEXTURE0);var l=g.outputMode;if(l===d.post.output.REPLACE)1!==g.outputDivisor?f[g.outputDivisor].use():this.outputBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);else if(l===d.post.output.ADD||
l===d.post.output.BLEND)1!==g.outputDivisor?f[g.outputDivisor].use():this.bufferC.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);null!==g.onupdate&&(g.shader.use(),g.onupdate(g.shader));1!==g.outputDivisor?(c.viewport(0,0,f[g.outputDivisor].width,f[g.outputDivisor].height),this.renderFSQuad(g.shader,e[g.outputDivisor]),g.outputMode===d.post.output.REPLACE?(this.outputBuffer.use(),f[g.outputDivisor].texture.use(c.TEXTURE0),c.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):c.viewport(0,0,this.width,this.height)):this.renderFSQuad(g.shader,this.fsQuad);l===d.post.output.BLEND?(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(c.TEXTURE0),1!==g.outputDivisor?f[g.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND)):l===d.post.output.ADD&&(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),
c.blendFunc(c.ONE,c.ONE),1!==g.outputDivisor?f[g.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND));this.end();n++}}0===n?this.captureBuffer.texture.use(c.TEXTURE0):this.outputBuffer.texture.use(c.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),c.disable(c.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(c.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),c.disable(c.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};m.prototype={createBuffer:function(c,
d,a){this.texture=this.depth=this.fbo=null;this.width=parseInt(c,10);this.height=parseInt(d,10);var c=this.sizeParam(c),d=this.sizeParam(d),b=q.gl;this.fbo=b.createFramebuffer();a&&(this.depth=b.createRenderbuffer());b.bindFramebuffer(b.FRAMEBUFFER,this.fbo);a&&(b.bindRenderbuffer(b.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,c,d),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,this.depth)):
(b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_STENCIL,c,d),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,b.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;b.bindTexture(b.TEXTURE_2D,h.Textures[this.texture.tex_id]);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.texImage2D(b.TEXTURE_2D,
0,b.RGBA,c,d,0,b.RGBA,b.UNSIGNED_BYTE,null);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,h.Textures[this.texture.tex_id],0);b.bindFramebuffer(b.FRAMEBUFFER,null)},destroyBuffer:function(){var c=q.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.deleteRenderbuffer(this.depth);c.deleteFramebuffer(this.fbo);c.deleteTexture(h.Textures[this.texture.tex_id]);h.Textures[this.texture.tex_id]=null},sizeParam:function(c){return c},use:function(){var c=q.gl;c.bindFramebuffer(c.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:m,PostProcessShader:v,PostProcessChain:r,fsQuad:{make:r.prototype.makeFSQuad,destroy:r.prototype.destroyFSQuad,render:r.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function h(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function v(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;
this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}h.prototype={addSubview:function(h){this.childViews.push(h);h.superView=this},makePanel:function(h){return this.superView.makePanel(h)}};v.prototype={resize:function(h,m){this.width=h;this.height=m},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(h){h.setInt("srcTex",0);h.addVector("screen");h.addVector("position");h.addVector("tint");h.addVector("size")}})},addSubview:function(h){this.childViews.push(h);h.superView=this},removeSubview:function(h){h=this.childViews.indexOf(h);-1<h&&this.childViews.splice(h,
1)},makePanel:function(h){var m=CubicVR.GLCore.gl,o={};o.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);o.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);o.gl_points=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,o.gl_points);m.bufferData(m.ARRAY_BUFFER,o.vbo_points,m.STATIC_DRAW);o.gl_uvs=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,o.gl_uvs);m.bufferData(m.ARRAY_BUFFER,o.vbo_uvs,m.STATIC_DRAW);h.panel=o},renderPanel:function(h){if(!h.texture)return!1;h.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(h){if(h.texture){var m=CubicVR.GLCore.gl,o=h.offsetLeft,q=h.offsetTop;o||(o=0);q||(q=0);var d=this.shader.shader;d.use();d.setVector("screen",[this.width,this.height,0]);d.setVector("position",[h.x+o,h.y+q,0]);d.setVector("size",[h.width,h.height,0]);d.setVector("tint",h.tint);h.blend&&(m.enable(m.BLEND),m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA));h.texture.use(m.TEXTURE0);m.drawArrays(m.TRIANGLES,0,6);h.blend&&(m.disable(m.BLEND),m.blendFunc(m.ONE,m.ZERO))}},render:function(){var h=
CubicVR.GLCore.gl;h.disable(h.DEPTH_TEST);this.texture&&this.renderView(this);var m=[];this.offsetTop=this.offsetLeft=0;m.push(this);var o=this.shader.shader;o.use();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_points);h.vertexAttribPointer(o.uniforms.aVertex,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(o.uniforms.aVertex);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_uvs);h.vertexAttribPointer(o.uniforms.aTex,2,h.FLOAT,!1,0,0);h.enableVertexAttribArray(o.uniforms.aTex);
for(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);m.length;){var q=m.pop();this.renderView(q);if(q.childViews.length)for(var d=q.childViews.length-1;0<=d;d--)q.childViews[d].offsetLeft=q.x+q.offsetLeft,q.childViews[d].offsetTop=q.y+q.offsetTop,m.push(q.childViews[d])}h.disableVertexAttribArray(o.uniforms.aTex);h.enable(h.DEPTH_TEST)}};return{Layout:v,View:h}});
CubicVR.RegisterModule("Primitives",function(h){function v(c,d,e,g,f,n){var m=h.mat4,o=h.vec3,q=[],t,w=[0,1,0],r=[1,0,0],v=[0,0,0],D=c.points.length,F,y,I;for(F=t=0;F<b&&t!==e;F+=b/e){r=[Math.cos(F),0,Math.sin(F)];y=0;for(I=d.length;y<I;y++)v=o.add(o.multiply(r,d[y][0]),o.multiply(w,d[y][1])),q[t]===a&&(q[t]=[]),q[t].push(v);t++}I=null;f!==a&&(I=f.getResult!==a?f.getResult():f);for(y=0;y<e;y++){f=0;for(t=d.length;f<t;f++)I?c.addPoint(m.vec3_multiply(q[y][f],I)):c.addPoint(q[y][f])}"string"===typeof g&&
(g=new h.Material(g));c.setFaceMaterial(g);for(f=0;f<e;f++){y=0;for(I=d.length-1;y<I;y++)m=y+d.length*f,q=y+d.length*((f+1)%e),o.equal(c.points[D+m],c.points[D+q])?c.addFace([D+m+1,D+q+1,D+q]):o.equal(c.points[D+m+1],c.points[D+q+1])?c.addFace([D+m,D+m+1,D+q]):c.addFace([D+m,D+m+1,D+q+1,D+q])}n!==a&&(d=null,n.apply!==a?d=n:n&&(d=new h.UVMapper(n)),null!==d&&(c.calcFaceNormals(),d.apply(c,g)))}function r(c,b,d,e,f){var g=h.mat4,b=0.5*b,n=c.points.length;"string"===typeof d&&(d=new h.Material(d));c.setFaceMaterial(d);
e!==a?(e=e.getResult!==a?e.getResult():e,c.addPoint([g.vec3_multiply([b,-b,0],e),g.vec3_multiply([b,b,0],e),g.vec3_multiply([-b,b,0],e),g.vec3_multiply([-b,-b,0],e)])):c.addPoint([[b,-b,0],[b,b,0],[-b,b,0],[-b,-b,0]]);c.addFace([[n+0,n+1,n+2,n+3],[n+3,n+2,n+1,n+0]]);f!==a&&(g=null,f.apply!==a?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(c.calcFaceNormals(),g.apply(c,d)))}function m(c,b,d,e,f){var g=h.mat4,n,m;"object"===typeof b?(n=b[0]/2,m=b[1]/2,b=b[2]/2):n=m=b/=2;var o=c.points.length;"string"===typeof d&&
(d=new h.Material(d));c.setFaceMaterial(d);e!==a?(e=e.getResult!==a?e.getResult():e,c.addPoint([g.vec3_multiply([n,-m,b],e),g.vec3_multiply([n,m,b],e),g.vec3_multiply([-n,m,b],e),g.vec3_multiply([-n,-m,b],e),g.vec3_multiply([n,-m,-b],e),g.vec3_multiply([n,m,-b],e),g.vec3_multiply([-n,m,-b],e),g.vec3_multiply([-n,-m,-b],e)])):c.addPoint([[n,-m,b],[n,m,b],[-n,m,b],[-n,-m,b],[n,-m,-b],[n,m,-b],[-n,m,-b],[-n,-m,-b]]);c.addFace([[o+0,o+1,o+2,o+3],[o+7,o+6,o+5,o+4],[o+4,o+5,o+1,o+0],[o+5,o+6,o+2,o+1],[o+
6,o+7,o+3,o+2],[o+7,o+4,o+0,o+3]]);f!==a&&(g=null,f.apply!==a?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(c.calcFaceNormals(),g.apply(c,d)))}function o(a,c,d,e,g,f,n,m){for(var o=[],d=d-c,c=c+d/2,q=b/g,w=0,r=0;r<=g;r++)o.push([c+Math.cos(w)*d,Math.sin(w)*d,0]),w+=q;h.genLatheObject(a,o,e,f,n,m)}function q(a,c,b,d,e,g,f){h.genLatheObject(a,[[0,-b/2,0],[c/2,-b/2,0],[0,b/2,0]],d,e,g,f)}function d(a,c,b,d,e,g,f){h.genLatheObject(a,[[0,-b/2,0],[c,-b/2,0],[c,b/2,0],[0,b/2,0]],d,e,g,f)}function f(a,c,b,d,e,
f,n){for(var m=[],d=(d/=2)|0,b=b|0,o=Math.PI/d,q=-g,w=0;w<=d;w++)m.push([Math.cos(q)*c,Math.sin(q)*c,0]),q+=o;h.genLatheObject(a,m,b,e,f,n)}function e(c){"string"===typeof c&&(c=h.get(c,h.Material));return c===a?new h.Material:c.use?c:"object"===typeof c?new h.Material(c):new h.Material}function c(c){if(c===a)return a;if("array"===typeof c)return c;if("object"===typeof c)return c.getResult?c.getResult():c.position||c.rotation||c.scale?h.mat4.transform(c.position,c.rotation,c.scale):a}function n(c){"string"===
typeof c&&(c=h.get(c));return c===a?a:c.apply?c:"object"===typeof c?new h.UVMapper(c):a}var a=h.undef,b=2*Math.PI,g=Math.PI/2;return{genPlaneObject:r,genBoxObject:m,genLatheObject:v,genTorusObject:o,genConeObject:q,genCylinderObject:d,genSphereObject:f,primitives:{lathe:function(b){var d,g,f,m;if(b.points==a)return null;d=b.mesh!==a?b.mesh:new h.Mesh(b.name!==a?b.name:a);g=e(b.material);f=c(b.transform);m=n(b.uvmapper||b.uv);v(d,b.points,b.divisions!==a?b.divisions:24,g,f,m);return d},box:function(b){var d,
g,f,o;d=b.mesh!==a?b.mesh:new h.Mesh(b.name!==a?b.name:a);g=e(b.material);f=c(b.transform);o=n(b.uvmapper||b.uv);m(d,b.size!==a?b.size:1,g,f,o);return d},plane:function(b){var d,g,f,m;d=b.mesh!==a?b.mesh:new h.Mesh(b.name!==a?b.name:a);g=e(b.material);f=c(b.transform);m=n(b.uvmapper||b.uv);r(d,b.size!==a?b.size:1,g,f,m);return d},sphere:function(b){var d,g,m,o;d=b.mesh!==a?b.mesh:new h.Mesh(b.name!==a?b.name:a);g=e(b.material);m=c(b.transform);o=n(b.uvmapper||b.uv);f(d,b.radius!==a?b.radius:1,b.lon!==
a?b.lon:24,b.lat!==a?b.lat:24,g,m,o);return d},torus:function(b){var d,g,f,m;d=b.mesh!==a?b.mesh:new h.Mesh(b.name!==a?b.name:a);g=e(b.material);f=c(b.transform);m=n(b.uvmapper||b.uv);o(d,b.innerRadius!==a?b.innerRadius:0.75,b.outerRadius!==a?b.outerRadius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,g,f,m);return d},cone:function(b){var d,g,f,m;d=b.mesh!==a?b.mesh:new h.Mesh(b.name!==a?b.name:a);g=e(b.material);f=c(b.transform);m=n(b.uvmapper||b.uv);q(d,b.base!==a?b.base:1,b.height!==a?b.height:1,b.lon!==
a?b.lon:24,g,f,m);return d},cylinder:function(b){var g,f,m,o;g=b.mesh!==a?b.mesh:new h.Mesh(b.name!==a?b.name:a);f=e(b.material);m=c(b.transform);o=n(b.uvmapper||b.uv);d(g,b.radius!==a?b.radius:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,f,m,o);return g}}}});
CubicVR.RegisterModule("COLLADA",function(h){function v(f,e){function c(b){return!b.color?!1:(b=b.color)?a.floatDelimArray(b.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function n(a){return!a["float"]?!1:a=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0}var a=h.util,b,g,l,o,E,x;x="object"==typeof f?f:-1!=f.indexOf(".js")?a.getJSON(f):h.util.xml2badgerfish(a.getXML(f));var s,G,A,H,v,t,w,z,C,D,F,y,I,J,K,L,M,X,fa,Q,Ca,O=x;x=null;if(!O.COLLADA)throw Error(f+" does not appear to be a valid COLLADA file.");
var O=O.COLLADA,N={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(O.asset){var pa=O.asset.up_axis.$;"X_UP"===pa?N.up_axis=0:"Y_UP"===pa?N.up_axis=1:"Z_UP"===pa&&(N.up_axis=2)}var fb=N.up_axis;if(O.library_images&&(O.library_images.image&&!O.library_images.image.length&&(O.library_images.image=[O.library_images.image]),O.library_images.image&&O.library_images.image.length))for(var gb=O.library_images.image,Ma=0,pb=gb.length;Ma<pb;Ma++){var Na=
gb[Ma],hb=Na["@id"],qb=Na["@name"],ac=Na.init_from;if(ac.$){var qa=ac.$;e!==r&&-1!==qa.lastIndexOf("/")&&(qa=qa.substr(qa.lastIndexOf("/")+1));e!==r&&-1!==qa.lastIndexOf("\\")&&(qa=qa.substr(qa.lastIndexOf("\\")+1));N.images[hb]={source:qa,id:hb,name:qb}}}var ib,rb,bc,U,Oa,ja,Pa,ba,P,V,S,Da,ga,Qa,Ra,Y,$;if(O.library_effects){var Sa=O.library_effects.effect;Sa&&!Sa.length&&(Sa=[Sa]);rb=0;for(bc=Sa.length;rb<bc;rb++){var Db=Sa[rb];ib=Db["@id"];var T={};T.id=ib;T.surfaces=[];T.samplers=[];(ba=Db.profile_COMMON.newparam)&&
!ba.length&&(ba=[ba]);if(ba){X=0;for(fa=ba.length;X<fa;X++){var ra=ba[X],Ta=ra["@sid"];if(ra.surface){T.surfaces[Ta]={};var cc=ra.surface.init_from.$;"object"===typeof N.images[cc]&&(T.surfaces[Ta].source=e+"/"+N.images[cc].source)}else if(ra.sampler2D&&(T.samplers[Ta]={},T.samplers[Ta].source=ra.sampler2D.source.$,ra.sampler2D.minfilter&&(T.samplers[Ta].minfilter=ra.sampler2D.minfilter.$),ra.sampler2D.magfilter))T.samplers[Ta].magfiter=ra.sampler2D.magfilter.$}}var ua=Db.profile_COMMON.technique;
ua&&!ua.length&&(ua=[ua]);T.material={textures_ref:[]};U=0;for(Oa=ua.length;U<Oa;U++){b=ua[U].blinn;b||(b=ua[U].phong);b||(b=ua[U].lambert);if(b)for(var ca in b){var sb=b[ca],sa=c(sb),dc=n(sb),Eb;Eb=sb.texture?sb.texture["@texture"]:!1;!1!==sa&&3<sa.length&&sa.pop();"emission"==ca?!1!==sa&&(T.material.ambient=sa):"ambient"!=ca&&("diffuse"==ca?!1!==sa&&(T.material.color=sa):"specular"==ca?!1!==sa&&(T.material.specular=sa):"shininess"==ca&&!1!==dc&&(T.material.shininess=dc));if(!1!==Eb){var Ua=T.surfaces[T.samplers[Eb].source].source;
"emission"==ca?T.material.textures_ref.push({image:Ua,type:m.texture.map.AMBIENT}):"ambient"==ca?T.material.textures_ref.push({image:Ua,type:m.texture.map.AMBIENT}):"diffuse"==ca?T.material.textures_ref.push({image:Ua,type:m.texture.map.COLOR}):"specular"==ca?T.material.textures_ref.push({image:Ua,type:m.texture.map.SPECULAR}):"shininess"!=ca&&("reflective"==ca?T.material.textures_ref.push({image:Ua,type:m.texture.map.REFLECT}):"reflectivity"!=ca&&"transparent"==ca&&T.material.textures_ref.push({image:Ua,
type:m.texture.map.ALPHA}))}}N.effects[ib]=T}}}var Fb=d.getAllOf(O,"instance_geometry"),tb=[];if(Fb.length){t=0;for(z=Fb.length;t<z;t++){var ec=Fb[t],Gb=d.getAllOf(ec,"instance_material");if(Gb.length){Q=0;for(Ca=Gb.length;Q<Ca;Q++){var fc=Gb[Q],Ic=fc["@symbol"],Jc=fc["@target"].substr(1);tb[ec["@url"].substr(1)+":"+Ic]=Jc}}}}var Hb=O.library_materials;if(Hb&&Hb.material){var Va=Hb.material;Va&&!Va.length&&(Va=[Va]);D=0;for(F=Va.length;D<F;D++){var Ib=Va[D],Kc=Ib["@id"],Lc=Ib["@name"],gc=Ib.instance_effect;
gc&&(ib=gc["@url"].substr(1),N.materials.push({id:Kc,name:Lc,mat:N.effects[ib].material}))}}var hc=O.library_geometries,Wa;if(hc){var ta=hc.geometry;ta&&!ta.length&&(ta=[ta]);if(ta.length)for(var jb=0,Mc=ta.length;jb<Mc;jb++){var la={id:r,points:[],parts:[]},Xa=ta[jb].mesh;if(Xa){Wa=ta[jb]["@id"];E=ta[jb]["@name"];var Ya=Xa.source;Ya&&!Ya.length&&(Ya=[Ya]);for(var R=[],Jb=0,Nc=Ya.length;Jb<Nc;Jb++){var ub=Ya[Jb];g=ub["@id"];var Oc=ub["@name"],Kb=ub.float_array;Kb&&(R[g]={id:g,name:Oc,data:a.floatDelimArray(Kb.$?
Kb.$:""," ")});var Lb=ub.technique_common.accessor;Lb&&(R[g].count=Lb["@count"]|0,R[g].stride=Lb["@stride"]|0,R[g].count&&(R[g].data=a.repackArray(R[g].data,R[g].stride,R[g].count)))}var Mb=Xa.vertices,kb=null,Nb=null,Ea=null,Fa=null,Ga=null;if(Mb&&(Nb=Mb["@id"],(P=Mb.input)&&!P.length&&(P=[P]),P)){ja=0;for(Pa=P.length;ja<Pa;ja++)V=P[ja],"POSITION"===V["@semantic"]&&(kb=V["@source"].substr(1))}var ma=Xa.triangles;ma&&!ma.length&&(ma=[ma]);if(ma){U=0;for(Oa=ma.length;U<Oa;U++){$={material:0,faces:[],
normals:[],texcoords:[],colors:[]};var Pc=parseInt(ma[U]["@count"],10);(P=ma[U].input)&&!P.length&&(P=[P]);S=[];if(P.length){ja=0;for(Pa=P.length;ja<Pa;ja++)V=P[ja],Y=parseInt(V["@offset"],10),o=V["@source"].substr(1),"VERTEX"===V["@semantic"]?(o===Nb&&(o=kb),S[Y]=0):"NORMAL"===V["@semantic"]?(Ea=o,R[Ea].count&&(S[Y]=1)):"TEXCOORD"===V["@semantic"]?(Ga=o,R[Ga].count&&(S[Y]=2)):"COLOR"===V["@semantic"]?(Fa=o,R[Fa].count&&(S[Y]=3)):S[Y]=4}H=S.length;l=Wa+":"+ma[U]["@material"];null===l?$.material=0:
tb[l]===r?(q("missing material ["+l+"]@"+Wa+"?"),$.material=0):$.material=tb[l];var ic=ma[U].p,va=[];ic&&(va=a.intDelimArray(ic.$," "));if(va.length&&(v=va.length/S.length/3,v===Pc)){0===la.points.length&&(la.points=R[kb].data);t=Y=0;z=va.length;for(C=S.length;t<z;t+=3*C){s=[];G=[];A=[];ha=[];for(Q=0;Q<3*C;Q++){var vb=Q%C;0===S[vb]?G.push(va[t+Q]):1===S[vb]?s.push(va[t+Q]):2===S[vb]?A.push(va[t+Q]):3===S[vb]&&ha.push(va[t+Q])}G.length&&($.faces.push(G),3===s.length&&$.normals.push([d.fixuaxis(N.up_axis,
R[Ea].data[s[0]]),d.fixuaxis(N.up_axis,R[Ea].data[s[1]]),d.fixuaxis(N.up_axis,R[Ea].data[s[2]])]),3===A.length&&$.texcoords.push([R[Ga].data[A[0]],R[Ga].data[A[1]],R[Ga].data[A[2]]]),3===ha.length&&$.colors.push([R[Fa].data[ha[0]],R[Fa].data[ha[1]],R[Fa].data[ha[2]]]))}}la.parts.push($)}}var ia=Xa.polylist;ia||(ia=Xa.polygons);ia&&!ia.length&&(ia=[ia]);if(ia){U=0;for(Oa=ia.length;U<Oa;U++){$={material:0,faces:[],normals:[],texcoords:[],colors:[]};var jc=parseInt(ia[U]["@count"],10);(P=ia[U].input)&&
!P.length&&(P=[P]);S=[];if(P.length){ja=0;for(Pa=P.length;ja<Pa;ja++){V=P[ja];var Ob=V["@offset"];null===Ob&&(Ob=V["@idx"]);Y=parseInt(Ob,10);o=V["@source"].substr(1);"VERTEX"===V["@semantic"]?(o===Nb&&(o=kb),S[Y]=0):"NORMAL"===V["@semantic"]?(Ea=o,S[Y]=1):"TEXCOORD"===V["@semantic"]?(Ga=o,S[Y]=2):"COLOR"===V["@semantic"]?(Fa=o,S[Y]=3):S[Y]=4}}var kc=ia[U].vcount,Za=[];kc&&(Za=a.intDelimArray(kc.$," "));l=Wa+":"+ia[U]["@material"];$.material=l===r?0:tb[l];var lb=ia[U].p;H=S.length;var wa=[];if(1<
lb.length&&!Za.length){X=0;for(fa=lb.length;X<fa;X++){var lc=a.intDelimArray(lb[X].$," ");Za[X]=parseInt(lc.length/H,10);wa=wa.concat(lc)}}else lb&&(wa=a.intDelimArray(lb.$," "));if(wa.length)if(v=Za.length,v!==jc)q("poly vcount data doesn't add up, skipping object load: "+v+" !== "+jc);else{0===la.points.length&&(la.points=R[kb].data);t=Y=0;for(z=Za.length;t<z;t++){s=[];G=[];A=[];ha=[];Q=0;for(Ca=Za[t]*H;Q<Ca;Q++)0===S[Q%H]?G.push(wa[Y]):1===S[Q%H]?s.push(wa[Y]):2===S[Q%H]?A.push(wa[Y]):3===S[Q%
H]&&ha.push(wa[Y]),Y++;var $a;if(G.length){$.faces.push(G);if(s.length){Z=[];y=0;for(I=s.length;y<I;y++)Z.push(d.fixuaxis(N.up_axis,R[Ea].data[s[y]]));$.normals.push(Z)}if(A.length){$a=[];y=0;for(I=A.length;y<I;y++)$a.push(R[Ga].data[A[y]]);$.texcoords.push($a)}if(ha.length){$a=[];y=0;for(I=ha.length;y<I;y++)$a.push(R[Fa].data[ha[y]]);$.colors.push($a)}}}}la.parts.push($)}}if(1!==fb){t=0;for(z=la.points.length;t<z;t++)la.points[t]=d.fixuaxis(N.up_axis,la.points[t])}la.id=Wa;N.meshes.push(la)}}}var mc=
O.library_cameras;if(mc){(Qa=mc.camera)&&!Qa.length&&(Qa=[Qa]);J=0;for(K=Qa.length;J<K;J++){ga=Qa[J];var Qc=ga["@id"],wb=0,xb=0,yb=0;ga.optics&&(ga.optics.technique_common&&ga.optics.technique_common.perspective)&&(wb=ga.optics.technique_common.perspective.yfov,xb=ga.optics.technique_common.perspective.znear,yb=ga.optics.technique_common.perspective.zfar);var Pb,Qb,Rb;if(!wb&&!xb&&!yb){(ba=ga.param)&&!ba.length&&(ba=[ba]);t=0;for(z=ba.length;t<z;t++){var Sb=ba[t].$,Tb=ba[t]["@name"];"YFOV"==Tb?Pb=
parseFloat(Sb):"ZNEAR"==Tb?Qb=parseFloat(Sb):"ZFAR"==Tb&&(Rb=parseFloat(Sb))}}else Pb=wb?parseFloat(wb.$):60,Qb=xb?parseFloat(xb.$):0.1,Rb=yb?parseFloat(yb.$):1E3;N.cameras.push({id:Qc,targeted:!1,fov:parseFloat(Pb),nearclip:parseFloat(Qb),farclip:parseFloat(Rb)})}}var nc=O.library_lights,Ha;if(nc){var Ia=nc.light;Ia&&!Ia.length&&(Ia=[Ia]);var oc={point:"point",directional:"directional",spot:"spot"};if(Ia)for(var Ub=0,Rc=Ia.length;Ub<Rc;Ub++){Ha=Ia[Ub];var pc,mb,zb;for(zb in oc)if(Ha.technique_common[zb]){pc=
zb;mb=Ha.technique_common[zb];break}if(mb){var Sc=oc[pc]||"point",qc=Ha["@id"],rc=mb.intensity,Tc=rc?parseFloat(rc.$):1,sc=mb.distance,Uc=sc?parseFloat(sc.$):10,tc=mb.color,ha=[1,1,1];tc&&(ha=a.floatDelimArray(tc.$," "));N.lights.push({id:qc,name:qc,type:Sc,method:m.light.method.STATIC,diffuse:ha,specular:[0,0,0],distance:Uc,intensity:Tc})}}}var uc=O.library_visual_scenes;if(uc){var ab=null;(ab=uc.visual_scene)&&!ab.length&&(ab=[ab]);for(var Vb=0,Vc=ab.length;Vb<Vc;Vb++){Ra=ab[Vb];var xa={id:Ra["@id"],
sceneObjects:[],cameras:[],lights:[],parentMap:[]},na=[],bb=[],ya,Wb,ka,aa,Z,vc=O.library_nodes;if(vc){var cb=vc.node;cb&&!cb.length&&(cb=[cb]);na=[];t=0;for(z=cb.length;t<z;t++)Wb=cb[t],mnodeId=Wb["@id"],na[ka]=Wb;for(ya=[Ra];ya.length;){aa=ya.pop();if(aa.node&&((Z=aa.node)&&!Z.length&&(Z=[Z]),Z)){t=0;for(z=Z.length;t<z;t++)ya.push(Z[t])}if(aa.instance_node){var db=aa.instance_node;db&&!db.length&&(db=[db]);t=0;for(z=db.length;t<z;t++){var Xb=db[t]["@url"].substr(1);na[Xb]&&(aa.node&&aa.node.length&&
(aa.node=[aa.node]),aa.node?aa.node.push(na[Xb]):aa.node=[na[Xb]])}}}}for(ya=[Ra];ya.length;)if(aa=ya.pop(),aa.node&&((Z=aa.node)&&!Z.length&&(Z=[Z]),Z)){t=0;for(z=Z.length;t<z;t++)Z[t].parentNode=aa,bb.push(Z[t]),ya.push(Z[t])}if(bb.length)for(var nb=0,Wc=bb.length;nb<Wc;nb++){var za=bb[nb],Aa=za.instance_geometry;Ha=bb[nb].instance_light;ga=bb[nb].instance_camera;ka=za["@id"];var da=za["@name"],ea=d.cl_getInitalTransform(N.up_axis,za);2===fb&&(ea.rotation=d.quaternionFilterZYYZ(ea.rotation,ga?[-90,
0,0]:r));var ob=null,W=null,eb;if(Aa){Aa&&!Aa.length&&(Aa=[Aa]);t=0;for(z=Aa.length;t<z;t++)if(E=Aa[t]["@url"].substr(1),W={},W.name=(da?da:ka)+(t?t:""),W.id=(ka?ka:da)+(t?t:""),W.meshId=Wa,W.meshName=E,ob||(W.position=ea.position,W.rotation=ea.rotation,W.scale=ea.scale,W.matrix=ea.matrix),xa.sceneObjects.push(W),na[W.id]=!0,za.parentNode)(eb=za.parentNode["@id"])&&na[eb]?xa.parentMap.push({parent:eb,child:W.id}):1<Aa.length&&(ob?na[ob.id]&&xa.parentMap.push({parent:ob.id,child:W.id}):(ob=W,W={}))}else if(ga){var Xc=
ga["@url"].substr(1);xa.cameras.push({name:da?da:ka,id:da?da:ka,source:Xc,position:ea.position,rotation:ea.rotation})}else if(Ha){var Yc=Ha["@url"].substr(1);xa.lights.push({name:da?da:ka,id:da?da:ka,source:Yc,position:ea.position,rotation:ea.rotation||[0,0,0]})}else W={position:ea.position,rotation:ea.rotation,scale:ea.scale,matrix:ea.matrix},W.name=da?da:ka,W.id=ka?ka:da,xa.sceneObjects.push(W),na[W.id]=!0,za.parentNode&&(eb=za.parentNode["@id"])&&na[eb]&&xa.parentMap.push({parent:eb,child:W.id})}N.scenes.push(xa)}}var wc=
O.library_animations,oa;if(wc){var Ja=wc.animation;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja)for(var Yb=0,Zc=Ja.length;Yb<Zc;Yb++){var Ab=Ja[Yb];oa=Ab["@id"];N.animations[oa]={};N.animations[oa].sources=[];var Ka=Ab.source;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka.length){L=0;for(M=Ka.length;L<M;L++){var Ba=Ka[L];g=Ba["@id"];var xc=Ba.technique_common,Bb=null,yc=null;Ba.name_array?Bb=a.textDelimArray(Ba.name_array.$," "):Ba.Name_array?Bb=a.textDelimArray(Ba.Name_array.$," "):Ba.float_array&&(yc=a.floatDelimArray(Ba.float_array.$,
" "));var Zb=0,zc="",Cb=1;if(xc){b=xc;var $b=b.accessor,Zb=parseInt($b["@count"],10),zc=$b["@source"].substr(1),Ac=$b["@stride"];Ac&&(Cb=parseInt(Ac,10))}N.animations[oa].sources[g]={data:Bb?Bb:yc,count:Zb,source:zc,stride:Cb};1!==Cb&&(N.animations[oa].sources[g].data=a.repackArray(N.animations[oa].sources[g].data,Cb,Zb))}}(Da=Ab.sampler)&&!Da.length&&(Da=[Da]);if(Da){N.animations[oa].samplers=[];L=0;for(M=Da.length;L<M;L++){var Bc=Da[L],$c=Bc["@id"];(P=Bc.input)&&!P.length&&(P=[P]);if(P){var Cc=
[];w=0;for(z=P.length;w<z;w++)V=P[w],Cc[V["@semantic"]]=V["@source"].substr(1);N.animations[oa].samplers[$c]=Cc}}}var La=Ab.channel;La&&!La.length&&(La=[La]);if(La){N.animations[oa].channels=[];J=0;for(K=La.length;J<K;J++){var Dc=La[J],ad=Dc["@source"].substr(1),Ec=Dc["@target"],Fc=Ec.split("/"),bd=Fc[0],Gc=Fc[1].split(".");N.animations[oa].channels.push({source:ad,target:Ec,targetName:bd,paramName:Gc[0],typeName:Gc[1]})}}}}var Hc=O.scene;if(Hc&&(Ra=Hc.instance_visual_scene)){var cd=Ra["@url"].substr(1);
N.scene=cd}return N}var r=h.undef,m=h.enums,o=h.GLCore,q=h.log,d={fixuaxis:function(d,e){if(0===d)return[e[1],e[0],e[2]];if(1===d)return e;if(2===d)return[e[0],e[2],-e[1]]},fixscaleaxis:function(d,e){if(0===d)return[e[1],e[0],e[2]];if(1===d)return e;if(2===d)return[e[0],e[2],e[1]]},fixukaxis:function(d,e,c,n){return e===m.motion.POS&&c===m.motion.Z&&d===m.motion.Z?-n:n},getAllOf:function(d,e){for(var c=[d],n=[],a,b,g,l;c.length;)for(b in a=c.pop(),a)if(a.hasOwnProperty(b)){if(b===e)if(a[b].length){g=
0;for(l=a[b].length;g<l;g++)n.push(a[b][g])}else n.push(a[b]);if("object"==typeof a[b])if(a[b].length){g=0;for(l=a[b].length;g<l;g++)c.push(a[b][g])}else c.push(a[b])}return n},quaternionFilterZYYZ:function(d,e){var c=h.vec3,n=d,a=new h.Quaternion;e!==r&&(n=c.add(d,e));a.fromEuler(n[0],n[2],-n[1]);return a.toEuler()},cl_getInitalTransform:function(f,e){var c=h.util,n={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},a=e.translate,b=e.rotate,g=e.scale;if(e.matrix&&!a&&!b&&!g)return n;a&&a.$&&(n.position=
d.fixuaxis(f,c.floatDelimArray(a.$," ")));if(b)for(var a=0,l=b.length;a<l;a++){var m=b[a],o=m["@sid"],m=c.floatDelimArray(m.$," ");if("rotateX"==o||"rotationX"==o)n.rotation[0]=m[3];else if("rotateY"==o||"rotationY"==o)n.rotation[1]=m[3];else if("rotateZ"==o||"rotationZ"==o)n.rotation[2]=m[3]}g&&(n.scale=d.fixscaleaxis(f,c.floatDelimArray(g.$," ")));return n}};return{loadCollada:function(f,e,c){var e=v(f,e,c),n=e.up_axis,a=[],b,g,l,q,E,x,s,G;g=0;for(l=e.materials.length;g<l;g++){E=e.materials[g];
s=new h.Material(E.mat);s.name=E.name||null;x=0;for(q=E.mat.textures_ref.length;x<q;x++){G=E.mat.textures_ref[x];var A=null,A=void 0===h.Textures_ref[G.image]?new h.Texture(G.image,o.default_filter,c,f):h.Textures_obj[h.Textures_ref[G.image]];s.setTexture(A,G.type)}a[E.id]=s}x=[];g=0;for(l=e.meshes.length;g<l;g++){var A=e.meshes[g],H=new h.Mesh({name:A.id});H.points=A.points;var B=!1;s=0;for(G=A.parts.length;s<G;s++){var t=A.parts[s];0!==t.material&&((q=a[t.material])||(q=new h.Material({name:t.material})),
H.setFaceMaterial(q));var w=t.normals.length?!0:!1,z=t.texcoords.length?!0:!1,C=t.colors.length?!0:!1;C&&(a[t.material].color_map=!0);q=0;for(E=t.faces.length;q<E;q++){var D=H.addFace(t.faces[q]);w&&(H.faces[D].point_normals=t.normals[q]);z&&(H.faces[D].uvs=t.texcoords[q]);C&&(H.faces[D].point_colors=t.colors[q])}B|=w}H.faces.length&&(c?c.addMesh(f,f+":"+meshId,H):(B||H.calcNormals(),H.triangulateQuads(),H.compile()),x[A.id]=H)}l=[];f=0;for(q=e.cameras.length;f<q;f++)l[e.cameras[f].id]=e.cameras[f];
A=[];q=0;for(E=e.lights.length;q<E;q++)A[e.lights[q].id]=e.lights[q];c={};a={};g={};f={};s=0;for(G=e.scenes.length;s<G;s++){H=e.scenes[s];B=new h.Scene;q=0;for(E=H.sceneObjects.length;q<E;q++)t=H.sceneObjects[q],w=new h.SceneObject(t),w.obj=(x[t.meshName]?x[t.meshName]:x[t.meshId])||null,t.matrix&&w.setMatrix(t.matrix),c[t.id]=w,B.bindSceneObject(w);q=0;for(E=H.lights.length;q<E;q++)t=H.lights[q],w=new h.Light(A[t.source]),w.position=t.position,w.rotation=t.rotation,a[t.id]=w,B.bindLight(w);H.cameras.length&&
(q=H.cameras[0],E=new h.Camera(l[q.source]),E.position=q.position,E.rotation=q.rotation,g[q.id]=E,B.camera=E);q=0;for(E=H.parentMap.length;q<E;q++)t=H.parentMap[q],c[t.parent].bindChild(c[t.child]);f[H.id]=B}for(var F in e.animations)if(e.animations.hasOwnProperty(F)&&(x=e.animations[F],x.channels.length)){cCount=0;for(q=x.channels.length;cCount<q;cCount++){l=x.channels[cCount];t=x.samplers[l.source];E=x.sources[t.INPUT];s=x.sources[t.OUTPUT];G=x.sources[t.INTERPOLATION];var A=x.sources[t.IN_TANGENT],
H=x.sources[t.OUT_TANGENT],B=t.IN_TANGENT!==r,t=t.OUT_TANGENT!==r,w=null,C=c[l.targetName],z=g[l.targetName],y=a[l.targetName];C?(null===C.motion&&(C.motion=new h.Motion),w=C.motion):z?(null===z.motion&&(z.motion=new h.Motion),w=z.motion):y&&(null===y.motion&&(y.motion=new h.Motion),w=y.motion);if(null!==w){C=m.motion.POS;D=m.motion.X;2===n&&(w.yzflip=!0);b=l.paramName;if("rotateX"===b||"rotationX"===b)C=m.motion.ROT,D=m.motion.X;else if("rotateY"===b||"rotationY"===b)C=m.motion.ROT,D=m.motion.Y;
else if("rotateZ"===b||"rotationZ"===b)C=m.motion.ROT,D=m.motion.Z;else if("location"===b){if(C=m.motion.POS,"X"===l.typeName&&(D=m.motion.X),"Y"===l.typeName&&(D=m.motion.Y),"Z"===l.typeName)D=m.motion.Z}else if("translate"===b){if(C=m.motion.POS,"X"===l.typeName&&(D=m.motion.X),"Y"===l.typeName&&(D=m.motion.Y),"Z"===l.typeName)D=m.motion.Z}else if("LENS"===b)continue;else"FOV"===b?(C=m.motion.FOV,D=3):"ZNEAR"===b?(C=m.motion.NEARCLIP,D=3):"ZFAR"===b?(C=m.motion.FARCLIP,D=3):"intensity"===b&&(C=
m.motion.INTENSITY,D=3);y&&3>C&&(y.method=m.light.method.DYNAMIC);mCount=0;for(l=E.data.length;mCount<l;mCount++)if(k=null,"object"===typeof s.data[mCount]){i=0;for(iMax=s.data[mCount].length;i<iMax;i++)y=i,2===n&&2===i?y=1:2===n&&1===i&&(y=2),k=w.setKey(C,y,E.data[mCount],d.fixukaxis(e.up_axis,C,y,s.data[mCount][i])),G&&(b=G.data[mCount][i],"LINEAR"===b?k.shape=m.envelope.shape.LINE:"BEZIER"===b&&(k.shape=!B&&!t?m.envelope.shape.LINEAR:m.envelope.shape.BEZI))}else if(y=D,ofs=0,z&&C===m.motion.ROT&&
2===n&&0===y&&(ofs=-90),C===m.motion.ROT?k=w.setKey(C,y,E.data[mCount],s.data[mCount]+ofs):(2===n&&2===D?y=1:2===n&&1===D&&(y=2),k=w.setKey(C,y,E.data[mCount],d.fixukaxis(e.up_axis,C,y,s.data[mCount]))),G)if(b=G.data[mCount],"LINEAR"===b)k.shape=m.envelope.shape.LINE;else if("BEZIER"===b)if(!B&&!t)k.shape=m.envelope.shape.LINEAR,k.continutity=1;else{k.shape=m.envelope.shape.BEZ2;b=A.data[mCount][0];var I,J=H.data[mCount][0];C===m.motion.ROT?(I=A.data[mCount][1],y=H.data[mCount][1],k.param[0]=b-k.time,
k.param[1]=I-k.value+ofs,k.param[2]=J-k.time,k.param[3]=y-k.value+ofs):(I=d.fixukaxis(e.up_axis,C,y,A.data[mCount][1]),y=d.fixukaxis(e.up_axis,C,y,H.data[mCount][1]),k.param[0]=b-k.time,k.param[1]=I-k.value,k.param[2]=J-k.time,k.param[3]=y-k.value)}}}}F=null;return F=e.scene?f[e.scene]:f.pop()},parseCollada:v}});
CubicVR.RegisterModule("GML",function(h){function v(m){var o=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(m!==r){var m=o.getXML(m),h=m.getElementsByTagName("header");if(!h.length)return null;var d=h[0],h=m.getElementsByTagName("environment");if(!h.length)return null;this.name=null;d=d.getElementsByTagName("name");d.length&&(this.name=o.collectTextNode(d[0]));d=h[0].getElementsByTagName("screenBounds");d.length&&
(this.bounds=[parseFloat(o.collectTextNode(d[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("z")[0]))]);d=h[0].getElementsByTagName("origin");d.length&&(this.origin=[parseFloat(o.collectTextNode(d[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(d[0].getElementsByTagName("z")[0]))]);h=h[0].getElementsByTagName("up");
h.length&&(this.upvector=[parseFloat(o.collectTextNode(h[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(h[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(h[0].getElementsByTagName("z")[0]))]);m=m.getElementsByTagName("drawing");h=0;for(d=m.length;h<d;h++)for(var f=m[h].getElementsByTagName("stroke"),e=0,c=0,n=0,a=0,b=0,g=f.length;b<g;b++){for(var l=f[b].getElementsByTagName("pt"),u=l.length,E=Array(u),x,s,G,A=0,v=u;A<v;A++)G=l[A],u=parseFloat(o.collectTextNode(G.getElementsByTagName("x")[0])),
x=parseFloat(o.collectTextNode(G.getElementsByTagName("y")[0])),s=parseFloat(o.collectTextNode(G.getElementsByTagName("z")[0])),G=parseFloat(o.collectTextNode(G.getElementsByTagName("time")[0])),1===this.upvector[0]?E[A]=[x!==x?0:x,u!==u?0:-u,s!==s?0:s,G]:1===this.upvector[1]?E[A]=[u!==u?0:u,x!==x?0:x,s!==s?0:s,G]:1===this.upvector[2]&&(E[A]=[u!==u?0:u,s!==s?0:-s,x!==x?0:x,G]),e<u&&(e=u),c<x&&(c=x),n<s&&(n=s),a<G&&(a=G);if(n>a){l=0;for(A=E.length;l<A;l++)u=E[l][3],E[l][3]=E[l][2],E[l][2]=u/this.bounds[2]}this.strokes[b]=
E}}}var r=h.undef;v.prototype={addStroke:function(m,o){var h=[];o===r&&(o=0.1);for(var d=0,f=m.length;d<f;d++){var e=[m[d][0],m[d][1],m[d][2]];this.manual_pos+=o;e.push(this.manual_pos);h.push(e)}this.strokes.push(h)},recenter:function(){var m=CubicVR.vec3,o=[0,0,0],h=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],d,f,e,c;e=0;for(c=this.strokes.length;e<c;e++){d=0;for(f=this.strokes[e].length;d<f;d++)o[0]>this.strokes[e][d][0]&&(o[0]=this.strokes[e][d][0]),o[1]>this.strokes[e][d][1]&&
(o[1]=this.strokes[e][d][1]),o[2]>this.strokes[e][d][2]&&(o[2]=this.strokes[e][d][2]),h[0]<this.strokes[e][d][0]&&(h[0]=this.strokes[e][d][0]),h[1]<this.strokes[e][d][1]&&(h[1]=this.strokes[e][d][1]),h[2]<this.strokes[e][d][2]&&(h[2]=this.strokes[e][d][2])}m=m.multiply(m.subtract(h,o),0.5);e=0;for(c=this.strokes.length;e<c;e++){d=0;for(f=this.strokes[e].length;d<f;d++)this.strokes[e][d][0]-=m[0],this.strokes[e][d][1]-=this.upvector[1]?m[1]:-m[1],this.strokes[e][d][2]-=m[2]}},generateObject:function(m,
o,h,d,f){var e=CubicVR.vec3;m===r&&(m=0);o===r&&(o=0);f===r&&(f=!1);d===r&&(d=0.02);h===r&&(h=0.015);for(var c=0!==o,n=0,a=0,b=new CubicVR.Mesh(this.name),g,l,u,E,x,s,G=0,A=this.strokes.length;G<A;G++){s=new CubicVR.Envelope;var v=new CubicVR.Envelope,B=new CubicVR.Envelope,t=this.strokes[G].length,w=[],z=[],C=0,D=this.strokes[G];for(x=0;x<t;x++){var F=D[x],y=s.addKey(F[3],F[0]),I=v.addKey(F[3],F[1]),J;J=f?B.addKey(F[3],F[2]):B.addKey(F[3],0);y.tension=0.5;I.tension=0.5;J.tension=0.5;0!==x?(g=F[0]-
g,l=F[1]-l,u=F[2]-u,E=F[3]-E,u=Math.sqrt(g*g+l*l+u*u),w[x-1]=u,z[x-1]=E):C=F[3];g=F[0];l=F[1];u=F[2];E=F[3]}t=b.points.length;for(x=0;x<w.length;x++){D=z[x];I=Math.ceil(3*(w[x]/d));F=C;y=C+D;for(I=D/I;F<y-I;F+=I){F===C&&(g=s.evaluate(F),l=v.evaluate(F),u=B.evaluate(F));var K,L;J=s.evaluate(F+I);K=v.evaluate(F+I);L=B.evaluate(F+I);var M=J-g,X=K-l,fa=L-u;Math.sqrt(M*M+X*X+fa*fa);M=e.multiply(e.normalize(e.cross(this.viewvector,e.normalize([M,X,fa]))),h/2);b.addPoint([g-M[0],-(l-M[1]),u-M[2]+(c?o/2:
0)]);b.addPoint([g+M[0],-(l+M[1]),u+M[2]+(c?o/2:0)]);g=J;l=K;u=L}C+=D}v=b.points.length;if(c){x=t;for(s=v;x<s;x++)b.addPoint([b.points[x][0],b.points[x][1],b.points[x][2]-(c?o/2:0)])}x=0;for(s=v-t;x<=s-4;x+=2){0===n%m&&a++;b.setSegment(a);B=[t+x,t+x+1,t+x+3,t+x+2];b.addFace(B);if(c&&(B=[B[3]+v-t,B[2]+v-t,B[1]+v-t,B[0]+v-t],b.addFace(B),B=[t+x,t+x+2,t+x+2+v-t,t+x+v-t],b.addFace(B),B=[t+x+1+v-t,t+x+3+v-t,t+x+3,t+x+1],b.addFace(B),0===x&&(B=[t+x+v-t,t+x+1+v-t,t+x+1,t+x],b.addFace(B)),x===s-4))B=[t+x+
2,t+x+3,t+x+3+v-t,t+x+2+v-t],b.addFace(B);n++}}b.calcFaceNormals();b.triangulateQuads();b.calcNormals();b.compile();return b}};return{GML:v}});
CubicVR.RegisterModule("PDF",function(){function h(h,r){var m=h;"string"===typeof h&&(m={url:h});var o=new XMLHttpRequest;o.open("GET",m.url);var q=m.headers;if(q)for(var d in q)"undefined"!==typeof q[d]&&o.setRequestHeader(d,m.headers[d]);o.mozResponseType=o.responseType="arraybuffer";q=m.url.substring(0,m.url.indexOf(":")+1);o.expected=-1<["http:","https:",""].indexOf(q)?200:0;"progress"in m&&(o.onprogress=m.progress||void 0);var f=!1;"error"in m&&(o.onerror=function(){if(!f){f=true;m.error()}});
o.onreadystatechange=function(d){if(o.readyState===4)if(o.status===o.expected)r(o.mozResponseArrayBuffer||o.mozResponse||o.responseArrayBuffer||o.response);else if(m.error&&!f){f=true;m.error(d)}};o.send(null)}return{PDF:function(v){if(!v.src)throw"PDF Error: you must specify a src url for a PDF.";var r=v.src,m=v.callback||function(){},o,q=[],d=[];this.__defineGetter__("pages",function(){return o?o.numPages:0});this.getPage=function(d){var e=o.numPages,d=1>d?1:d;return q[(d>e?e:d)-1]};this.getPageTexture=
function(d,e,c){var d=this.getPage(d),n=d.getViewport(1),e=e||n.width,c=c||n.height;return new CubicVR.PdfTexture(d,{width:e,height:c,viewport:n})};h({url:r,progress:function(){},error:function(){console.log("PDF Error: error loading pdf `"+r+"`")}},function(f){PDFJS.getDocument({data:f}).then(function(e){function c(){f++>=e.numPages?m():e.getPage(f).then(function(a){q.push(a);d.push(a);c()})}o=e;var f=0;c()},function(d,c){console.warn(d,c);m()})})}}});
CubicVR.RegisterModule("Particles",function(h){function v(m,h,d,f,e,c,n){m&&(this.last_particle=this.particles=null,this.pTex=d!==r?d:null,this.vWidth=f,this.vHeight=e,this.alpha=c!==r?c:!1,this.alphaCut=n!==r?n:0,this.pfunc=function(a,b){var c=b-a.start_time;if(0>c)return 0;if(c>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+c*a.velocity[0]+c*c*a.accel[0];a.pos[1]=a.startpos[1]+c*a.velocity[1]+c*c*a.accel[1];a.pos[2]=a.startpos[2]+c*a.velocity[2]+c*c*a.accel[2];null!==this.pgov&&this.pgov(a,
b);return 1},this.pgov=null,this.hasColor=h===r?!1:h,d=null!==this.pTex,this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",d?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",d?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",d?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n"),this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",d?"uniform sampler2D pMap;":"","varying vec4 color;",d?"varying vec2 screenPos;":"",d?"uniform vec3 screenDim;":"",d?"varying float pSize;":"","void main(void) {\nvec4 c = color;",d?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",d?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",d?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n"),this.maxPoints=m,this.numParticles=0,this.arPoints=new Float32Array(3*m),this.glPoints=null,h&&(this.arColor=new Float32Array(3*m),this.glColor=null),this.shader_particle=new CubicVR.Shader(this.vs,this.fs),this.shader_particle.use(),this.shader_particle.addVertexArray("aVertexPosition",
0),this.hasColor&&this.shader_particle.addVertexArray("aColor"),this.shader_particle.addMatrix("uMVMatrix"),this.shader_particle.addMatrix("uPMatrix"),null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[f,e,0])),this.genBuffer())}var r=h.undef,m=h.GLCore;v.prototype={resizeView:function(m,h){this.vWidth=m;this.vHeight=h;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[m,h,0]))},addParticle:function(m){null===this.last_particle?this.particles=m:this.last_particle.nextParticle=m;this.last_particle=m},genBuffer:function(){var o=m.gl;this.glPoints=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW);this.hasColor&&(this.glColor=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW))},updatePoints:function(){var o=m.gl;o.bindBuffer(o.ARRAY_BUFFER,
this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW)},updateColors:function(){var o=m.gl;this.hasColor&&(o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW))},draw:function(o,h,d){var f=m.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(f.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",o);this.shader_particle.setMatrix("uPMatrix",h);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);f.bindBuffer(f.ARRAY_BUFFER,this.glPoints);
f.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,f.FLOAT,!1,0,0);f.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(f.bindBuffer(f.ARRAY_BUFFER,this.glColor),f.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(d!==r){this.numParticles=0;if(null===this.particles){f.disable(f.BLEND);return}for(var o=this.particles,h=null,e=0;null!==o;){var c=3*this.numParticles,
n=this.pfunc(o,d);if(1===n){if(this.arPoints[c]=o.pos[0],this.arPoints[c+1]=o.pos[1],this.arPoints[c+2]=o.pos[2],null!==o.color&&this.arColor!==r&&(this.arColor[c]=o.color[0],this.arColor[c+1]=o.color[1],this.arColor[c+2]=o.color[2]),this.numParticles++,e++,this.numParticles===this.maxPoints)break}else-1===n?null!==h&&(h.nextParticle=o.nextParticle):0===n&&e++;h=o;o=o.nextParticle}e||(this.last_particle=this.particles=null);this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&(f.enable(f.BLEND),
f.enable(f.DEPTH_TEST),f.depthMask(0),f.blendFunc(f.ONE,f.ONE_MINUS_SRC_COLOR));f.drawArrays(f.POINTS,0,this.numParticles);this.alpha&&(f.disable(f.BLEND),f.depthMask(1),f.blendFunc(f.ONE,f.ONE));this.hasColor&&f.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:v,Particle:function(m,h,d,f,e){this.startpos=new Float32Array(m);this.pos=new Float32Array(m);this.velocity=new Float32Array(f!==r?f:[0,0,0]);this.accel=new Float32Array(e!==r?e:[0,0,0]);this.start_time=
h!==r?h:0;this.life_time=d!==r?d:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("Lines",function(h){function v(m){m=m||{};this.color=m.color||[1,1,1];this.maxPoints=m.maxPoints||1024;this.vs="#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvoid main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);\ngl_Position = position;\n}";this.fs="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 color;\nvoid main(void) {\nvec4 c = vec4(color,1.0);\ngl_FragColor = c;\n}";this.arLines=
new Float32Array(6*this.maxPoints);this.glLines=null;this.lineLength=0;this.shader_line=new CubicVR.Shader(this.vs,this.fs);this.shader_line.use();this.shader_line.addVertexArray("aVertexPosition",0);this.shader_line.addVector("color",this.color);this.shader_line.addMatrix("uMVMatrix");this.shader_line.addMatrix("uPMatrix");this.genBuffer();this.newSegment=!1}var r=h.GLCore;v.prototype={genBuffer:function(){var m=r.gl;this.glLines=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,this.glLines);m.bufferData(m.ARRAY_BUFFER,
this.arLines,m.DYNAMIC_DRAW)},update:function(){var m=r.gl;m.bindBuffer(m.ARRAY_BUFFER,this.glLines);m.bufferData(m.ARRAY_BUFFER,this.arLines,m.DYNAMIC_DRAW)},addPoint:function(m){var h=this.lineLength;1<h&&(this.arLines[3*h]=this.arLines[3*(h-1)],this.arLines[3*h+1]=this.arLines[3*(h-1)+1],this.arLines[3*h+2]=this.arLines[3*(h-1)+2],this.lineLength++,h++);this.arLines[3*h]=m[0];this.arLines[3*h+1]=m[1];this.arLines[3*h+2]=m[2];this.lineLength++},addSegment:function(m){var h=this.lineLength;this.arLines[3*
h]=m[0];this.arLines[3*h+1]=m[1];this.arLines[3*h+2]=m[2];this.lineLength++},clear:function(){this.lineLength=0},render:function(m){var h=r.gl,q=m.mvMatrix,m=m.pMatrix;this.shader_line.use();this.shader_line.setMatrix("uMVMatrix",q);this.shader_line.setMatrix("uPMatrix",m);this.shader_line.setVector("color",this.color);h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.glLines);h.vertexAttribPointer(this.shader_line.uniforms.aVertexPosition,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(this.shader_line.uniforms.aVertexPosition);
h.drawArrays(h.LINES,0,this.lineLength)}};return{Lines:v}});
CubicVR.RegisterModule("HeightField",function(h){var v=h.undef,r=h.enums;r.heightfield={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2}};var m=function(d){d=d||{};this.operation=h.parseEnum(r.draw.op,d.operation||d.op)||r.draw.op.REPLACE;this.brushType=h.parseEnum(r.draw.brush,d.brushType)||r.draw.brush.SINE;this.brushSize=d.size||5;this.strength=d.strength||1};m.prototype={setOperation:function(d){this.operation=h.parseEnum(r.draw.op,d)},getOperation:function(){return this.operation},setBrushType:function(d){this.brushType=
h.parseEnum(r.draw.brush,d)||r.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(d){this.brushSize=d},getSize:function(){return this.brushSize},setStrength:function(d){this.strength=d},getStrength:function(){return this.strength}};var o=function(d){d=d||{};this.divX=d.divX||null;this.divZ=d.divZ||null;this.size=d.size||null;this.cellSize=this.sizeZ=this.sizeX=this.cellSize=this.hfFloatBuffer=this.hfUInt8Buffer=this.hfBuffer=null;this.ofsX=d.ofsX||-this.cellSize/2;this.ofsZ=
d.ofsZ||-this.cellSize/2;this.divX&&(this.divZ&&this.size)&&this.initBuffer(this.divX,this.divZ,this.size);this.areaBuffered=!1;this.drawArea={startX:0,startZ:0,endX:0,endZ:0}};o.prototype={initBuffer:function(d,f,e){this.hfBuffer=new ArrayBuffer(4*d*f);this.hfUInt8Buffer=new Uint8Array(this.hfBuffer);this.hfFloatBuffer=new Float32Array(this.hfBuffer);this.divX=d||null;this.divZ=f||null;this.size=e||null;this.divX>this.divZ?(this.sizeX=e,this.sizeZ=e/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?
e/this.divZ*this.divX:e,this.sizeZ=e);this.drawBuffer=[];this.cellSize=this.sizeX/this.divX;this.startX=-(this.sizeX/2)+this.ofsX;this.startZ=-(this.sizeZ/2)+this.ofsZ},setBrush:function(d){this.brush=d},getBrush:function(){return this.brush},draw:function(d,f,e){var c=this.brush||e,e=c.getOperation(),n=c.getSize(),a=c.getBrushType(),c=c.getStrength();if(this.areaBuffered){var b=d-n,g=f-n,l=d+n,m=f+n;b<this.drawArea.startX&&(this.drawArea.startX=b);g<this.drawArea.startZ&&(this.drawArea.startZ=g);
l>this.drawArea.endX&&(this.drawArea.endX=l);l>this.drawArea.endX&&(this.drawArea.endZ=m)}else this.drawArea={startX:d-n,startZ:f-n,endX:d+n,endZ:f+n},this.areaBuffered=!0;this.drawBuffer.push([d,f,e,n,a,c])},getDrawArea:function(){return!this.areaBuffered?!1:this.drawArea},clearDrawArea:function(){this.areaBuffered=!1},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var d=this.drawBuffer.pop();this.drawFunc(d[0],d[1],d[2],d[3],d[4],d[5])}return!0},needsFlush:function(){return 0!==
this.drawBuffer.length},drawFunc:function(d,f,e,c,n,a){for(var e=this.hfFloatBuffer,n=this.divX,b=this.divZ,c=c/this.cellSize,d=(d-this.startX)/this.cellSize,f=(f-this.startZ)/this.cellSize,g=parseInt(Math.floor(d-c),10),l=parseInt(Math.ceil(d+c),10);g<l;g++)for(var m=g-d,h=parseInt(Math.floor(f-c),10),o=parseInt(Math.ceil(f+c),10);h<o;h++)if(!(0>g||g>=n||0>h||h>=b)){var s=h-f,s=a*((1-Math.sqrt(m*m+s*s)/c)/2);0>s&&0<=a&&(s=0);0<s&&0>=a&&(s=0);e[h*n+g]+=s}},getUint8Buffer:function(){return this.hfUInt8Buffer},
getFloat32Buffer:function(){return this.hfFloatBuffer},getDivX:function(){return this.divX},getDivZ:function(){return this.divZ},getSizeX:function(){return this.sizeX},getSizeZ:function(){return this.sizeZ},getStartX:function(){return this.startX},getStartZ:function(){return this.startZ},getCellSize:function(){return this.cellSize},getSize:function(){return this.size},setRect:function(d){var d=d||{},f=d.value||0,e=d.src||d.func||null,c=d.startX||0,n=d.startZ||0,a=d.walkX,b=d.walkZ,d=this.hfFloatBuffer,
g,l=this.startX,m=this.startZ;if(c!==v&&n!==v&&a!==v&&b!==v){if(!(c>=this.divX)&&!(n>=this.divZ)&&(c+a>=this.divX&&(a=this.divX-1-c),n+b>=this.divZ&&(b=this.divZ-1-n),!(0>=a||0>=b))){g=c;for(c+=a;g<c;g++)for(var a=n,h=n+b;a<h;a++){var o=g+a*this.divX;d[o]=null===e?f:e(this.cellSize*g+l,this.cellSize*a+m,o)}}}else{g=0;for(c=this.hfFloatBuffer.length;g<c;g++)null===e?d[g]=f:(n=e(g%this.divX*this.cellSize+l,Math.floor(g/this.divX)*this.cellSize+m,g),d[g]=n)}},getIndicesAt:function(d,f){if("object"===
typeof d)return this.getIndicesAt(d[0],d[2]);var e=this.startX,c=this.startZ,n=Math.floor((d-e)/this.cellSize),a=Math.floor((f-c)/this.cellSize);if(0>n||n>=this.divX-1||0>a||a>=this.divZ-1)return-1;if(1<=Math.abs(f-((a+1)*this.cellSize+c))/Math.abs(d-(n*this.cellSize+e)))return e=[n+(a+1)*this.divX,n+1+a*this.divX,n+a*this.divX],[n,a,e,0];e=[n+(a+1)*this.divX,n+1+(a+1)*this.divX,n+1+a*this.divX];return[n,a,e,1]},getHeightValue:function(d,f){var e=h.triangle;if("object"===typeof d)return this.getHeightValue(d[0],
d[2]);var c=this.getIndicesAt(d,f);if(-1===c)return 0;var n=c[2],a=c[0]*this.cellSize+this.startX,b=c[1]*this.cellSize+this.startZ,g;g=0===c[3]?e.normal([a,this.hfFloatBuffer[n[0]],b+this.cellSize],[a+this.cellSize,this.hfFloatBuffer[n[1]],b],[a,this.hfFloatBuffer[n[2]],b]):e.normal([a,this.hfFloatBuffer[n[0]],b+this.cellSize],[a+this.cellSize,this.hfFloatBuffer[n[1]],b+this.cellSize],[a+this.cellSize,this.hfFloatBuffer[n[2]],b]);e=g[0];c=g[1];g=g[2];n=[a,this.hfFloatBuffer[n[0]],b+this.cellSize];
return(e*d+g*f+(-(e*n[0])-c*n[1]-g*n[2]))/-c},rayIntersect:function(d,f){var e=d.slice(0),c=this.startX,n=this.startZ,a=this.startX+this.sizeX,b=this.startZ+this.sizeZ,g=this.cellSize,l=h.vec2,m=h.vec3,o=m.normalize(f),q=[o[0],o[2]],s=[e[0],e[2]];if(e[0]<c||e[0]>a||e[2]<n||e[2]>b){var r=[[c,n],[a,n],[c,b],[a,b]],A=[];e[0]>=a&&A.push([r[1],r[3]]);e[0]<=c&&A.push([r[0],r[2]]);e[2]>=b&&A.push([r[2],r[3]]);e[2]<=n&&A.push([r[0],r[1]]);if(0!==A.length){e=[];a=0;for(b=A.length;a<b;a++)r=l.lineIntersect(s,
l.add(s,q),A[a][0],A[a][1]),!1!==r&&l.onLine(A[a][0],A[a][1],r)&&e.push(r);r=0;A=-1;a=0;for(b=e.length;a<b;a++){var v=l.length(e[a],s);0===a?(r=v,A=0):v<r&&(A=a,r=v)}if(-1!=A){if(t=r/l.length(q),e=[e[A][0],0,e[A][1]],e[1]=d[1]+o[1]*t,e[1]<=this.getHeightValue(e[0],e[2]))return!1}else return!1}s=[e[0],e[2]]}r=Math.floor((s[0]-c)/g);b=Math.floor((s[1]-n)/g);A=s[0]-(c+r*g);a=s[1]-(n+b*g);a=A<a?A/Math.abs(q[0]):a/Math.abs(q[1]);0===a?(A=s[0],a=s[1]):(A=s[0]+a*q[0],a=s[1]+a*q[1]);for(var r=A-(c+r*g),v=
a-(n+b*g),b=0<=q[0]?r:g-r,r=0<=q[1]?v:g-v,v=this.getFloat32Buffer(),B,t;;){var w=(g-b)/Math.abs(q[0]),z=(g-r)/Math.abs(q[1]),w=w<z?w:z;B=q[0]*w;var C=q[1]*w,b=b+Math.abs(B),r=r+Math.abs(C),w=(A+(A+B))/2,z=(a+(a+C))/2,A=A+B,a=a+C,w=Math.floor((w-c)/g),z=Math.floor((z-n)/g);if(b>=g)for(;b>=g;)b-=g;if(r>=g)for(;r>=g;)r-=g;t=l.length(s,[A,a])/l.length(q);B=l.length(s,[A-B,a-C])/l.length(q);t=e[1]+o[1]*t;B=e[1]+o[1]*B;if(w>this.divX||0>w||z>this.divZ||0>z)return!1;var C=v[z*this.divX+w],D=v[z*this.divX+
w+1],F=v[(z+1)*this.divX+w],y=v[(z+1)*this.divX+w+1];if(0>=t-C||0>=t-D||0>=t-F||0>=t-y||0>=B-C||0>=B-D||0>=B-F||0>=B-y){D=[w+(z+1)*this.divX,w+1+z*this.divX,w+z*this.divX];C=[w+(z+1)*this.divX,w+1+(z+1)*this.divX,w+1+z*this.divX];t=c+g*w;B=n+g*z;tmpNormA=h.triangle.normal([t,v[D[0]],B+g],[t+g,v[D[1]],B],[t,v[D[2]],B]);tmpNormB=h.triangle.normal([t,v[C[0]],B+g],[t+g,v[C[1]],B+g],[t+g,v[C[2]],B]);D=m.linePlaneIntersect(tmpNormA,[t,v[D[0]],B+g],e,m.add(e,o));w=Math.abs(n+(z+1)*g-D[0])/Math.abs(c+w*g-
D[2]);if(1<=w&&D[0]>=t-1.0E-8&&D[0]<=t+g+1.0E-8&&D[2]>=B-1.0E-8&&D[2]<=B+1.0E-8+g)return D;z=m.linePlaneIntersect(tmpNormB,[t,v[C[0]],B+g],e,m.add(e,o));if(1>w&&z[0]>=t-1.0E-8&&z[0]<=t+g+1.0E-8&&z[2]>=B-1.0E-8&&z[2]<=B+g+1.0E-8)return z}}}};var q=h.extendClassGeneral(h.Mesh,function(d){d=d||{};d.dynamic=!0;d.buildWireframe=!0;this.material=d.material;this._update=h.Mesh.prototype.update;h.Mesh.apply(this,[d]);this.hField=d.hField||null;this.divX=d.divX||null;this.divZ=d.divZ||null;this.viewX=d.viewX||
0;this.viewZ=d.viewZ||0;this.ofsX=d.ofsX||0;this.ofsZ=d.ofsZ||0;this.edgeX=d.edgeX||0;this.edgeZ=d.edgeZ||0;this.normalBuffer=[];this.genHeightfieldMesh()},{setIndexedHeight:function(d,f,e){this.points[d+f*this.divX][1]=e},genHeightfieldMesh:function(){var d,f,e=this.divX+this.edgeX,c=this.divZ+this.edgeZ,n=this.hField.getCellSize(),a=n*this.divX;d=n*this.divZ;0!==this.points.length&&this.clean();var b=-(d/2);for(f=0;f<c;f++){var g=-(a/2);for(d=0;d<e;d++)this.addPoint([g+this.ofsX,0,b+this.ofsZ]),
g+=n;b+=n}this.setFaceMaterial(this.material);d=-1/(e-1);f=1/(c-1);for(a=b=0;a<c-1;a++){g=1;for(n=0;n<e-1;n++)f1=this.addFace([n+(a+1)*e,n+1+a*e,n+a*e]),f2=this.addFace([n+(a+1)*e,n+1+(a+1)*e,n+1+a*e]),this.faces[f1].uvs=[[g,b+f],[g+d,b],[g,b]],this.faces[f2].uvs=[[g,b+f],[g+d,b+f],[g+d,b]],g+=d;b+=f}},recalcNormals:function(d){var f;if(d=d||this.normalMapRef){var d=this.divX+this.edgeX,e=this.divZ+this.edgeZ;if(!this.normalBuffer.length){for(f=0;f<this.points.length;f++)this.normalBuffer.push([0,
1,0]);var c=0;for(f=0;f<e-1;f++)for(k=0;k<d-1;k++)this.faces[c++].point_normals=[this.normalBuffer[k+(f+1)*d],this.normalBuffer[k+1+f*d],this.normalBuffer[k+f*d]],this.faces[c++].point_normals=[this.normalBuffer[k+(f+1)*d],this.normalBuffer[k+1+(f+1)*d],this.normalBuffer[k+1+f*d]]}e=this.hField;c=e.getFloat32Buffer();f=this.viewX||0;var n=(this.viewZ||0)*e.getDivX()+f;for(f=0;f<this.points.length;f++){var a=f%d,b=Math.floor(f/d),g=n+a+(b-1)*e.getDivX(),l=n+a+(b+1)*e.getDivX(),m=n+(a+1)+b*e.getDivX(),
o=n+(a-1)+b*e.getDivX(),a=n+a+b*e.getDivX(),g=c[g],l=c[l],m=c[m],o=c[o],a=c[a];g===v&&(g=a);l===v&&(l=a);m===v&&(m=a);o===v&&(o=a);o=h.vec3.normalize([(m-a+(a-o))/2,2,(g-a+(a-l))/2]);this.normalBuffer[f][0]=o[0];this.normalBuffer[f][1]=o[1];this.normalBuffer[f][2]=o[2]}return this}},update:function(){var d=this.viewX||0,f=this.viewZ||0,e=this.divX+this.edgeX,c=this.divZ+this.edgeZ,n=this.hField.getDivX();this.hField.getDivZ();for(var a=this.hField.getFloat32Buffer(),b=f,c=f+c;b<c;b++)for(var g=d,
l=d+e;g<l;g++)this.points[(b-f)*e+(g-d)][1]=a[b*n+g];this._update()}});return{HeightField:o,HeightFieldBrush:m,HeightFieldMesh:q}});
CubicVR.RegisterModule("Landscape",function(h){var v=h.undef,r=Math.PI/2;return{Landscape:h.extendClassGeneral(h.SceneObject,function(){if(1<arguments.length)this.hField=new h.HeightField({size:arguments[0],divX:arguments[1],divZ:arguments[2]}),this.hfMesh=new h.HeightFieldMesh({hField:this.hField,size:arguments[0],divX:arguments[1],divZ:arguments[2],material:arguments[3],ofsX:this.hField.getCellSize()/2,ofsZ:this.hField.getCellSize()/2}),this.hfMesh.prepare(),h.SceneObject.apply(this,[{mesh:this.hfMesh,
shadowCast:!1}]);else{var m=arguments[0]||{};this.size=m.size||128;this.divX=m.divX||128;this.divZ=m.divZ||128;this.tiles=[];this.tileMeshes=[];this.tileMaterials=[];this.tileSpats=[];this.tileX=m.tileX||this.divX;this.tileZ=m.tileZ||this.divZ;this.tileChanged=[];this.tileSpatChanged=[];this.hField=new h.HeightField({size:this.size,divX:this.divX,divZ:this.divZ});this.divX>this.divZ?(this.sizeX=this.size,this.sizeZ=this.size/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?this.size/this.divZ*
this.divX:this.size,this.sizeZ=this.size);this.cellSize=this.sizeX/this.divX;this.tileSize=this.cellSize*this.tileX;this.spatResolution=m.spatResolution||256;this.spats=m.spats||[];this.sourceSpats=this.spats.slice(0);h.SceneObject.apply(this,[{mesh:null,shadowCast:!1}]);for(var o=0,q=0,d=0;d<this.divZ;d+=this.tileZ){for(var f=o=0;f<this.divX;f+=this.tileX){var e=new h.DrawBufferTexture({width:this.spatResolution,height:this.spatResolution}),c=f+1!=this.tileX?1:0,n=d+1!=this.tileZ?1:0,a=new h.SpatMaterial({color:[1,
1,1],specular:[0.05,0.05,0.05],spats:this.sourceSpats,sourceTexture:e,spatResolution:this.spatResolution,spatOffset:[this.divX/(this.divX+c),this.divZ/(this.divZ+n),1]}),c=new h.HeightFieldMesh({hField:this.hField,size:this.tileSize,divX:this.tileX,divZ:this.tileZ,viewX:f,viewZ:d,edgeX:c,edgeZ:n,material:a});c.prepare();var n=new h.SceneObject({mesh:c}),b=this.hField.getStartX(),g=this.hField.getStartZ();n.position[0]=b+this.tileSize*o+this.tileSize/2;n.position[2]=g+this.tileSize*q+this.tileSize/
2;this.bindChild(n);this.tiles.push(n);this.tileMeshes.push(c);this.tileMaterials.push(a);this.tileSpats.push(e);this.tileChanged.push(!1);this.tileSpatChanged.push(!1);o++}q++}m.jsonData&&this.loadFromJSON(m,m.compress||!1)}},{loadFile:function(m){var h=new FileReader;h.onload=function(m){return function(d){d=JSON.parse(d.target.result);m.loadFromJSON(d,d.compress)}}(this);h.readAsText(m)},loadFromJSON:function(m,h){var h=h||m.compress,q=this.tileSpats,d=m.jsonData.tiles;if(h){m.jsonData.heightfield=
Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(m.jsonData.heightfield),!0)).split(",");i=0;for(iMax=d.length;i<iMax;i++)d[i]=Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(d[i]),!0)).split(",")}var f=this.hField.getUint8Buffer(),e=m.jsonData.heightfield;i=0;for(iMax=f.length;i<iMax;i++)f[i]=parseInt(e[i],10);i=0;for(iMax=d.length;i<iMax;i++){for(var f=d[i],e=q[i].getUint8Buffer(),c=0,n=f.length;c<n;c++)e[c]=parseInt(f[c],10);this.tileChanged[i]=!0;this.tileSpatChanged[i]=
!0}this.update()},saveToJSON:function(m,h){var m=m!==v?m:!0,h=h!==v?h:!1,q,d,f={divX:this.divX,divZ:this.divZ,tileX:this.tileX,tileZ:this.tileZ,spats:this.spats,spatResolution:this.spatResolution,compress:m,size:this.size,jsonData:{heightfield:[],tiles:[]}},e=this.hField.getUint8Buffer(),c=f.jsonData.heightfield;q=0;for(d=e.length;q<d;q++)c[q]=e[q];e=this.tileSpats;c=f.jsonData.tiles;q=0;for(d=e.length;q<d;q++){c[q]=[];for(var n=c[q],a=e[q].getUint8Buffer(),b=0,g=a.length;b<g;b++)n[b]=a[b]}if(m){f.jsonData.heightfield=
Iuppiter.Base64.encode(Iuppiter.compress(f.jsonData.heightfield.join(",")),!0);q=0;for(d=c.length;q<d;q++)f.jsonData.tiles[q]=Iuppiter.Base64.encode(Iuppiter.compress(c[q].join(",")),!0)}q=JSON.stringify(f);if(h)uriContent="data:text/x-download;charset=utf-8,"+encodeURIComponent(q),window.location.href=uriContent;else return q},update:function(){var m,h;this.hField.needsFlush()&&this.hField.flush();m=this.hField.getDrawArea();if(!1!==m){var q=this.getTileAt(m.startX-this.cellSize,m.startZ-this.cellSize,
m.endX-m.startX+this.cellSize,m.endZ-m.startZ,this.cellSize);!1!==q&&q.length===v&&(q=[q]);m=0;for(h=q.length;m<h;m++)this.tileChanged[q[m]]=!0;this.hField.clearDrawArea()}m=0;for(h=this.tiles.length;m<h;m++)if(this.tileChanged[m]&&(this.tileMeshes[m].update(),this.tileChanged[m]=!1),this.tileSpatChanged[m])this.tileSpats[m].update(),this.tileSpatChanged[m]=!1},getHeightField:function(){return this.hField},mapGen:function(m,h,q,d,f){this.hField.setRect({src:m,startX:h,startZ:q,walkX:d,walkZ:f});this.hfMesh.update()},
getFaceAt:function(m,h){return this.hField.getFaceAt([m,0,h])},getHeightValue:function(m,h){return this.hField.getHeightValue([m,0,h])},orient:function(m,h,q,d,f,e){e===v&&(e=0);var c,n,a=[];c=q/2;var b=d/2;n=Math.sqrt(b*b+c*c);b=Math.atan2(b,c);f*=Math.PI/180;c=m+Math.sin(f)*e;e=h+Math.cos(f)*e;a[0]=this.getHeightValue([c+n*Math.cos(-b-r+f),0,e+n*-Math.sin(-b-r+f)]);a[1]=this.getHeightValue([c+n*Math.cos(b-r+f),0,e+n*-Math.sin(b-r+f)]);a[2]=this.getHeightValue([c+n*Math.cos(-b+r+f),0,e+n*-Math.sin(-b+
r+f)]);a[3]=this.getHeightValue([c+n*Math.cos(b+r+f),0,e+n*-Math.sin(b+r+f)]);n=-Math.atan2(a[1]-a[2],q);e=-Math.atan2(a[0]-a[1],d);n+=-Math.atan2(a[0]-a[3],q);e+=-Math.atan2(a[3]-a[2],d);return[[m,(a[2]+a[3]+a[1]+a[0])/4,h],[n/2*(180/Math.PI),f,e/2*(180/Math.PI)]]},getTileAt:function(m,h,q,d){var q=q||0,d=d||0,f=this.hField.getStartX(),e=this.hField.getStartZ(),c=Math.floor(this.divX/this.tileX),n=Math.floor((m-f)/(this.tileX*this.tileSize)*this.tileX),a=Math.floor((h-e)/(this.tileZ*this.tileSize)*
this.tileZ),b=0;if(0===q&&0===d)return b=parseInt(n+a*c,10);m=Math.floor((m+q-f)/(this.tileX*this.tileSize)*this.tileX);h=Math.floor((h+d-e)/(this.tileZ*this.tileSize)*this.tileZ);for(d=[];a<=h;a++)for(e=n;e<=m;e++)b=a*(this.divX/this.tileX)+e,0<=b&&b<this.tiles.length&&d.push(b);return d},getSpatLocation:function(m,h,q){if(q===v)m=(1-(m/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divX/this.tileX)%this.spatResolution,h=(1-(h/this.getHeightField().getSize()+0.5))*this.spatResolution*
(this.divZ/this.tileZ)%this.spatResolution;else var d=this.divX/this.tileX,f=q%d,d=Math.floor(q/d),q=this.hField.getStartX(),d=this.hField.getStartZ()+d*this.tileSize,m=(1-(m-(q+f*this.tileSize))/this.tileSize)*this.spatResolution,h=(1-(h-d)/this.tileSize)*this.spatResolution;return{x:m,z:h}},drawSpat:function(h,o,q){var d=q.getSize()*(this.size/this.spatResolution),f=h-d/2,e=o-d/2,d=this.getTileAt(f,e,h+d/2-f,o+d/2-e);!1!==d&&d.length===v&&(d=[d]);if(!1!==d){f=0;for(e=d.length;f<e;f++){var c=d[f],
n=this.getSpatLocation(h,o,c);0<=c&&c<this.tileSpats.length&&(this.tileSpats[c].draw(n.x,n.z,q),this.tileSpatChanged[c]=!0)}}}})}});
CubicVR.RegisterModule("SpatMaterial",function(h){var v=h.undef,r;return{SpatMaterial:h.extendClassGeneral(h.Material,function(m){m=m||{};r||(r=new h.Texture);this.spats=m.spats||[r,r,r,r,r];this.sourceTex=m.sourceTexture||r;this.spatResolution=m.spatResolution||256;this.spatTexel=1/this.spatResolution;var o=this.spats,q;for(q in o){var d=o[q];"string"===typeof d&&(o[q]=h.Textures_ref[d]!==v?h.Textures_obj[h.Textures_ref[d]]:new h.Texture(d))}this.spatOffset=m.spatOffset||[1,1,1];this.spatShader=
new h.CustomShader({vertex:"void main(void) {\n  vertexTexCoordOut = cubicvr_texCoord();\n  gl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n  #if !LIGHT_DEPTH_PASS  // not needed if shadowing \n    vertexNormalOut = matrixNormal * cubicvr_normal();\n    cubicvr_lighting();\n  #endif // !LIGHT_DEPTH_PASS \n}",fragment:"uniform sampler2D spatImage;\nuniform sampler2D spat0;\nuniform sampler2D spat1;\nuniform sampler2D spat2;\nuniform sampler2D spat3;\nuniform sampler2D spat4;\nuniform vec3 spatOffset;\nuniform float spatTexel;\nvoid main(void) \n{  \nvec2 texCoord = cubicvr_texCoord();\nvec2 spatTexCoord = texCoord*30.0;\nvec4 color = texture2D(spat0,spatTexCoord);\nvec2 spatSourceCoord = vec2(texCoord.x*spatOffset.x,texCoord.y*spatOffset.y);\nif (spatSourceCoord.s<=spatTexel/2.0) {\n   spatSourceCoord.s=spatTexel/2.0;\n}\nif (spatSourceCoord.s>=1.0-spatTexel/2.0) {\n   spatSourceCoord.s=1.0-spatTexel/2.0;\n}\nif (spatSourceCoord.t<=spatTexel/2.0) {\n   spatSourceCoord.t=spatTexel/2.0;\n}\nif (spatSourceCoord.t>=1.0-spatTexel/2.0) {\n   spatSourceCoord.t=1.0-spatTexel/2.0;\n}\nvec4 spatSource = texture2D(spatImage,spatSourceCoord);\ncolor = mix(color,texture2D(spat1,spatTexCoord),spatSource.r);\ncolor = mix(color,texture2D(spat2,spatTexCoord),spatSource.g);\ncolor = mix(color,texture2D(spat3,spatTexCoord),spatSource.b);\ncolor = mix(color,texture2D(spat4,spatTexCoord),spatSource.a);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n}",
init:function(){},update:function(d){return function(e,c){var n=c.textureIndex;e.spatImage.set(n++,d.sourceTex);e.spatOffset.set(d.spatOffset);e.spatTexel.set(d.spatTexel);o[0]&&e.spat0.set(n++,o[0]);o[1]&&e.spat1.set(n++,o[1]);o[2]&&e.spat2.set(n++,o[2]);o[3]&&e.spat3.set(n++,o[3]);o[4]&&e.spat4.set(n++,o[4])}}(this)});m.shader=this.spatShader;h.Material.apply(this,[m])},{setSpats:function(h){this.spats=h},getSpats:function(){return this.spats},setSource:function(h){this.sourceTexture=h}})}});
CubicVR.RegisterModule("Octree",function(h){function v(h,d){return h[0]*d[0]+h[1]*d[1]+h[2]*d[2]}h=h.enums;h.octree={T_NW:0,T_NE:1,T_SE:2,T_SW:3,B_NW:4,B_NE:5,B_SE:6,B_SW:7};var r=[[1,0,0],[0,1,0],[0,0,1]],m={engulf:function(h,d){h[0][0]>d[0]&&(h[0][0]=d[0]);h[0][1]>d[1]&&(h[0][1]=d[1]);h[0][2]>d[2]&&(h[0][2]=d[2]);h[1][0]<d[0]&&(h[1][0]=d[0]);h[1][1]<d[1]&&(h[1][1]=d[1]);h[1][2]<d[2]&&(h[1][2]=d[2])},reset:function(h,d){void 0===d&&(d=[0,0,0]);h[0][0]=d[0];h[0][1]=d[1];h[0][2]=d[2];h[1][0]=d[0];
h[1][1]=d[1];h[1][2]=d[2]},size:function(h){return[h[0][0]<h[1][0]?h[1][0]-h[0][0]:h[0][0]-h[1][0],h[0][1]<h[1][1]?h[1][1]-h[0][1]:h[0][1]-h[1][1],h[0][2]<h[1][2]?h[1][2]-h[0][2]:h[0][2]-h[1][2]]},containsPoint:function(h,d){return d[0]<=h[1][0]&&d[1]<=h[1][1]&&d[2]<=h[1][2]&&d[0]>=h[0][0]&&d[1]>=h[0][1]&&d[2]>=h[0][2]},overlaps:function(h,d){for(var f=0;3>f;++f){var e=v(h[0],r[f]),c=1E18,n=-1E15,e=v([d[0][0],d[0][1],d[0][2]],r[f]),c=e<c?e:c,n=e>n?e:n,e=v([d[1][0],d[0][1],d[0][2]],r[f]),c=e<c?e:c,
n=e>n?e:n,e=v([d[0][0],d[1][1],d[0][2]],r[f]),c=e<c?e:c,n=e>n?e:n,e=v([d[1][0],d[1][1],d[0][2]],r[f]),c=e<c?e:c,n=e>n?e:n,e=v([d[0][0],d[0][1],d[1][2]],r[f]),c=e<c?e:c,n=e>n?e:n,e=v([d[1][0],d[0][1],d[1][2]],r[f]),c=e<c?e:c,n=e>n?e:n,e=v([d[0][0],d[1][1],d[1][2]],r[f]),c=e<c?e:c,n=e>n?e:n,e=v([d[1][0],d[1][1],d[1][2]],r[f]),c=e<c?e:c,n=e>n?e:n,e=v(h[0],r[f]),a=v(h[1],r[f]);if(c>a||n<e)return!1}return!0},intersectsAABB:function(h,d){return m.containsPoint(h,d[0])||m.containsPoint(h,d[1])?!0:m.overlaps(h,
d)||m.overlaps(d,h)}},o=window.Octree=function(h){var d=function(c){var c=c||{},e=[],a=[],b=c.depth||0,g=c.size||0,f=g/2,h=c.position||[0,0,0];h.slice().concat(Math.sqrt(3*g/2*g/2));var m=[[h[0]-f,h[1]-f,h[2]-f],[h[0]+f,h[1]+f,h[2]+f]],o=c.root;that=this;Object.defineProperty(this,"position",{get:function(){return h}});Object.defineProperty(this,"aabb",{get:function(){return m}});Object.defineProperty(this,"numChildren",{get:function(){for(var a=0,b=0;8>b;++b)a+=e[b]?1:0;return a}});Object.defineProperty(this,
"children",{get:function(){return e}});Object.defineProperty(this,"size",{get:function(){return g}});Object.defineProperty(this,"nodes",{get:function(){return a}});Object.defineProperty(this,"root",{get:function(){return o}});this.remove=function(b){b=a.indexOf(b);-1<b&&a.splice(b,1)};this.insert=function(c){if(0===b){var f=that;a.push(c);c.addLeaf(that);c.rootTree=f;c.inserted(f)}else{var f=c.aabb,l=f[0],m=f[1],f=l[0]<h[0]&&l[1]<h[1]&&l[2]<h[2],o=m[0]>h[0]&&l[1]<h[1]&&l[2]<h[2],q=l[0]<h[0]&&m[1]>
h[1]&&l[2]<h[2],r=m[0]>h[0]&&m[1]>h[1]&&l[2]<h[2],x=l[0]<h[0]&&l[1]<h[1]&&m[2]>h[2],E=m[0]>h[0]&&l[1]<h[1]&&m[2]>h[2],v=l[0]<h[0]&&m[1]>h[1]&&m[2]>h[2],F=m[0]>h[0]&&m[1]>h[1]&&m[2]>h[2],l=0;if(f&&o&&q&&r&&x&&E&&v&&F)f=that,a.push(c),c.addLeaf(that),c.rootTree=f,c.inserted(f);else{for(var m=g/2,y=g/4,I=h[0],J=h[1],K=h[2],f=[[f,0,[I-y,J-y,K-y]],[o,1,[I+y,J-y,K-y]],[q,4,[I-y,J+y,K-y]],[r,5,[I+y,J+y,K-y]],[x,3,[I-y,J-y,K+y]],[E,2,[I+y,J-y,K+y]],[v,7,[I-y,J+y,K+y]],[F,6,[I+y,J+y,K+y]]],o=0;8>o;++o)f[o][0]&&
(e[f[o][1]]||(e[f[o][1]]=new d({size:m,depth:b-1,root:that,position:f[o][2]})),e[f[o][1]].insert(c),++l);if(1<l||!c.rootTree)c.rootTree=that}}};this.clean=function(){for(var b=0,c=0;8>c;++c)e[c]&&(e[c].clean()?e[c]=void 0:++b);return 0===a.length&&0===b?!0:!1}},h=h||{},f=h.size||0,h=h.depth||0;if(0>=f)throw Error("Octree needs a size > 0");if(0>=h)throw Error("Octree needs a depth > 0");var e=new d({size:f,depth:h});this.insert=function(c){e.insert(c)};this.clean=function(){e.clean()};Object.defineProperty(this,
"root",{get:function(){return e}});Object.defineProperty(this,"size",{get:function(){return f}})};o.Node=function(h){var h=h||{},d=[],f=this,e,c=!0,n;this.type=h.type;this.object=h.object;this.rootTree=void 0;this.inserted=function(a){c=!1;h.inserted&&h.inserted(a)};Object.defineProperty(this,"aabb",{get:function(){return e},set:function(a){c=!0;e=a;n=[e[0][0]+(e[1][0]-e[0][0])/2,e[0][1]+(e[1][0]-e[0][1])/2,e[0][2]+(e[1][0]-e[0][2])/2]}});f.aabb=h.aabb||[[0,0,0],[0,0,0]];var a=n.slice();this.addLeaf=
function(b){-1===d.indexOf(b)&&(d.push(b),b=b.aabb,m.engulf(a,b[0]),m.engulf(a,b[1]))};this.removeLeaf=function(a){a=d.indexOf(a);-1<a&&d.splice(a,1)};this.destroy=function(){d=[];f.rootTree=void 0};this.adjust=function(){if(c){var b=this.aabb,e=this.rootTree.aabb,l=b[0],h=b[1],o=e[0],e=e[1];if(0<d.length&&(l[0]<o[0]||l[1]<o[1]||l[2]<o[2]||h[0]>e[0]||h[1]>e[1]||h[2]>e[2])){l=0;for(h=d.length;l<h;++l)d[l].remove(f);d=[];l=f.rootTree;f.rootTree=void 0;if(l){for(;;)if(h=l.aabb,!m.containsPoint(b[0],
h)||!m.containsPoint(b[1],h))if(void 0!==l.root)l=l.root;else break;else break;m.reset(a,n);l.insert(f)}}}}};o.enums=h;return{Octree:o}});
CubicVR.RegisterModule("CVRXML",function(h){function v(d,a,b,e){var f=CubicVR.util,h=null,m=null;e.triangles&&(m=f.intDelimArray(c.getTextNode(e,"triangles")," "));if(m&&(e.segments&&(h=f.intDelimArray(c.getTextNode(e,"segments")," ")),null===h&&(h=[0,parseInt(m.length/3,10)]),e=0,d.setFaceMaterial(a),m.length)){p=0;for(pMax=h.length;p<pMax;p+=2){a=3*h[p+1];d.setSegment(h[p]);j=e;for(jMax=e+a;j<jMax;j+=3)f=d.addFace([m[j],m[j+1],m[j+2]]),b&&d.faces[f].setUV([b[j],b[j+1],b[j+2]]);e+=a}}}function r(d){var a=
CubicVR.util,b=new CubicVR.UVMapper,e=null,l=null;if(d.type)switch(e=c.getTextNode(d,"type"),e){case "planar":b.projection_mode=f.uv.projection.PLANAR;break;case "cylindrical":b.projection_mode=f.uv.projection.CYLINDRICAL;break;case "spherical":b.projection_mode=f.uv.projection.SPHERICAL;break;case "cubic":b.projection_mode=f.uv.projection.CUBIC}if(!e)return null;"uv"===e&&d.uv&&(l=c.getPoints(d,"uv"));if(d.axis)switch(c.getTextNode(d,"axis")){case "x":b.projection_axis=f.uv.axis.X;break;case "y":b.projection_axis=
f.uv.axis.Y;break;case "z":b.projection_axis=f.uv.axis.Z}d.center&&(b.center=a.floatDelimArray(c.getTextNode(d,"center")));d.rotation&&(b.rotation=a.floatDelimArray(c.getTextNode(d,"rotation")));d.scale&&(b.scale=a.floatDelimArray(c.getTextNode(d,"scale")));d.wrap_w&&(b.wrap_w_count=parseFloat(c.getTextNode(d,"wrap_w")));d.wrap_h&&(b.wrap_h_count=parseFloat(c.getTextNode(d,"wrap_h")));return""!==e&&"uv"!==e?b:l}function m(n,a){if(e[n]!==d)return e[n];var b=CubicVR.util,g,l,m,o;g=null;g="object"==
typeof n?n:-1!=n.indexOf(".js")?b.getJSON(n):CubicVR.util.xml2badgerfish(b.getXML(n));g.root&&(g=g.root);g.properties&&(g=g.properties);b=new CubicVR.Mesh;g.points&&(m=c.getPoints(g,"points"))&&b.addPoint(m);var q=g.material;q&&!q.length&&(q=[q]);var s=[];if(q){g=0;for(m=q.length;g<m;g++){var G=q[g],A;A=G;var H=a,B=new CubicVR.Material({name:A.name?A.name.$:null});A.shininess&&(B.shininess=c.getFloatNode(A,"shininess",B.shininess)/100);B.opacity=c.getFloatNode(A,"alpha",B.opacity);B.max_smooth=c.getFloatNode(A,
"max_smooth",B.max_smooth);B.color=c.getFloatDelimNode(A,"color",B.color);B.ambient=c.getFloatDelimNode(A,"ambient",B.ambient);B.diffuse=c.getFloatDelimNode(A,"diffuse",B.diffuse);B.specular=c.getFloatDelimNode(A,"specular",B.specular);l=void 0;if(l=c.getTextNode(A,"texture"))l=(H?H:"")+l,tex=h.Textures_ref[l]!==d?h.Textures_obj[h.Textures_ref[l]]:new CubicVR.Texture(l),B.setTexture(tex,f.texture.map.COLOR);if(l=c.getTextNode(A,"texture_luminosity"))l=(H?H:"")+l,tex=h.Textures_ref[l]!==d?h.Textures_obj[h.Textures_ref[l]]:
new CubicVR.Texture(l),B.setTexture(tex,f.texture.map.AMBIENT);if(l=c.getTextNode(A,"texture_normal"))l=(H?H:"")+l,tex=h.Textures_ref[l]!==d?h.Textures_obj[h.Textures_ref[l]]:new CubicVR.Texture(l),B.setTexture(tex,f.texture.map.NORMAL);if(l=c.getTextNode(A,"texture_specular"))l=(H?H:"")+l,tex=h.Textures_ref[l]!==d?h.Textures_obj[h.Textures_ref[l]]:new CubicVR.Texture(l),B.setTexture(tex,f.texture.map.SPECULAR);if(l=c.getTextNode(A,"texture_bump"))l=(H?H:"")+l,tex=h.Textures_ref[l]!==d?h.Textures_obj[h.Textures_ref[l]]:
new CubicVR.Texture(l),B.setTexture(tex,f.texture.map.BUMP);if(l=c.getTextNode(A,"texture_envsphere"))l=(H?H:"")+l,tex=h.Textures_ref[l]!==d?h.Textures_obj[h.Textures_ref[l]]:new CubicVR.Texture(l),B.setTexture(tex,f.texture.map.ENVSPHERE);if(l=c.getTextNode(A,"texture_alpha"))l=(H?H:"")+l,tex=h.Textures_ref[l]!==d?h.Textures_obj[h.Textures_ref[l]]:new CubicVR.Texture(l),B.setTexture(tex,f.texture.map.ALPHA);A=B;var t=null;l=H=null;G.uvmapper&&((H=r(G.uvmapper))&&!H.length?s.push([H,A]):l=H);(B=G.part)&&
!B.length&&(B=[B]);if(B&&B.length){var w=null,z=null;l=0;for(o=B.length;l<o;l++){var C=B[l],w=null;if(t=C.uvmapper)w=r(t),G.triangles&&(z=t=b.faces.length,w&&!w.length?(v(b,A,null,C),z=b.faces.length-1,b.calcFaceNormals(t,z),w.apply(b,A,d,t,z)):w&&w.length?v(b,A,w,C):H&&!H.length&&(v(b,A,null,C),z=b.faces.length-1,b.calcFaceNormals(t,z),H.apply(b,A,d,t,z)));if(C.procedural){(t=C.uvmapper)&&(w=r(t));var z=C.transform?c.getTransform(C.transform):d,t=d,C=C.procedural,D=c.getTextNode(C,"type");z&&(t=
new CubicVR.Transform,t.translate(z.position),t.pushMatrix(),t.rotate(z.rotation),t.pushMatrix(),t.scale(z.scale));H||(H=d);w={material:A,uvmapper:H||w};if("box"===D||"cube"===D)w.size=c.getFloatNode(C,"size"),b.booleanAdd(CubicVR.primitives.box(w),t);else if("sphere"===D)w.radius=c.getFloatNode(C,"radius"),w.lat=c.getIntNode(C,"lat"),w.lon=c.getIntNode(C,"lon"),b.booleanAdd(CubicVR.primitives.sphere(w),t);else if("cone"===D)w.base=c.getFloatNode(C,"base"),w.height=c.getFloatNode(C,"height"),w.lon=
c.getIntNode(C,"lon"),b.booleanAdd(CubicVR.primitives.cone(w),t);else if("plane"===D)w.size=c.getFloatNode(C,"size"),b.booleanAdd(CubicVR.primitives.plane(w),t);else if("cylinder"===D)w.radius=c.getFloatNode(C,"radius"),w.height=c.getFloatNode(C,"height"),w.lon=c.getIntNode(C,"lon"),b.booleanAdd(CubicVR.primitives.cylinder(w),t);else if("torus"===D)w.innerRadius=c.getFloatNode(C,"innerRadius"),w.outerRadius=c.getFloatNode(C,"outerRadius"),w.lat=c.getIntNode(C,"lat"),w.lon=c.getIntNode(C,"lon"),b.booleanAdd(CubicVR.primitives.torus(w),
t);else if("lathe"===D)w.points=c.getPoints(C,"p"),w.lon=c.getIntNode(C,"lon"),b.booleanAdd(CubicVR.primitives.lathe(w),t);else if("polygon"===D){z=c.getPoints(C,"p");z=new CubicVR.Polygon(z);(D=C.cut)&&!D.length&&(D=[D]);if(D.length){l=0;for(m=D.length;l<o;l++)z.cut(new CubicVR.Polygon(c.getPoints(D[l])))}w.front=0;w.back=0;w.frontShift=0;w.backShift=0;w.frontDepth=0;w.backDepth=0;if(C.extrude&&(C=C.extrude,w.front=c.getFloatNode(C,"front",0),w.back=c.getFloatNode(C,"back",0),w.frontShift=c.getFloatNode(C,
"frontBevelShift",0),w.backShift=c.getFloatNode(C,"backBevelShift",0),w.frontDepth=c.getFloatNode(C,"frontBevelDepth",0),w.backDepth=c.getFloatNode(C,"backBevelDepth",0),w.depth=c.getFloatNode(C,"depth",0),w.shift=c.getFloatNode(C,"shift",0),w.bevel=c.getFloatNode(C,"bevel",0),w.depth&&(!w.backDepth&&!w.frontDepth)&&(w.front=-w.depth/2,w.back=w.depth/2),w.shift&&(!w.backShift&&!w.frontShift)&&(w.frontShift=w.shift,w.backShift=w.shift),w.bevel&&!w.backDepth&&!w.frontDepth))w.frontDepth=w.bevel,w.backDepth=
w.bevel;C=z.toExtrudedBeveledMesh(new CubicVR.Mesh,w);C.setFaceMaterial(w.material);b.booleanAdd(C,t)}}}}else v(b,A,l,G)}}b.triangulateQuads();b.calcNormals();g=0;for(m=s.length;g<m;g++)s[g][0].apply(b,s[g][1]);b.compile();return e[n]=b}function o(c){return null===c?!1:c.getElementsByTagName("x").length||c.getElementsByTagName("y").length||c.getElementsByTagName("z").length||c.getElementsByTagName("fov").length}function q(c,a,b){var e=CubicVR.util,l=[];l[0]=c.getElementsByTagName("x");l[1]=c.getElementsByTagName("y");
l[2]=c.getElementsByTagName("z");l[3]=c.getElementsByTagName("fov");var h,m,o,s,q,r;for(r in l)if(l.hasOwnProperty(r)&&l[r]!==d&&l[r].length){h=l[r][0].getElementsByTagName("time");m=l[r][0].getElementsByTagName("value");o=l[r][0].getElementsByTagName("in");s=l[r][0].getElementsByTagName("out");q=l[r][0].getElementsByTagName("tcb");var v=null,B=null,t=null,w=c=null;o.length&&(c=e.collectTextNode(o[0]));s.length&&(w=e.collectTextNode(s[0]));h.length&&(v=e.floatDelimArray(e.collectTextNode(h[0])," "));
m.length&&(B=e.floatDelimArray(e.collectTextNode(m[0])," "));q.length&&(t=e.floatDelimArray(e.collectTextNode(q[0])," "));if(null!==v&&null!==B){h=0;for(m=v.length;h<m;h++)o=b.setKey(a,r,v[h],B[h]),t&&(o.tension=t[3*h],o.continuity=t[3*h+1],o.bias=t[3*h+2])}B=v=f.envelope.behavior.CONSTANT;if(c)switch(c){case "reset":v=f.envelope.behavior.RESET;break;case "constant":v=f.envelope.behavior.CONSTANT;break;case "repeat":v=f.envelope.behavior.REPEAT;break;case "oscillate":v=f.envelope.behavior.OSCILLATE;
break;case "offset":v=f.envelope.behavior.OFFSET;break;case "linear":v=f.envelope.behavior.LINEAR}if(w)switch(w){case "reset":B=f.envelope.behavior.RESET;break;case "constant":B=f.envelope.behavior.CONSTANT;break;case "repeat":B=f.envelope.behavior.REPEAT;break;case "oscillate":B=f.envelope.behavior.OSCILLATE;break;case "offset":B=f.envelope.behavior.OFFSET;break;case "linear":B=f.envelope.behavior.LINEAR}b.setBehavior(a,r,v,B)}}var d=h.undef,f=CubicVR.enums,e=[],c={getPoints:function(e,a,b){e=a?
c.getTextNode(e,a):e.$;if(!e)return d;e=e.split(" ");i=0;for(iMax=e.length;i<iMax;i++){e[i]=e[i].split(",");j=0;for(jMax=e[i].length;j<jMax;j++)e[i][j]=parseFloat(e[i][j]);b&&(e[i][2]=0)}return e},getTransform:function(c){var a=CubicVR.util;if(!c)return null;var b={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d;postition=c.position;d=c.rotation;c=c.scale;d&&(b.rotation=a.floatDelimArray(d.$));c&&(b.scale=a.floatDelimArray(c.$));return d||c?b:null},getTextNode:function(c,a,b){c=c[a];if(!c)return b;
c.length&&(c=c[0]);return c.$?c.$:b},getFloatNode:function(d,a,b){return(d=c.getTextNode(d,a))?(d=parseFloat(d),d!=d?b:d):b},getIntNode:function(d,a,b){return(d=c.getTextNode(d,a))?(d=parseInt(d,10),d!=d?b:d):b},getFloatDelimNode:function(d,a,b,e){var f=CubicVR.util;return(d=c.getTextNode(d,a))?f.floatDelimArray(d,e):b},getIntDelimNode:function(d,a,b,e){var f=CubicVR.util;return(d=c.getTextNode(d,a))?f.intDelimArray(d,e):b}};return{loadMesh:m,loadScene:function(c,a,b){var e=CubicVR.util;a===d&&(a=
"");b===d&&(b="");for(var l=new CubicVR.Mesh,h=e.getXML(c),c=new CubicVR.Scene,r=[],x=h.getElementsByTagName("sceneobjects"),s,v,A,H=0,B=x[0].childNodes.length;H<B;H++){var t=x[0].childNodes[H];if("sceneobject"===t.tagName){var w="unnamed",z="",C="",l=t.getElementsByTagName("name");l.length&&(w=e.collectTextNode(l[0]));l=t.getElementsByTagName("parent");l.length&&(z=e.collectTextNode(l[0]));l=t.getElementsByTagName("model");l.length&&(C=e.collectTextNode(l[0]));A=v=s=null;l=t.getElementsByTagName("position");
l.length&&(s=l[0]);l=t.getElementsByTagName("rotation");l.length&&(v=l[0]);l=t.getElementsByTagName("scale");l.length&&(A=l[0]);l=null;""!==C&&(l=m(a+C,b));l=new CubicVR.SceneObject(l,w);o(s)?(l.motion||(l.motion=new CubicVR.Motion),q(s,f.motion.POS,l.motion)):s&&(l.position=e.floatDelimArray(e.collectTextNode(s)));o(v)?(l.motion||(l.motion=new CubicVR.Motion),q(v,f.motion.ROT,l.motion)):l.rotation=e.floatDelimArray(e.collectTextNode(v));o(A)?(l.motion||(l.motion=new CubicVR.Motion),q(A,f.motion.SCL,
l.motion)):l.scale=e.floatDelimArray(e.collectTextNode(A));c.bindSceneObject(l);""!==z&&r.push([l,z])}}for(var D in r)r.hasOwnProperty(D)&&c.getSceneObject(r[D][1]).bindChild(r[D][0]);a=h.getElementsByTagName("camera");a.length&&((v=s=null,b="",l=a[0].getElementsByTagName("name"),D=c.camera,h=null,l.length&&(b=l[0].firstChild.nodeValue),l=a[0].getElementsByTagName("target"),l.length&&(b=l[0].firstChild.nodeValue),""!==b&&(D.targetSceneObject=c.getSceneObject(b)),l=a[0].getElementsByTagName("position"),
l.length&&(s=l[0]),l=a[0].getElementsByTagName("rotation"),l.length&&(v=l[0]),l=a[0].getElementsByTagName("fov"),l.length&&(h=l[0]),o(s)?(D.motion||(D.motion=new CubicVR.Motion),q(s,f.motion.POS,D.motion)):s&&(D.position=e.floatDelimArray(s.firstChild.nodeValue)),o(v)?(D.motion||(D.motion=new CubicVR.Motion),q(v,f.motion.ROT,D.motion)):v&&(D.rotation=e.floatDelimArray(v.firstChild.nodeValue)),o(h))?(D.motion||(D.motion=new CubicVR.Motion),q(h,f.motion.FOV,D.motion)):h&&(D.fov=parseFloat(h.firstChild.nodeValue)));
return c}}});
CubicVR.RegisterModule("Worker",function(h){function v(a){var c=this;this.message=a.message||function(){};this.send=function(a,c){postMessage({message:a,data:c})};self.addEventListener("message",function(a){"init"!==a.data.message&&c.message(a.data)},!1)}function r(a){function c(a){setTimeout(function(){b.send("test",a)},1E3)}a&&c(a);var b=new v({message:c})}function m(a){function c(a){a=u.getURL(a);b.send("done",a.length)}var b;b=new v({message:function(a){c(a)}});a&&c(a)}function o(a){function c(a){a=u.getURL(a);
b.send("loaded",a)}var b,d;b=new v({message:function(a){if("parse"===a.message)d=new l,CubicVR.loadCollada("","",d,a.data),b.send("parsed");else if("getMesh"===a.message){if(a=d.meshMap[":"+a.data]){var c=a.triangulateQuads().compileVBO(a.compileMap());b.send("getMesh",{mesh:a,vbo:c})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&c(a)}function q(a){function c(a){var d=new e,f;for(f in a)a.hasOwnProperty(f)&&(d[f]=a[f]);a=d.triangulateQuads().compileVBO(d.compileMap());b.send("done",
a)}var b;b=new v({message:function(a){c(a)}});a&&c(a)}try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(d){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var f=h.undef,e=CubicVR.Mesh,c=CubicVR.Texture,n=CubicVR.Material,a=CubicVR.SceneObject,b=CubicVR.Motion,g=CubicVR.Envelope,l=CubicVR.DeferredBin,u=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=
a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var c=this;this.worker.onmessage=function(a){c.message(a.data)};this.worker.onerror=function(a){c.error(a)};this.init=function(a){c.send("init",{type:c.type,data:a})};this.send=function(a,b){c.worker.postMessage({message:a,data:b})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&c.init(a.data)},ResourcePool:function(){function b(a){var c=a.parsed||
function(){},d={},f;a.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:a.url,message:function(a){if("loaded"===a.message){var a=(new DOMParser).parseFromString(a.data,"text/xml"),b=u.xml2badgerfish(a);console.log(a);f.send("parse",b)}else if("getMesh"===a.message){var b=new e,g;for(g in a.data.mesh)a.data.mesh.hasOwnProperty(g)&&(b[g]=a.data.mesh[g]);b.bindBuffer(b.bufferVBO(a.data.vbo));d.getMesh&&d.getMesh(b)}else"parsed"===a.message&&c()}}));this.getSceneObject=function(a,c){f.send("getMesh",
a);d.getMesh=c}}function d(a,c){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}var f=this,g={};this.createSceneFileManager=function(a){var c=new b({url:a.url,parsed:a.parsed});return g[a.url]=c};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete g[settings];else for(var c in g)g[c]===a&&delete g[c]};this.createSceneObjectFromMesh=function(b){var g=b.scene,l=b.object,h=b.assetBase||"",m=f.createSceneFileManager({url:b.mesh,parsed:function(){l&&m.getSceneObject(l,
function(b){for(var b=d(b,new e),f=0,l=b.materials.length;f<l;++f){for(var m=d(b.materials[f],new n),o=0,s=m.textures.length;o<s;++o){var q=m.textures[f];m.textures[f]=new c(h+q.img_path,q.filter_type)}b.materials[f]=m}b=new a(b);g.bindSceneObject(b)})}})};this.loadFile=function(a,c){c=c||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){c(a.data)}})}},loadColladaWorker:function(d,l,h,m){var o;try{o=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(q){throw Error("Can't find collada.js");
}var u=[],t=[];o.onmessage=function(l){function o(a,c){for(var b in a)c[b]=a[b]}function q(a){if(a.motion){for(var c=a.motion.controllers,d=[],e=0,f=c.length;e<f;++e){var l=c[e];if(l){for(var h=[],m=0,n=l.length;m<n;++m){var s=l[m];if(s){var u=s.keys[0];1<s.keys.length&&(u.prev=null,u.next=s.keys[1],u=s.keys[1]);for(var t=1,r=s.keys.length-1;t<r;++t)u.prev=s.keys[t-1],u.next=s.keys[t+1],u=s.keys[t+1];1<s.keys.length&&(u=s.keys[s.keys.length-1],u.prev=s.keys[s.keys.length-2],u.next=null);s.firstKey=
s.keys[0];s.lastKey=s.keys[s.keys.length-1];s.keys=s.firstKey;u=new g;o(s,u);h[m]=u}else l[m]=null}d[e]=h}else c[e]=null}a.motion.controllers=d;c=new b;o(a.motion,c);a.motion=c}}function r(c){var b=new a;o(c,b);if(null!==c.obj){var g=t[c.obj.id];if(g===f)if(g=new e,o(c.obj,g),b.obj=g,t[c.obj.id]=g,m){if(0<g.points.length){m.addMesh(d,d+":"+g.id,g);for(var l=0,h=g.faces.length;l<h;++l){var n=g.faces[l],s=n.material;n.material=u[s]!==f?u[s]:0}}}else b.obj.triangulateQuads(),b.obj.calcNormals(),b.obj.compile(),
b.obj.clean();else b.obj=g}b.trans=new Transform;if(c.children&&0<c.children.length&&(b.children=[],c.children)){g=0;for(l=c.children.length;g<l;++g)h=r(c.children[g]),b.bindChild(h)}return b}var x;x=l.data.message;if("materials"==x){var A=JSON.parse(l.data.data),l=0;for(x=A.length;l<x;++l){var v=new n(A[l].name),H=v.material_id;o(A[l],v);v.material_id=H;u[A[l].material_id]=H;for(var H=0,K=A[l].textures.length;H<K;++H){var L=A[l].textures[H];if(L){var M=Texture_ref[L.img_path];M===f?(L=new c(L.img_path,
L.filter_type,m,d),v.textures[H]=L):v.textures[H]=Textures_obj[M]}else v.textures[H]=0}}}else if("scene"==x){A=JSON.parse(l.data.data);l=0;for(x=A.sceneObjects.length;l<x;++l)v=A.sceneObjects[l],null!==v.obj&&nop(),v.reassembled===f&&(q(v),v.reassembled=!0),A.sceneObjects[l]=r(v);v=new Scene;l=v.camera;x=l.transform;o(A.camera,l);o(A.camera.transform,x);q(l);v.camera=l;v.camera.transform=x;v.camera.frustum=new Frustum;l=0;for(x=A.sceneObjects.length;l<x;++l){H=A.sceneObjects[l];v.bindSceneObject(H);
try{H.getAABB()}catch(X){}}l=0;for(x=A.lights.length;l<x;++l)H=new Light,o(A.lights[l],H),H.trans=new Transform,q(H),v.bindLight(H);h(v)}else console.log("message from collada worker:",l.data.message)};o.onerror=function(a){console.log("error from collada worker:",a.message)};o.postMessage({message:"start",params:{meshUrl:d,prefix:l,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:r,prepareMesh:q,file:m,sceneFile:o};self.addEventListener("message",function(c){if("init"===
c.data.message){var b=c.data.data.type;if(b in a)new a[b](c.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(h){function v(a){for(var c=a.length,b=0,d=c-1,e=0;e<c;d=e++)b+=a[d][0]*a[e][1]-a[e][0]*a[d][1];return 0.5*b}function r(a){var c=[],d=a.length;if(3>d)return null;var e=[],f;if(0<v(a))for(f=0;f<d;f++)e[f]=f;else for(f=0;f<d;f++)e[f]=d-1-f;var h=2*d,m;m=0;for(f=d-1;2<d;){if(0>=h--)return null;var n=f;d<=n&&(n=0);f=n+1;d<=f&&(f=0);var o=f+1;d<=o&&(o=0);var q;a:{q=a;var t=n,r=f,z=o,C=d,D=e,F=void 0,y=void 0,I=void 0,J=void 0,K=void 0,L=void 0,M=void 0,X=void 0,
fa=void 0,y=q[D[t]][0],I=q[D[t]][1],J=q[D[r]][0],K=q[D[r]][1],L=q[D[z]][0],M=q[D[z]][1];if(b>(J-y)*(M-I)-(K-I)*(L-y))q=!1;else{for(F=0;F<C;F++)if(!(F==t||F==r||F==z)){var X=q[D[F]][0],fa=q[D[F]][1],Q=void 0,Ca=void 0,O=void 0,N=void 0,pa=void 0,fb=void 0,gb=void 0,Ma=void 0,pb=void 0,Na=void 0,hb=void 0,qb=void 0,Q=O=pa=void 0,Q=L-J,Ca=M-K,O=y-L,N=I-M,pa=J-y,fb=K-I,gb=X-y,Ma=fa-I,pb=X-J,Na=fa-K,hb=X-L,qb=fa-M,Q=Q*Na-Ca*pb,pa=pa*Ma-fb*gb,O=O*qb-N*hb;if(0<=Q&&0<=O&&0<=pa){q=!1;break a}}q=!0}}if(q){h=
e[n];n=e[f];o=e[o];c.push(h);c.push(n);c.push(o);m++;o=f;for(h=f+1;h<d;o++,h++)e[o]=e[h];d--;h=2*d}}return c}function m(c,b,d){d===a&&(d=0);var e;e=r(b);var f=CubicVR.util.repackArray(e,3,e.length/3),h=[],m=c.points.length;e=0;for(iMax=b.length;e<iMax;e++)h.push([b[e][0],b[e][1],d]);c.addPoint(h);e=0;for(iMax=f.length;e<iMax;e++)c.addFace([f[e][0]+m,f[e][1]+m,f[e][2]+m])}function o(a,c){var b=c[0]-a[0],d=c[1]-a[1];return Math.sqrt(b*b+d*d)}function q(a,c){var b,d,e=[],f=a.length,h=c.length,m=[];for(b=
0;b<f;b++)for(d=0;d<h;d++){var n=o(a[b],c[d]);e.push([n,b,d])}e.sort(function(a,c){return a[0]>c[0]});for(b=0;5>b;b++)for(d=0;d<e.length;d++)b!=d&&e[b][1]!=e[d][1]&&e[b][2]!=e[d][2]&&e[b][1]<e[d][1]&&e[b][2]<e[d][2]&&4>Math.abs(e[b][1]-e[d][1])&&4>Math.abs(e[b][2]-e[d][2])&&m.push([b,d]);m.sort(function(a,c){return e[a[0]][0]+e[a[1]][0]>e[c[0]][0]+e[c[1]][0]});10<m.length&&(m.length=10);d=[];for(b=0;b<m.length;b++)d.push([e[m[b][0]],e[m[b][1]]]);return d}function d(a,c){var b=q(a,c),d;if(!b.length)return null;
d=b[0][0];var e=b[0][1],b=e[1]-d[1],e=e[2]-d[2],f=a.slice(d[1]),f=f.concat(a.slice(0,d[1])),h=c.slice(d[2]),h=h.concat(c.slice(0,d[2])),m=[];for(d=b;d<f.length;d++)m.push(f[d]);m.push(f[0]);for(d=e;d<h.length;d++)m.push(h[d]);m.push(h[0]);var n=[];for(d=0;d<=b;d++)n.push(f[d]);for(d=0;d<=e;d++)n.push(h[d]);return[m,n]}function f(a){for(var c=[0,0],b=0;b<a.length;b++)c[0]+=a[b][0],c[1]+=a[b][1];c[0]/=a.length;c[1]/=a.length;return c}function e(a,c,b){for(var d=[],e=0;e<a.length;e++){var f=[a[e][0]-
c[0],a[e][1]-c[1]],h=Math.sqrt(f[0]*f[0]+f[1]*f[1])+b,f=Math.atan2(f[1],f[0]);d[e]=[c[0]+Math.cos(f)*h,c[1]+Math.sin(f)*h]}return d}function c(a,c,b,d,e){var f,h=a.points.length;if(c.length!=b.length)return null;var m=c.length;for(f=0;f<m;f++)a.addPoint([c[f][0],c[f][1],d]);for(f=0;f<m;f++)a.addPoint([b[f][0],b[f][1],e]);for(f=0;f<m-1;f++)a.addFace([h+f,h+f+1,h+(f+m+1),h+(f+m)]);f=m-1;a.addFace([h+f,h,h+m,h+(f+m)])}function n(a){this.points=a;0>this.area()&&(this.points=a.reverse());this.cuts=[];
this.result=[]}var a=h.undef,b=1.0E-10;n.prototype={cut:function(a){this.cuts.push(a)},flip:function(){this.points=this.points.reverse()},area:function(){return v(this.points)},toMesh:function(a){if(0!==this.points.length){var c;a||(a=new CubicVR.Mesh);this.result=[this.points];for(c=0;c<this.cuts.length;c++){var b=this.cuts[c].points.slice(0),b=b.reverse(),b=d(this.result[0],b);this.result[0]=b[0];this.result.push(b[1])}for(c=0;c<this.result.length;c++)m(a,this.result[c]);a.removeDoubles();return a}},
toExtrudedMesh:function(b,e,f){if(0!==this.points.length){var h,n;e===a&&(e=0);f===a&&(f=0);var o=e!=f;b||(b=new CubicVR.Mesh);this.result=[this.points];for(n=0;n<this.cuts.length;n++)h=this.cuts[n].points.slice(0),h=h.reverse(),h=d(this.result[0],h),this.result[0]=h[0],this.result.push(h[1]);h=new CubicVR.Mesh;for(n=0;n<this.result.length;n++)m(h,this.result[n],f);b.booleanAdd(h);h.flipFaces();if(o)for(n=0;n<h.points.length;n++)h.points[n][2]=e;b.booleanAdd(h);if(o){c(b,this.points,this.points,e,
f);for(n=0;n<this.cuts.length;n++)h=this.cuts[n].points.slice(0),h=h.reverse(),c(b,h,h,e,f)}b.removeDoubles();return b}},toExtrudedBeveledMesh:function(a,b,h,n,o,s,q){var r=[],v=[],B,t,w,z;if(0!==this.points.length){"object"===typeof b&&(q=b,b=q.front||0,h=q.back||0,n=q.frontDepth||0,o=q.frontShift||0,s=q.backDepth||0,q=q.backShift||0);var C=b!==h,D=0!==s,F=0!==n;a||(a=new CubicVR.Mesh);F?(t=f(this.points),t=e(this.points,t,-o),this.result=[t.slice(0)]):this.result=[this.points.slice(0)];for(z=0;z<
this.cuts.length;z++)w=f(this.cuts[z].points),w=e(this.cuts[z].points,w,o),w=w.reverse(),r.push(w),w=d(this.result[0],w),this.result[0]=w[0],this.result.push(w[1]);o=new CubicVR.Mesh;for(z=0;z<this.result.length;z++)m(o,this.result[z],b-n);o.flipFaces();a.booleanAdd(o);if(D||F){B=f(this.points);B=e(this.points,B,-q);this.result=[B.slice(0)];for(z=0;z<this.cuts.length;z++)w=f(this.cuts[z].points),w=e(this.cuts[z].points,w,q),w=w.reverse(),v.push(w),w=d(this.result[0],w),this.result[0]=w[0],this.result.push(w[1]);
o=new CubicVR.Mesh;for(z=0;z<this.result.length;z++)m(o,this.result[z],h+s)}else{for(z=0;z<o.points.length;z++)o.points[z][2]=h;o.flipFaces()}a.booleanAdd(o);F&&c(a,t,this.points,b-n,b);C&&c(a,this.points,this.points,b,h);D&&c(a,this.points,B,h,h+s);for(z=0;z<r.length;z++)w=this.cuts[z].points.slice(0).reverse(),F&&c(a,r[z],w,b-n,b),C&&c(a,w,w,b,h),D&&c(a,w,v[z],h,h+s);a.removeDoubles();return a}}};return{polygon:{triangulate2D:r,toMesh:m,findNearPair:function(a,b){for(var c=[0,0],d=o(a[0],b[0]),
e=a.length,f=b.length,h=0;h<e;h++)for(var m=0;m<f;m++){var n=o(a[h],b[m]);n<d&&(c[0]=h,c[1]=m,d=n)}return c},subtract:d,addOffset:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d];c.push([f[0]+b[0],f[1]+b[1]])}return c},normal:function(a){for(var b=[0,0,0],c=0,d=a.length;c<d;c++){var e=a[c],f=a[(c+1)%d];b[0]+=(e[1]-f[1])*(e[2]+f[2]);b[1]+=(e[2]-f[2])*(e[0]+f[0]);b[2]+=(e[0]-f[0])*(e[1]+f[1])}return h.vec3.normalize(b)}},Polygon:n}});
CubicVR.RegisterModule("ScenePhysics",function(h){function v(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function r(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function m(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function o(a){return new Ammo.btVector3(a[0],a[1],a[2])}function q(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function d(a){return[a.x(),a.y(),a.z()]}function f(a){this.setManifold(a)}var e=h.undef,c=h.enums;
c.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var n,a,b,g,l,u=function(a,b,c){var d;
!a.position&&a.sceneObject&&(d=a,a=a.sceneObject,b=d.properties,c=d.collision);d=h.get(d)||{};this.properties=new h.RigidProperties(b?h.get(b):{collision:c});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(o(this.init_position));this.transform.setRotation(q(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};u.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===c.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),v(this.linearVelocity,g),this.body.setLinearVelocity(g),v(this.angularVelocity,g),this.body.setAngularVelocity(g),h.vec3.equal([0,0,0],this.impulse)||(v(this.impulse,g),v(this.impulsePosition,l),this.body.applyImpulse(g,l)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(b){if(this.body&&(this.body.isActive()||b))return this.body.getMotionState().getWorldTransform(n),b=n.getOrigin(),b.x!=b.x?console.log("origin is NaN"):(this.sceneObject.position[0]=b.x(),this.sceneObject.position[1]=b.y(),this.sceneObject.position[2]=b.z()),b=n.getRotation(),a.x=b.x(),a.y=b.y(),a.z=b.z(),a.w=b.w(),a.x!=a.x?console.log("rotation is NaN"):(b=a.toEuler(),
this.sceneObject.rotation[0]=b[0],this.sceneObject.rotation[1]=b[1],this.sceneObject.rotation[2]=b[2]),!0},reset:function(){if(this.body){var c=this.body.getWorldTransform().getOrigin();v(this.init_position,c);this.body.getWorldTransform().getRotation();this.resetMotion();c=this.init_rotation;a.fromEuler(c[0],c[1],c[2]);c=[a.x,a.y,a.z,a.w];b.setX(c[0]);b.setY(c[1]);b.setZ(c[2]);b.setW(c[3]);this.body.getWorldTransform().setRotation(b);this.activate()}},resetMotion:function(){v(this.init_linearVelocity,
g);this.body.setLinearVelocity(g);v(this.init_angularVelocity,g);this.body.setAngularVelocity(g);h.vec3.equal([0,0,0],this.init_impulse)||(v(this.init_impulse,g),v(this.init_impulsePosition,l),this.body.applyImpulse(g,l))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var b=a.getShapes(),d,e,f,g,l,m,r,u=[],x=null;e=0;for(f=b.length;e<f;e++){d=b[e];x=null;if(d.type===c.collision.shape.BOX)x=new Ammo.btBoxShape(new Ammo.btVector3(d.size[0]/
2,d.size[1]/2,d.size[2]/2));else if(d.type===c.collision.shape.SPHERE)x=new Ammo.btSphereShape(d.radius);else if(d.type===c.collision.shape.CAPSULE)x=new Ammo.btCapsuleShape(d.radius,d.height);else if(d.type===c.collision.shape.CYLINDER)x=new Ammo.btCylinderShape(new Ammo.btVector3(d.size[0]/2,d.size[1]/2,d.size[2]/2));else if(d.type===c.collision.shape.CONE)x=new Ammo.btConeShape(d.radius,d.height);else if(d.type===c.collision.shape.MESH){r=d.mesh;x=new Ammo.btTriangleMesh;m=d.size;var y=new Ammo.btVector3(0,
0,0),E=new Ammo.btVector3(0,0,0),J=new Ammo.btVector3(0,0,0),K=r.getMaterials();g=0;for(l=r.faces.length;g<l;g++){var L=r.faces[g];K[L.material].collision&&3===L.points.length&&(y.setValue(r.points[L.points[0]][0]*m[0],r.points[L.points[0]][1]*m[1],r.points[L.points[0]][2]*m[2]),E.setValue(r.points[L.points[1]][0]*m[0],r.points[L.points[1]][1]*m[1],r.points[L.points[1]][2]*m[2]),J.setValue(r.points[L.points[2]][0]*m[0],r.points[L.points[2]][1]*m[1],r.points[L.points[2]][2]*m[2]),x.addTriangle(y,E,
J))}0===this.getMass()||this.getType()==c.physics.body.STATIC||this.getType()==c.physics.body.GHOST?(this.setMass(0),x=new Ammo.btBvhTriangleMeshShape(x,!0)):x=new Ammo.btConvexTriangleMeshShape(x,!0)}else if(d.type===c.collision.shape.CONVEX_HULL){r=d.mesh;m=d.size;y=new Ammo.btVector3(0,0,0);x=new Ammo.btConvexHullShape;g=0;for(l=r.points.length;g<l;g++)v([r.points[g][0]*m[0],r.points[g][1]*m[1],r.points[g][2]*m[2]],y),x.addPoint(y)}else if(d.type===c.collision.shape.HEIGHTFIELD){E=y=r=m=0;if(d.landscape&&
!d.getHeightField&&d.landscape instanceof h.HeightField)d.heightfield=d.landscape;else if(d.landscape&&d.landscape instanceof h.Landscape){m=d.landscape.getHeightField().getDivX();y=d.landscape.getHeightField().getDivZ();r=d.landscape.getHeightField().getSizeX();E=d.landscape.getHeightField().getSizeZ();x=d.landscape.getHeightField().getFloat32Buffer();d.landscape.getHeightField();var M=Ammo.allocate(4*x.length,"float",Ammo.ALLOC_NORMAL);g=0;for(l=m*y;g<l;g++)Ammo.setValue(M+(g<<2),x[g],"float")}if(d.heightfield&&
d.heightfield instanceof h.HeightField){m=d.heightfield.getDivX();y=d.heightfield.getDivZ();r=d.heightfield.getSizeX();E=d.heightfield.getSizeZ();x=d.heightfield.getFloat32Array();M=Ammo.allocate(4*x.length,"float",Ammo.ALLOC_NORMAL);g=0;for(l=m*y;g<l;g++)Ammo.setValue(M+(g<<2),x[g],"float")}x=new Ammo.btHeightfieldTerrainShape(m,y,M,1,-100,100,1,0,!1);x.setUseDiamondSubdivision(!0);g=new Ammo.btVector3(r/m,1,E/y);x.setLocalScaling(g)}x&&(0!==d.margin&&x.setMargin(d.margin),u.push({cShape:d,btShape:x}))}b=
null;if(1===u.length)b=u[0].btShape;else if(1<u.length){n=new Ammo.btTransform;b=new Ammo.btCompoundShape(!1);e=0;for(f=u.length;e<f;e++)n.setIdentity(),n.setOrigin(o(u[e].cShape.position)),n.setRotation(q(u[e].cShape.rotation)),b.addChildShape(n,u[e].btShape)}a.setResult(b);a=b}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(v(a,g),this.body.setAngularVelocity(g))},setGravity:function(a){this.gravity=a;this.body&&(v(a,g),this.body.setGravity(g))},
getGravity:function(){return this.gravity&&!this.body?this.gravity:d(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(v(a,g),this.body.setLinearVelocity(g))},applyImpulse:function(a,b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!h.vec3.equal([0,0,0],a)&&(v(this.impulse,g),v(this.impulsePosition,l),this.body.applyImpulse(g,l))},applyForce:function(a,b){this.body&&!h.vec3.equal([0,0,0],a)&&(v(a,g),v(b,l),this.body.applyImpulse(g,l))},getAngularVelocity:function(){return d(this.body.getAngularVelocity())},
getLinearVelocity:function(){return d(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(c.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(a){this.body&&a!==e&&(a.length||(a=[a,a,a]),v(a,g),this.body.setAngularFactor(g))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==c.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=
a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=a=h.parseEnum(c.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)v(a,g),this.body&&this.body.getCenterOfMassTransform().setOrigin(g),this.ghost&&this.ghost.getWorldTransform().setOrigin(g)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(b);
this.ghost&&this.ghost.getWorldTransform().getRotation(b);var a=new h.Quaternion;m(b,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)r(a,b),this.body&&this.body.getCenterOfMassTransform().setRotation(b),this.ghost&&this.ghost.getWorldTransform().setRotation(b)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new h.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(b);this.ghost&&this.ghost.getWorldTransform().getRotation(b);
m(b,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=a;b.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(b);this.ghost&&this.body.getWorldTransform().setRotation(b)}};var E=function(a){a=a||{};this.ctype=h.parseEnum(c.physics.constraint,a.ctype)||c.physics.constraint.P2P;this.strength=a.strength||0.1;this.maxImpulse=a.maxImpulse||0;this.rigidBodyA=a.rigidBodyA||a.rigidBody||
null;this.rigidBodyB=a.rigidBodyB||null;this.positionA=a.positionA||[0,0,0];this.positionB=a.positionB||a.position||[0,0,0];this.damping=a.damping!=e?a.damping:1;this.btConstraint=null;this.localPivotA=o(this.positionA);this.localPivotB=o(this.positionB)};E.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;this.ctype===c.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),
this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL&&(this.btConstraint=null))}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},
setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(v(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};f.prototype={getContact:function(){var a=
this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),positionA:d(a.getPositionWorldOnA()),positionB:d(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var x=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;
this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!n||!a)g=
new Ammo.btVector3,l=new Ammo.btVector3,n=new Ammo.btTransform,a=new h.Quaternion,b=new Ammo.btQuaternion};x.prototype={addConstraint:function(a){var b=a.getConstraint();return b?(this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){v(a,g);this.dynamicsWorld.setGravity(g)},bindSceneObject:function(a,b){var c=new h.RigidBody(a,b);this.rigidObjects.push(c);
c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bind:function(a){a instanceof h.Vehicle?a.initBody(this):a instanceof h.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof h.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(a))return;this.ghostObjects.push(a);var b=a.getBody();a.properties.blocker||b.setCollisionFlags(b.getCollisionFlags()+c.physics.collision_flags.NO_CONTACT_RESPONSE);
this.dynamicsWorld.addCollisionObject(b)}else{if(-1!==this.rigidObjects.indexOf(a))return;this.rigidObjects.push(a);b=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(b);a.updateSceneObject(!0)}var d,e;if((d=a.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(c.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(c.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(a))return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),
1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(-1===this.rigidObjects.indexOf(a))return;this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var b,d;if((b=a.getSceneObject())&&(d=b.getEventHandler()))d.hasEvent(c.event.CONTACT)&&-1!==this.contactObjects.indexOf(a)&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),d.hasEvent(c.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(a)&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),
1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&c++;this.active_count=c},triggerEvents:function(){var a,b,d,e,g=this.dynamicsWorld;if(this.contactObjects.length){var h=g.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var l=g.getDispatcher().getManifoldByIndexInternal(a),m=Ammo.wrapPointer(l.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||
null,n=Ammo.wrapPointer(l.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||null;if(m&&(e=m.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.self=m,d.other=n,d.contacts?d.contacts.setManifold(l):d.contacts=new f(l);else if(n&&n.isStatic()&&(e=n.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.other=m,d.self=n,d.contacts?d.contacts.setManifold(l):d.contacts=new f(l)}}g=this.collisionObjects.length;
for(a=0;a<g;a++)if(m=this.collisionObjects[a],(e=m.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.COLLIDE))if(d=b.getProperties(c.event.COLLIDE),l=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],l&&l.length){h=[];m=m.getBody();a=0;for(iMax=l.length;a<iMax;a++){var n=l[a],o=n.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(m,o));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(m,o));d.alg[a].processCollision(m,o,this.dynamicsWorld.getDispatchInfo(),d.mf[a]);0<
d.mf[a].getPersistentManifold().getNumContacts()&&(h.push(n),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(h.length&&(d=b.triggerEvent(c.event.COLLIDE)))d.collisions=h}g=this.ghostObjects.length;for(a=0;a<g;a++)if(d=this.ghostObjects[a],e=d.getSceneObject())if((b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT_GHOST))if(e=d.getBody(),h=e.getNumOverlappingObjects()){d=b.triggerEvent(c.event.CONTACT_GHOST);d.contacts=d.contacts||[];d.contacts.length>h&&(d.contacts.length=
h);for(b=0;b<h;b++)l=Ammo.btRigidBody.prototype.upcast(e.getOverlappingObject(b)),d.contacts[b]=l._cvr_rigidbody||null}},reset:function(){for(var a=0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,c,e){var f,a=o(a);f=o(b);c=c||!1;e=e||!1;b=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!c||body.isKinematicObject()&&
!e))){c=body;e=b.get_m_hitPointWorld();a=c.getCenterOfMassTransform().inverse().op_mul(e);if(f=c._cvr_rigidbody)return Ammo.destroy(b),{position:d(e),localPosition:d(a),rigidBody:f,ammoBody:c};Ammo.destroy(b);return{position:d(e),localPosition:d(a),rigidBody:null,ammoBody:c}}Ammo.destroy(b)}};return{ScenePhysics:x,Constraint:E,RigidProperties:function(a){this.type=h.parseEnum(c.physics.body,a.type);this.mass=a.mass!==e?a.mass:this.type?1:0;this.size=a.size||[1,1,1];this.restitution=a.restitution||
(this.type?0:1);this.friction=a.friction||1;if((this.collision=a.collision)&&!this.collision.getShapes)this.collision=new h.CollisionMap(this.collision);this.blocker=a.blocker||!1},RigidBody:u,vec3bt_copy:v,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:r,btquat_copy:m}});
CubicVR.RegisterModule("CollisionMap",function(h){var v=h.enums;v.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var r=function(h){this.shapes=[];this.result=null;if(h){h&&!h.length&&(h=[h]);for(var o=0,q=h.length;o<q;o++)this.addShape(h[o])}};r.prototype={addShape:function(m){m.type=h.parseEnum(v.collision.shape,m.type);m.position=m.position||[0,0,0];m.rotation=m.rotation||[0,0,0];m.size=m.size||[1,1,1];m.radius=m.radius||1;m.height=m.height||1;
m.margin=m.margin||0;m.mesh=m.mesh||null;this.shapes.push(m)},getShapes:function(){return this.shapes},setResult:function(h){this.result=h},getResult:function(){return this.result}};return{CollisionMap:r}});
CubicVR.RegisterModule("RigidVehicle",function(h){var v=h.undef,r=h.enums,m,o,q=function(d){var d=h.get(d)||{},e=d.mesh,c=d.collision;this.maxEngineForce=d.maxEngineForce||2E3;this.maxBreakingForce=d.maxBreakingForce||125;this.steeringClamp=d.steeringClamp||0.51;this.mass=d.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=e;this.bodyCollision=new h.CollisionMap(c);this.sceneObject=new h.SceneObject(this.bodyMesh);if(!m||!o)new Ammo.btVector3,new Ammo.btVector3,m=new Ammo.btTransform,o=new h.Quaternion,new Ammo.btQuaternion;if(d.wheels!=v){e=0;for(c=d.wheels.length;e<c;e++){var n=d.wheels[e];n instanceof h.VehicleWheel?this.addWheel(n):this.addWheel(new h.VehicleWheel(n))}}};q.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(d){this.body=
new h.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});h.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);h.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(d.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(r.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var e=new Ammo.btVector3,c=0;c<this.wheels.length;c++)h.vec3bt_copy(this.wheels[c].getWheelPosition(),e),this.m_vehicle.addWheel(e,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[c].getSuspensionRest(),this.wheels[c].getWheelRadius(),this.m_tuning,this.wheels[c].getSteering());d.dynamicsWorld.addVehicle(this.m_vehicle);d.bind(this.body);this.updateSuspension()},evaluate:function(){for(var d=this.m_vehicle.getNumWheels(),
e=0;e<d;e++){this.wheels[e].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,e);this.wheels[e].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,e);this.wheels[e].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,e);this.m_vehicle.updateWheelTransform(e,!0);var c=this.m_vehicle.getWheelTransformWS(e),h=c.getOrigin();this.wheels[e].wheelObj.position[0]=h.x();this.wheels[e].wheelObj.position[1]=h.y();this.wheels[e].wheelObj.position[2]=h.z();c=c.getRotation();o.x=
c.x();o.y=c.y();o.z=c.z();o.w=c.w();c=o.toEuler();this.wheels[e].wheelObj.rotation[0]=c[0];this.wheels[e].wheelObj.rotation[1]=c[1];this.wheels[e].wheelObj.rotation[2]=c[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(d){if(this.body&&(this.body.isActive()||d))return this.body.getBody().getMotionState().getWorldTransform(m),d=m.getOrigin(),d.x!=d.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
d.x(),this.sceneObject.position[1]=d.y(),this.sceneObject.position[2]=d.z()),d=m.getRotation(),o.x=d.x(),o.y=d.y(),o.z=d.z(),o.w=d.w(),o.x!=o.x?console.log("rotation is NaN"):(d=o.toEuler(),this.sceneObject.rotation[0]=d[0],this.sceneObject.rotation[1]=d[1],this.sceneObject.rotation[2]=d[2]),!0},setEngineForce:function(d){this.gEngineForce=d;this.gEngineForce>this.maxEngineForce&&(this.gEngineForce=this.maxEngineForce);this.gEngineForce<-this.maxEngineForce&&(this.gEngineForce=-this.maxEngineForce)},
getEngineForce:function(){return this.gEngineForce},incEngine:function(d){this.setEngineForce(this.getEngineForce()+d)},decEngine:function(d){this.setEngineForce(this.getEngineForce()-d)},setSteering:function(d){this.gVehicleSteering=d},getSteering:function(){return this.gVehicleSteering},incSteering:function(d){this.gVehicleSteering+=d;this.gVehicleSteering>this.steeringClamp&&(this.gVehicleSteering=this.steeringClamp);this.gVehicleSteering<-this.steeringClamp&&(this.gVehicleSteering=-this.steeringClamp)},
setBrake:function(d){this.gBreakingForce=d},getWheelGroundPosition:function(d){return this.wheels[d].wheelObj.getWorldPosition()-[0,wheels[d].getWheelRadius(),0]},getWheelSkid:function(d){return this.m_vehicle.getWheelInfo(d).get_m_skidInfo()},getRigidGround:function(d){this.m_vehicle.getWheelInfo(d)},addWheel:function(d,e){e===v&&(e=this.wheels.length);this.wheels[e]=d},getWheel:function(d){return this.wheels[d]},bindToScene:function(d){for(var e=this.wheels.length,c=0;c<e;c++)d.bind(this.getWheelObj(c));
d.bind(this.getSceneObject())},getWheelObj:function(d){return this.getWheel(d).wheelObj},updateSuspension:function(){var d,e=this.m_vehicle.getNumWheels();for(d=0;d<e;d++){var c=this.m_vehicle.getWheelInfo(d);c.set_m_suspensionStiffness(this.wheels[d].getSuspensionStiffness());c.set_m_suspensionRestLength1(this.wheels[d].getSuspensionRest());c.set_m_wheelsDampingRelaxation(this.wheels[d].getDampingRelaxation());c.set_m_wheelsDampingCompression(this.wheels[d].getDampingCompression());c.set_m_frictionSlip(this.wheels[d].getFrictionSlip());
c.set_m_rollInfluence(this.wheels[d].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(d=0;d<e;d++)this.m_vehicle.updateWheelTransform(d,!0)}},getMass:function(){return this.mass},setMass:function(d){this.mass=d;this.body&&this.body.setMass(this.mass)}};var d=function(d){d=h.get(d)||{};this.wheelRef=new h.SceneObject;this.wheelObj=new h.SceneObject;this.wheelRef.scale=d.scale||[1,1,1];this.wheelRadius=d.radius||0;this.wheelWidth=d.width||0;d.mesh!=v&&this.setModel(d.mesh);
this.suspensionStiffness=d.suspensionStiffness||40;this.suspensionRest=d.suspensionRest||0.05;this.dampingRelaxation=d.dampingRelaxation||2.3;this.dampingCompression=d.dampingCompression||2.4;this.frictionSlip=d.frictionSlip||0.94;this.rollInfluence=d.rollInfluence||0.5;this.wheelPosition=d.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=d.steering||!1;this.braking=d.braking||!1;this.driving=d.driving||!1};d.prototype={setModel:function(d,e,c){this.wheelModel=d;this.wheelRadius=e||0;this.wheelWidth=
c||0;0===this.wheelRadius&&(this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2);0===this.wheelWidth&&(this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0]);this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(d){this.suspensionStiffness=d},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(d){this.suspensionRest=
d},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(d){this.dampingRelaxation=d},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(d){this.dampingCompression=d},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(d){this.frictionSlip=d},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(d){this.rollInfluence=d},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(d){this.wheelRadius=d},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(d){this.wheelWidth=d},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(d){this.wheelRotation=d;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(d){this.wheelPosition=d;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(d){this.steering=
d},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(d){this.driving=d},isDriving:function(){return this.driving}};return{Vehicle:q,VehicleWheel:d}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\n#if POINT_SIZE||POINT_SPRITE\nuniform float pointSize;\n#endif\n#if POINT_SIZE && !POINT_SPRITE && POINT_CIRCLE\nvarying float ptSize;\n#if POINT_CIRCLE\nvarying vec2 sPos;\nuniform vec3 viewPort;\n#endif\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\n#if POINT_SIZE||POINT_SPRITE\nfloat d = length(vertexPositionOut);\ngl_PointSize = pointSize * sqrt( 1.0/(1.0 + d*d) );\n#if !POINT_SPRITE && POINT_CIRCLE\nptSize = gl_PointSize;\nvec4 screenPos = vec4(matrixProjection * vertexPositionOut);\nsPos = (screenPos.xy/screenPos.w)*vec2(viewPort.x/2.0,viewPort.y/2.0)+vec2(viewPort.x/2.0+0.5,viewPort.y/2.0+0.5);\n#endif\n#endif\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if POINT_SIZE && !POINT_SPRITE && POINT_CIRCLE\nvarying float ptSize;\nvarying vec2 sPos;\n#endif\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if POINT_SPRITE\nreturn gl_PointCoord;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if POINT_SIZE && !POINT_SPRITE && POINT_CIRCLE\nif (length(sPos-(gl_FragCoord.xy)) > ptSize/2.0) {\ndiscard;\n}\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\ncolor.a *= materialAlpha;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nif (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nif (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nif (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nif (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nif (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nif (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nif (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nif (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nif (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nif (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nif (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nif (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nif (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nif (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
