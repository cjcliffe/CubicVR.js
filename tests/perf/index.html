<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>

    <head>
        <title>
            CubicVR.js Performance Test Runner
        </title>
        <script src="../../CubicVR.js" type="text/javascript"></script>
    </head>

    <body>
        <h1>CubicVR.js Performance Test Runner</h1>
        <p>To start the tests click Start.  Each test is run in order (downloaded from the server).  Tests are run for based on the given number of iterations (specified below), and the time is recorded.</p>

        <h3>Settings</h3>
        <div>Run basic  Tests: &nbsp;
            Frames Per Test: <input type="text" size="4" id="iterations" onchange="updateIterations();"/>&nbsp;
            <input onclick="webGLStart();" type="button" value="Start"/><span id="testCount"></span></div>

        <h3>Results</h3>
        <div id="results" style="margin: 5px; padding-top: 10px;"></div>
        <div id="total"></div>
        <div style='font-family:Arial;font-size:14px;font-weight:bold'>Time Taken: <span id='timeTaken'>...</span></div>
        <div style='font-family:Arial;font-size:14px;font-weight:bold'>FPS: <span id='fpsText'>...</span></div>
        <p id='frames'>Number of Frames drawn.</p>
        <p id='FilePull'>FilePull.</p>

        <script type='text/javascript'>
            var timerMilliseconds;
            var timerSeconds = 0;
            var timerLastSeconds = 0;
            var frameCounter = 0;
            var frames = 0;
            var camera;
            var scene;
            var drawScene;
            var frames = 0;
            var results = document.getElementById('results');
            var gl;
            var canvas;
            var xp = 0;
            //var boxMesh;
            var total = document.getElementById('total');
            total.innerHTML = '';

            // Frame Value after the loop stops
            var iterationCount = 100;
            document.getElementById('iterations').value = iterationCount;

            function updateIterations() {
                var newIterationCount = document.getElementById('iterations').value;
                if (newIterationCount) {
                    iterationCount = parseInt(newIterationCount, 10);
                }
            }

            function download(file) {
                var req = new XMLHttpRequest();
                req.open('GET', file, false);
                if (req.overrideMimeType) {
                    req.overrideMimeType('text/javascript');
                }
                req.send(null);
                if (req.status != 200 && req.status !=0) {
                    return null;
                } else {
                    return req.responseText;
                }
            }

            function getTest(testName) {
                var responseText = download(testName);

                if (!responseText) {
                    return null;
                }
                return responseText;
            }

            function webGLStart() {
                // Build a canvas and append to the 'results' tag
                var buildCanvas = function(id, w, h) {
                    var c = document.createElement('canvas');
                    c.id = id;
                    c.width = w;
                    c.height = h;
                    c.className = "test";
                    return c;
                };
                canvas = buildCanvas('myCanvas',400,400);
                results.appendChild(canvas);
                //gl = CubicVR.init(canvas);
                gl = CubicVR.GLCore.init(canvas, "../../CubicVR_Core.vs", "../../CubicVR_Core.fs");

                if (!gl) {
                    alert("Sorry, no WebGL support.");
                    return;
                };

                // New scene with our canvas dimensions and default camera with FOV 80
                scene = new CubicVR.Scene(canvas.width, canvas.height, 80);

                var test = getTest("basic_cube.js");
                document.getElementById('FilePull').innerHTML = test;
                window.eval(test);

                // set initial camera position and target
                scene.camera.position = [1, 1, 1];
                scene.camera.target = [0, 0, 0];

                // initialize a mouse view controller
                mvc = new CubicVR.MouseViewController(canvas, scene.camera);
                
                var interval;
                document.getElementById('fpsText').innerHTML="before mainloop";
                // finishes when time-stepped 30fps reaches a virtual 20 seconds (600/30 = 20)
                var ml = new CubicVR.MainLoop(function(timer,gl) { 
                    // ...
                    scene.render();
                    if (timer.getNumUpdates()===600) {
                        clearInterval(interval);
                        //document.getElementById('frames').innerHTML = timer.getNumUpdates();
                        //document.getElementById('timeTaken').innerHTML = timer.getMilliseconds();
                        finished(timer);
                    }
                }, true, true); // true 3rd param prevents mainloop from starting..

                document.getElementById('timeTaken').innerHTML = "Calling ml";
                // step at 30fps exactly
                ml.timer.lockFramerate(30);
                //document.getElementById('FilePull').innerHTML = "After Mainloop";
                // run at 60fps max
                interval = setInterval(function() { ml.runOnce(); },1000/60);

                function finished(timer) {
                    // do stuff here..
                    document.getElementById('frames').innerHTML = timer.getNumUpdates();
                    document.getElementById('FilePull').innerHTML = timer.getTotalMilliseconds();
                }
                
                

                /*var first_draw = true;
                // Start our main drawing loop, it provides a timer and the gl context as parameters
                CubicVR.MainLoop(function(timer, gl) {
                    //scene.evaluate(timer.lockFramerate(50));
                    
                    if (first_draw) { timer.reset(); timer.lockFramerate(30); first_draw = false; return; }
                    //scene.lockFramerate(30);
                    
                    scene.render();
                    
                    document.getElementById('frames').innerHTML = frames;
                    ++frames;
                    // Stop the MainLoop after it reaches a given value.
                    if (timer.getNumUpdates() === iterationCount) {
                        document.getElementById('timeTaken').innerHTML = timer.getTotalMilliseconds() + "ms";
                        document.getElementById('FilePull').innerHTML = timer.getSeconds();
                        CubicVR.setMainLoop(null);
                        //window.eval(test);
                        return;
                    }
                    document.getElementById('fpsText').innerHTML=timer.getNumUpdates();
                    
                    document.getElementById('FilePull').innerHTML = timer.getLastUpdateSeconds();
                    
                    if (!timerMilliseconds)
                    {
                        timerMilliseconds = (new Date()).getTime();
                        return;
                    }

                    frameCounter++;

                    var newTimerMilliseconds = (new Date()).getTime();

                    timerLastSeconds = (newTimerMilliseconds-timerMilliseconds)/1000.0;

                    if (timerLastSeconds > (1/10)) timerLastSeconds = (1/10);

                    timerSeconds += timerLastSeconds;
                    timerMilliseconds = newTimerMilliseconds;

                    if (frameCounter%30==0)
                    {
                        fpsStr = ""+frameCounter/timerSeconds;
                        document.getElementById('fpsText').innerHTML=fpsStr.substring(0,6);
                        frameCounter=0;
                        timerSeconds=0;
                    }
                });*/
            }

        </script>
    </body>
</html>
