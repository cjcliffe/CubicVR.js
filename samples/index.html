<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>CubicVR.js Sandbox</title>
    <script type="text/javascript" src="../lib/codemirror/codemirror.js"></script>
    <script type="text/javascript" src="../lib/codemirror/mode_xml.js"></script>
    <script type="text/javascript" src="../lib/codemirror/mode_javascript.js"></script>
    <script type="text/javascript" src="../lib/codemirror/mode_css.js"></script>
    <script type="text/javascript" src="../lib/codemirror/mode_htmlmixed.js"></script>
    <script type="text/javascript" src="../lib/codemirror/util_formatting.js"></script>
    <link rel="stylesheet" href="../lib/codemirror/codemirror.css">
    <link rel="stylesheet" href="../lib/codemirror/docs_docs.css">
    <link rel="stylesheet" href="index.css">

    <script type='text/html' id="inputFormGenerator">
  <% if (template.title) { %>
      <div class="dataFormTitle"><%=template.title%><a href="javascript:closeSnippet()">&times;</a></div>
  <% } %>
  <%  var generator = template.generator;
      var dataform = template.form;
      for (var elemName in dataform) {
        if (!dataform.hasOwnProperty(elemName)) continue;
        var dataElem = dataform[elemName];
        var elValue = dataElem.value||"";
        var elRequired = dataElem.required||false;      
        %>
        <div class="dataFormRow">
        <% if (dataElem.description) { %>
          <div class="dataLabel" /><label for="<%=elemName%>"><%=dataElem.description%></label></div>
        <% } %>
        
        <div class="dataInput"><%
        switch (dataElem.type) {
          case "text": %>
            <input type="text" name="<%=elemName%>" value="<%=elValue%>" />
          <% break; 
          case "float": %>
            <input type="text" name="<%=elemName%>" value="<%=elValue%>" size="10" />
          <% break;
        } 
                
        if (elRequired) { %>
          <span class="required">*</span>
        <% } %>
      </div></div>
      <% } %>
      <div style="clear:both" class="dataSubmit"><input type="button" id="dataSubmitButton" class="dataSubmit" value="Create" /></div>
    </script>
    <script type='text/javascript'>
    var templates = [];
    
    function collectTextNode(tn) {
      if (!tn) {
        return "";
      }

      var s = "";
      var textNodeChildren = tn.childNodes;
      for (var i = 0, tnl = textNodeChildren.length; i < tnl; i++) {
        s += textNodeChildren[i].nodeValue;
      }
      return s;
    }
    
    
    function loadSnippets() {
      srcUrl = "index.xml";
      try {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open('GET', srcUrl, false);
        xmlHttp.overrideMimeType("application/xml");
        xmlHttp.send(null);

        if (xmlHttp.status === 200 || xmlHttp.status === 0) {
          var xml = xmlHttp.responseXML;
          
          var snippets = xml.getElementsByTagName("snippet");
          var elSnippets = document.getElementById("snippets");
          elSnippets.options[elSnippets.options.length] = new Option("Code Snippets","");
          
          for (var i = 0; i < snippets.length; i++) {
            var snippet = snippets[i];
            var snippetName = snippet.getAttribute("name");
            
            var template = collectTextNode(snippet.getElementsByTagName("template")[0]);
            var form = collectTextNode(snippet.getElementsByTagName("form")[0]);
            var jsform = eval("("+form+")");
            var jstemplate = {
              generator:template,
              title: snippetName,
              form:jsform              
            };
            templates[i] = jstemplate;
            elSnippets.options[elSnippets.options.length] = new Option(snippetName,i);
            elSnippets.addEventListener("change",function(i) { return function(ev) {
              if (this.selectedIndex===0) {
                return;
              }
              if (document.getElementById("dataForm")) {
                document.body.removeChild(document.getElementById("dataForm"));
              }

              buildInputForm(templates[i]);
              this.selectedIndex = 0;
            } }(i));            
          }
        }
      }
      catch(e) {
        try {
          alert(srcUrl + " failed to load.\n"+e);
        }
        catch (ex) {
          throw(e);
        }
      }

      return null;
    }
    
    
    function getSelectedRange() {
      return { from: editor.getCursor(true), to: editor.getCursor(false) };
    }

    function autoFormatSelection() {
      var range = getSelectedRange();
      // editor.autoFormatRange(range.from, range.to);
        editor.autoIndentRange(range.from, range.to);
    }
    
    function closeSnippet() {
      if (document.getElementById("dataForm")) {
        document.body.removeChild(document.getElementById("dataForm"));
      }
    }
    
    function runDataForm(df,template) {
      var data = df.getElementsByTagName("input");
      var dataResult = {};
      
      if (data.length) for (var i = 0; i < data.length; i++) {
        if (data[i].type && data[i].type == "button") {
          continue;
        }
        // console.log(data[i].name,data[i].value);
        dataResult[data[i].name] = data[i].value;
      }

      data = df.getElementsByTagName("select");
      
      if (data.length) for (var i = 0; i < data.length; i++) {
        // console.log(data[i].name,data[i].options[data[i].selectedIndex].text,data[i].options[data[i].selectedIndex].value);
        dataResult[data[i].name] = data[i].options[data[i].selectedIndex].value;
      }
      
      // console.log(dataResult);
      
      editor.replaceSelection(tmpl(template.generator,dataResult));      
      document.body.removeChild(df);
      autoFormatSelection();      
    }
    
    function buildInputForm(template) {
      var formDiv = document.createElement("DIV");
      formDiv.className = "dataForm";
      formDiv.id = "dataForm";
      formDiv.innerHTML = tmplHTML("inputFormGenerator",{template:template});
      document.body.appendChild(formDiv);
      document.getElementById("dataSubmitButton").addEventListener("click",
        function(ev) {
          runDataForm(formDiv,template);
        }
      );      
    }
    </script>
    <script type='text/javascript'>
        var style;
        var editor;
        var activeTool = "tabSplitMode";
        var bhref = "";
        var pauseViewState = false;
        
        function setSize(tool) {
            var el_preview = document.getElementById("preview");

            var newHeight = window.innerHeight-46;
            var newWidth = window.innerWidth;
            
            if (tool) {
              document.getElementById(activeTool).className = "tool";
              activeTool = tool;
              document.getElementById(activeTool).className = "tool activeTool";
            }
            
            switch (activeTool) {
              case "tabSplitMode":
                el_preview.style.display = "none";
                editor.setSize(0,0);
                editor.setSize(Math.floor(newWidth/2),newHeight);
                el_preview.style.display = "";
                el_preview.style.height = newHeight+"px";
                el_preview.style.width = (newWidth/2)+"px";
                if (pauseViewState)
                  updatePreview();
                pauseViewState = false;
              break;
              case "tabPreviewMode":
                el_preview.style.display = "";
                el_preview.style.height = newHeight+"px";
                el_preview.style.width = newWidth+"px";
                editor.setSize(0,0);
                if (pauseViewState)
                  updatePreview();
                pauseViewState = false;
              break;
              case "tabCodeMode":
                el_preview.style.display = "none";
                editor.setSize(newWidth,newHeight);
                pauseViewState = true;
              break;
            }
        }
        
        var backupProj;
        var initProj;
        function loadProject(el) {
          if (el.value) {
            if (!backupProj) {
              backupProj = editor.getValue();
            } 
            var arFile = el.value.split("/");
            bhref = "./"+arFile[1]+"/";

            var r = new XMLHttpRequest(); 
            r.open("GET", el.value, true); 
            r.onreadystatechange = function () { 
              if (r.readyState != 4 || (r.status != 200 && r.status != 0)) return; 
             editor.setValue(r.responseText);
            };
            r.send();
          } else {
            if (backupProj) {
              editor.setValue(backupProj);
              backupProj = "";
            }
            bhref = "";
          }
        }
        
        
        // Simple JavaScript Templating
        // John Resig - http://ejohn.org/ - MIT Licensed
        (function(){
          var cache = {};

          this.tmplHTML = function tmplHTML(str, data){
            // Figure out if we're getting a template, or if we need to
            // load the template - and be sure to cache the result.
            var fn = !/\W/.test(str) ?
              cache[str] = cache[str] ||
                tmplHTML(document.getElementById(str).innerHTML) :

              // Generate a reusable function that will serve as a template
              // generator (and which will be cached).
              new Function("obj",
                "var p=[],print=function(){p.push.apply(p,arguments);};" +

                // Introduce the data as local variables using with(){}
                "with(obj){p.push('" +

                // Convert the template into pure JavaScript
                str
                  .replace(/[\r\t\n]/g, " ")
                  .split("<%").join("\t")
                  .replace(/((^|%>)[^\t]*)'/g, "$1\r")
                  .replace(/\t=(.*?)%>/g, "',$1,'")
                  .split("\t").join("');")
                  .split("%>").join("p.push('")
                  .split("\r").join("\\'")
              + "');}return p.join('');");

            // Provide some basic currying to the user
            return data ? fn( data ) : fn;
          };
        })();

        
         // Simple JavaScript Templating
        // John Resig - http://ejohn.org/ - MIT Licensed
        (function(){
          var cache = {};
         
          this.tmpl = function tmpl(str, data){
            // Figure out if we're getting a template, or if we need to
            // load the template - and be sure to cache the result.
            var fn = !/\W/.test(str) ?
              cache[str] = cache[str] ||
                tmpl(document.getElementById(str).innerHTML) :
             
              // Generate a reusable function that will serve as a template
              // generator (and which will be cached).
              new Function("obj",
                "var p=[],print=function(){p.push.apply(p,arguments);};" +
               
                // Introduce the data as local variables using with(){}
                "with(obj){p.push('" +
               
                // Convert the template into pure JavaScript
                str
                  .replace(/[\r\t]/g, " ")
                  .replace(/[\n]+/g, "/-LF-/")
                  .split("<%").join("\t")
                  .replace(/((^|%>)[^\t]*)'/g, "$1\r")
                  .replace(/\t=(.*?)%>/g, "',$1,'")
                  .split("\t").join("');")
                  .split("%>").join("p.push('")
                  .split("\r").join("\\'")                 
              + "');}return p.join('').replace(/\\/-LF-\\//g,'\\n').replace(/^\\s*\\n/gm,'').replace(/^\\s\\s*/, '').replace(/\\s\\s*$/, '');");
           
            // Provide some basic currying to the user
            return (data ? fn( data ) : fn);
          };
        })();
        
        function initialize() {
          loadSnippets();
        }
        
    </script>
  </head>
  <body onresize="setSize()" onload="initialize()">
    <div id="logo">&nbsp;</div>
    <div id="tools">
      <div id="tabPreviewMode" onclick="setSize(this.id)" class="tool">Preview</div>
      <div id="tabCodeMode" onclick="setSize(this.id)" class="tool">Code</div>
      <div id="tabSplitMode" onclick="setSize(this.id)" class="activeTool">Split</div>
      <span >
    </div>
    <div id="editorTools">
      <div type='button' class='toolButton' title='indent selection' onclick="autoFormatSelection()">&#8677; Indent</div>
      <div type='button' class='toolButton' id='runButton' onclick='doRun()' style="display:none;color:darkgrey;">&#9654; Paused</div>
      <div type='button' class='toolButton' id='pauseButton' onclick='doPause()' style="display:;color:green;"><span style='font-size:10px;position:relative;top:-1px;left:2px'>&#9613;&#9613;</span> Running</div>
      <div type='button' class='toolButton' id='autoButton' onclick='doManual()' style="color:darkgrey">&harr; Manual</div>
      <div type='button' class='toolButton' id='manualButton' onclick='doAuto()' style="display:none;color:green;">&harr; Manual</div>
      <div type='button' class='toolButton' id='manualRunButton' onclick='doManualRun()' style="display:none;color:green;">&#9654; Run</div>
      
      &nbsp;&nbsp;&nbsp;
      <select id="projSelector" onchange="loadProject(this)"></select>
      <select id="snippets"></select>
    </div>
    <div id="workArea">
    <textarea id="code" name="code">
<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>CubicVR.js Demo</title>
    <script type='text/javascript' src="../CubicVR.js"></script>
    <script type='text/javascript'>

      function webGLStart(gl,canvas) {

        // Add a sphere to mesh, size 1.0, apply material and UV parameters
        var sphereMesh = new CubicVR.Mesh({
          primitive: {
            type: "sphere",
            size: 1.0,
            lat: 64,
            lon: 64,
            material: {
              textures: {
                color: "images/6583-diffuse.jpg",
                bump: "images/6583-bump.jpg",
                normal: "images/6583-normal.jpg"
              },
              specular: [0.5,0.5,0.5],
              diffuse: [0.7,0.7,0.7],
              shininess: 0.3
            },
            uv: {
              projectionMode: "spherical",
              scale: [2, 2, 2],
              projectionAxis: "y",
              wrapW: 5,
              wrapH: 5
            }
          },
          compile: true
        });

        // New scene with our canvas dimensions and default camera with FOV 80
        var scene = new CubicVR.Scene({
          camera: {
            width: canvas.width, 
            height: canvas.height, 
            fov: 65,
            position: [1, 1, 1],
            target: [0, 0, 0]            
          },
          lights: [{
            type: "directional",
            specular: [1, 1, 1],
            direction: [0.8, -3, -2.6]
          }],
          sceneObjects: [{
            name: "box",
            mesh: sphereMesh
          }]          
        });

        // initialize a mouse view controller
        mvc = new CubicVR.MouseViewController(canvas, scene.camera);

        // Add our scene to the window resize list
        CubicVR.addResizeable(scene);

        // Start our main drawing loop, it provides a timer and the gl context as parameters
        CubicVR.MainLoop(function(timer, gl) {
          scene.render();
        });
      }

    </script>
  </head>
  <body onLoad="CubicVR.start('auto',webGLStart);"></body>
</html></textarea>
    <iframe id=preview></iframe>
    </div>
    <script>
      var delay;
      var pauseState = false;
      var previewWaiting = false;
      var autoState = true;
      
      // Initialize CodeMirror editor with a nice html5 canvas demo.
      editor = CodeMirror.fromTextArea(document.getElementById('code'), {
        mode: 'text/html',
        tabMode: 'indent',
        onChange: function() {
          if (!backupProj && !window.onbeforeunload) {                
              window.onbeforeunload = function()
              {
                return "You will lose changes in your project, continue?";
              }
          }

          clearTimeout(delay);
          if (!pauseState && !pauseViewState && autoState) {
            delay = setTimeout(updatePreview, 3000);
            previewWaiting = false;
          } else {
            previewWaiting = true;
          }
        }
      });
      
      function updatePreview() {
        var previewFrame = document.getElementById('preview');
        var preview =  previewFrame.contentDocument ||  previewFrame.contentWindow.document;
        preview.open();
        if (!initProj) {
          initProj = editor.getValue();
        }
        preview.write((bhref?("<base href='"+bhref+"' />"):"")+editor.getValue());
        preview.close();        
      }
      setTimeout(updatePreview, 300);
      setSize();
      
      function doAuto() {
        autoState = true;
        document.getElementById("autoButton").style.display="";
        document.getElementById("manualButton").style.display="none";
        document.getElementById("manualRunButton").style.display="none";
      }
      
      function doManual() {
        autoState = false;
        document.getElementById("manualButton").style.display="";
        document.getElementById("autoButton").style.display="none";
        document.getElementById("manualRunButton").style.display="";
      }
      
      function doManualRun() {
        updatePreview();
      }
      
      function doPause() {
        pauseState = true;
        document.getElementById("pauseButton").style.display="none";
        document.getElementById("runButton").style.display="";
      }
      
      function doRun() {
        pauseState = false;
        document.getElementById("pauseButton").style.display="";
        document.getElementById("runButton").style.display="none";
        updatePreview();
    }
    
      function tickHandler() {
        var preview = document.getElementById('preview');
        var icvr = preview.contentWindow.CubicVR;

        if (!icvr) return;        
        if (!icvr.GLCore) return;        

        if (icvr.GLCore.mainloop) {
          icvr.GLCore.mainloop_tmp = icvr.GLCore.mainloop;
        } 
        
        if (icvr.GLCore.mainloop_tmp && icvr.GLCore.mainloop && (pauseState || pauseViewState) ) {
          icvr.GLCore.mainloop = null;
        } 
      }
            
      setInterval(tickHandler, 1000);
    </script>
    <!-- find . | grep .html -->
    <script type="text" id="sampleFiles">
        ./basic/basic_primitives.html
        ./basic/cube.html
        ./basic/cube_multimaterial.html
        ./basic/cube_scene.html
        ./basic/cube_viewcontrol.html
        ./basic/landscape.html
        ./basic/lathe_torus.html
        ./basic/materials.html
        ./basic/material_instances.html
        ./basic/material_uvoffset.html
        ./basic/sphere_map.html
        ./camera/multi_camera.html
        ./camera/renderscenetexture.html
        ./collada/collada_duck.html
        ./collada/sketchup.html
        ./collada/wall_smash.html
        ./collada/wall_smash_cam_attach.html
        ./collada/wall_smash_stringload.html
        ./custom_shader/basic_test.html
        ./custom_shader/noise.html
        ./definitions/definitions.html
        ./definitions/definitions_scene.html
        ./definitions/definitions_scene_xml.html
        ./definitions/definitions_xml.html
        ./events/event_tick.html
        ./fps_demo/level1.html
        ./gml/GMLDraw2D.html
        ./gml/GMLDraw3D.html
        ./gpu_fluid/wavepool_blockers.html
        ./instancing/index.html
        ./layout/layout_test.html
        ./material regen/Material Test.html
        ./mesh_build/cube_arrays.html
        ./motion/cube_animate.html
        ./moz_joystick/fps_control_test.html
        ./pdf/pdf_gallery.html
        ./physics/physics_compound.html
        ./physics/physics_grapple_event.html
        ./physics/physics_heightfield.html
        ./physics/physics_mesh.html
        ./physics/physics_mesh_static.html
        ./physics/physics_multishape.html
        ./physics/physics_pickable.html
        ./physics/physics_stress.html
        ./physics/physics_test.html
        ./physics/physics_vehicle.html
        ./physics/physics_vehicle_heightfield.html
        ./physics/physics_vehicle_truck_heightfield.html
        ./physics/physics_zerog.html
        ./physics/physics_zerog_tether.html
        ./pickables/pickables.html
        ./pickables/pickables2.html
        ./pickables/project_unproject.html
        ./pointMode/pointMode.html
        ./pointMode/pointModeSubdivide.html
        ./point_sprite/ParticleEmitter.html
        ./point_sprite/ParticleWaterfall.html
        ./point_sprite/PointSprite.html
        ./polygon/tessellate.html
        ./shadows/alphamap_shadows.html
        ./shadows/alphamap_shadows_attach.html
        ./shadows/alphamap_shadows_projector.html
        ./shadows/arealight.html
        ./skybox/skybox.html
        ./subdivision/beveled_cube.html
        ./subdivision/catmull-clark.html
        ./subdivision/remove_internals.html
        ./subdivision/wall_smash.html
        ./text/text.html
        ./timer/MainLoop.html
        ./timer/TimerTest.html
        ./vbo_dynamic/wave_pool.html
        ./vbo_dynamic/wobbly_cube.html
        ./vbo_morph/vbo_morph.html
        ./vbo_morph/vbo_morph_offset.html
        ./vehicle/vehicle.html
        ./vehicle_physics_demo/stunt_track1.html
        ./video/video.html
        ./wireframe/wireframe_global.html
        ./wireframe/wireframe_local.html
        ./wireframe/wireframe_primitives.html</script>
    <script type='text/javascript'>
      function initSelect() {
          var elProj = document.getElementById("projSelector");
          var elFiles = document.getElementById("sampleFiles");
          
          var arFiles = elFiles.innerHTML.replace(/[ \t]*/g,"").split("\n");
          for (var i = 0; i < arFiles.length; i++) {
              elProj.options[elProj.options.length] = new Option(arFiles[i]?arFiles[i]:"CubicVR.js Live Project",arFiles[i]);
          }
      }
      initSelect();
    </script>
  </body>
</html>